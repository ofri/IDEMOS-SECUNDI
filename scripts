
scripts

fix users tokens
db.users.find().forEach(function(obj){
    if (obj.tokens > obj.num_of_extra_tokens+ 9)
    {   obj.tokens = obj.num_of_extra_tokens+ 9;
        db.users.save(obj);
    }
})

fix discussion conneced people
    var isUserInDiscussion = function(discussion_users, user_id) {

        for(var i=0; i<discussion_users.length; i++){
            if(discussion_users[i].user_id + '' == user_id + '')
                return true;
        };
        return false;
    };

    db.discussions.find().forEach(function(obj){
        print('checking ' + obj._id);
        db.grades.find({"discussion_id": obj._id}).forEach(function(grade_obj){
            var user = db.users.findOne({"_id": grade_obj.user_id});
            if(user && user._id && !isUserInDiscussion(obj.users, user._id)) {
                print('adding user to discussion ' + user.email);
                obj.users.push({ user_id : user._id, join_date: new Date()});
                db.discussions.save(obj);
            }
            else
               print('couldnt find user ' + grade_obj.user_id);
        });
    });