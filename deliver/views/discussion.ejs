<!DOCTYPE html>
<%
var error_message = error_message || '';
%>
<html>
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# <%= settings.facebook_app_name %>: http://ogp.me/ns/fb/<%= settings.facebook_app_name %>#">
    <meta property="fb:app_id" content="<%= settings.facebook_app_id %>" />
    <meta property="og:url" content="<%= settings.root_path %>/discussions/<%= discussion.id %>" />


    <% include partials/head.ejs %>
    <link href="/css/discussions.css" rel="stylesheet" />
</head>
<body>
<% include partials/body_top.ejs %>
<div id="wrap" class="discussions_page">

    <div id="header">
        <% include partials/menu.ejs %>
        <% include partials/user_box.ejs %>
        <% include partials/failures.ejs %>
        <% include partials/tag_search.ejs %>
    </div>
    <div >
    <div id="content_wrapper">
        <div id="content_main_wrapper">
            <div id="content_main_holder">
                <div id="content_right_holder">
                    <div class="segment main">
                        <h2 class="title topic"><%=discussion.subject_name%> <img src="/images/arrow_left.png" /></h2>
                        <h2 class="title">  <%=discussion.title%> </h2>
                        <div class="social_holder">
                            <a class="share_icon" href=""><img src="/images/icon_fb.png"></a>
                            <a class="share_icon" href=""><img src="/images/icon_tw.png"></a>
                            <a class="share_icon" href=""><img src="/images/icon_gp.png"></a>
                            <a class="share_icon" href=""><img src="/images/icon_email.png"></a>
                        </div>
                        <div class="author">הדיון נפתח ע"י: <a href="">אריק בנדו</a></div>
                        <hr />
                        <div class="img_holder">
                            <img src="/images/sample_img.png" />
                        </div>
                        <div>
                            <h3>אין הצדקה לכך שנשלם פעמיים. עמלות הבנקים בישראל מנופחות ולא הוגנות בכלל.</h3>
                            עמלות הן בעצם דרך של הבנקים לגרום לנו לשלם פעמיים. אם אנחנו משלמים ריביות על הכסף שהפקדנו בבנק, אז למה כמעט על כל פעולה שאנחנו מבצעים היום בבנק אנחנו צריכים לשלם גם עמלה? ר
                        </div>
                        <a class="read_more" href="">המשך קריאה</a>
                        <hr />
                        <div class="content_credits">
                            <div id="sponsors_holder">
                                <h2>שותפי תוכן</h2>
                                <div id="sponsors_logos">
                                    <div class="sponsors_logo logo_1"></div>
                                    <div class="sponsors_logo logo_2"></div>
                                    <div class="sponsors_logo logo_3"></div>
                                    <div class="sponsors_logo logo_4"></div>
                                    <div class="sponsors_logo logo_5"></div>
                                </div>
                            </div>
                        </div>
                        <hr />
                        <div class="tags">
                            <span class="tags_title">תגיות:</span>
                            <span class="tag"><a href="">הריכוזיות</a></span>
                            <span class="tag"><a href="">עמלות הבנקים</a></span>
                            <span class="tag"><a href="">יוקר המחיה</a></span>
                        </div>
                        <hr />
                        <div class="segment_bottom">
                            <!-- <div class="slide-box">
                                    <div class="summary">
                                        <input type="text" id="amount" value="6.15">
                                        <span> <div class="inlinediv" id="graders">90
                                        </div> דירוגים</span>
                                    </div>
                                    <div class="slider ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
                                    <div class="ui-slider-range ui-widget-header ui-slider-range-min" style="width: 0%;"></div><a class="ui-slider-handle ui-state-default ui-corner-all" href="#" style="left: 0%;"></a></div>
                                    <div class="slider-numbers">
                                        <span>1</span>
                                        <span>2</span>
                                        <span>3</span>
                                        <span>4</span>
                                        <span>5</span>
                                        <span>6</span>
                                        <span>7</span>
                                        <span>8</span>
                                        <span>9</span>
                                        <span>10</span>
                                    </div>
                                </div> -->
                            <div class="rating_box">
                                <div class="rating_total">
                                    8.74
                                </div>
                                <div class="raters">
                                    296 דירוגים
                                </div>
                            </div>
                            <div class="rating_holder">
                                <div class="rating_bar_holder">
                                    <div class="rating_bar" style="width:20%;"></div>
                                    <div class="rating_bar_indicator"><img src="/images/indicator_2.png" /></div>
                                    <div class="rating_marks">
                                        <span style="left:100%;">10</span>
                                        <span style="left:90%;">9</span>
                                        <span style="left:80%;">8</span>
                                        <span style="left:70%;">7</span>
                                        <span style="left:60%;">6</span>
                                        <span style="left:50%;">5</span>
                                        <span style="left:40%;">4</span>
                                        <span style="left:30%;">3</span>
                                        <span style="left:20%;">2</span>
                                        <span style="left:10%;">1</span>
                                        <span style="left:0%;"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="button_add_comment">
                                <input type="button" />
                            </div>
                            <div class="button_suggest_revisions">
                                <input type="button" />
                            </div>
                        </div>

                    </div>

                    <div class="segment">
                        <h2 class="title">סל מידע</h2>

                        <div class="text">
                            <img src="/images/placeholder_slider.png" />
                        </div>
                    </div>

                </div>
                <div id="content_left_sidebar">
                    <div class="segment quotes">
                        <h2>ציטוטים נוספים</h2>
                        <div id="quotes_sidebar_holder">
                            <div class="quotes_holder">
                                <div class="status odd"><span class="positive"></span>העלאת מס חברות ל- 35%. זה נזק מיידי למשק. זה צעד שיגרום לאבטלת המונים יגרום לנזק</div>
                                <div class="status even"><span class="negative"></span>העלאת מס חברות ל- 35%. זה נזק מיידי למשק. זה צעד שיגרום לאבטלת המונים יגרום לנזק</div>
                                <div class="status odd"><span class="missing"></span>העלאת מס חברות ל- 35%. זה נזק מיידי למשק. זה צעד שיגרום לאבטלת המונים יגרום לנזק</div>
                                <div class="status even"><span class="positive"></span>העלאת מס חברות ל- 35%. זה נזק מיידי למשק. זה צעד שיגרום לאבטלת המונים יגרום לנזק</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="content_break">
        <div class="content_break_content">
            <h2>            הצעות לשינוי<small id="suggestion_number"></small>
            </h2>
        </div>
    </div>

    <div id="content_wrapper_suggestions">
        <div id="suggestions_wrapper">

        </div>
        <div class="more-deals" data-executing="false">
            <a href="">עוד הצעות</a>
        </div>
    </div>



    <div class="content_break comments">
        <div class="content_break_content comments">
            <h2>תגובות (32)</h2>
            <div id="comments_filter">
                <input data-sort-by="-creation_date" class="button_order_chron" type="button" />
                <input data-sort-by="-popularity" class="button_order_popular" type="button" />
                <input data-sort-by="-total_votes" class="button_order_contro" type="button" />
            </div>
        </div>
    </div>

    <div id="content_wrapper_comments">
    <div id="comments_wrapper">
    <!--<div class="most_pop">
        <h2 class="title">התגובה הפופולרית ביותר</h2>
        <div class="comment_wrapper">
            <div class="comment_details">
                <div class="photo">
                    <img src="/images/icon_person.png" />
                </div>
                <div class="name">
                    אסף גרינברג
                </div>
                <div class="date_time">
                    <span class="time">14:46</span>
                    <span class="date">27.07.2012</span>
                </div>
                <div class="ratings">
                    <span class="friends">1458</span>
                    <span class="awards">3769</span>
                </div>
            </div>
            <div class="content">
                <div class="rating"><span>דירוג:</span><span class="good">458</span><span class="bad">2</span></div>
                הגיעה העת לבטל את אגרת הטלוויזיה. במקום לדחוף הצעות שאין להן סיכוי, מוצע כאן לבטל את גביית האגרה, להעביר חלק מן הנטל לתשלום שאנחנו משלמים ממילא בזמן חידוש רשיון הרכב, וכך לחסוך מיליונים רבים.
            </div>
        </div>
    </div>-->
    <div class="most_contr">
        <h2 class="title">התגובה השנויה במחלוקת</h2>
        <div class="comment_wrapper">
            <div class="comment_details">
                <div class="photo">
                    <img src="/images/icon_person.png" />
                </div>
                <div class="name">
                    אסף גרינברג
                </div>
                <div class="date_time">
                    <span class="time">14:46</span>
                    <span class="date">27.07.2012</span>
                </div>
                <div class="ratings">
                    <span class="friends">1458</span>
                    <span class="awards">3769</span>
                </div>
            </div>
            <div class="content">
                <div class="rating"><span>דירוג:</span><span class="good">458</span><span class="bad">2</span></div>
                הגיעה העת לבטל את אגרת הטלוויזיה. במקום לדחוף הצעות שאין להן סיכוי, מוצע כאן לבטל את גביית האגרה, להעביר חלק מן הנטל לתשלום שאנחנו משלמים ממילא בזמן חידוש רשיון הרכב, וכך לחסוך מיליונים רבים.
            </div>
        </div>
    </div>

    <div id="pagination_wrapper">
        <div id="pagination" class="pagination">
            <!--<span class="title">עמודים (24):</span>-->
            <!--<a href=""><span class="last"></span></a>-->
            <!--<a href=""><span class="next"></span></a>-->
            <!--<span class="page current">1</span>-->
            <!--<span class="page"><a href="">2</a></span>-->
            <!--<span class="page"><a href="">3</a></span>-->
            <!--<span class="page"><a href="">4</a></span>-->
            <!--<span class="page"><a href="">5</a></span>-->
            <!--<span class="page"><a href="">6</a></span>-->
            <!--<span class="page"><a href="">7</a></span>-->
            <!--<span class="page">...</span>-->
            <!--<a href=""><span class="prev"></span></a>-->
            <!--<a href=""><span class="first"></span></a>-->
        </div>
    </div>

    <div class="comment_wrapper odd">
        <div class="comment_details">
            <div class="photo">
                <img src="/images/icon_person.png" />
            </div>
            <div class="name">
                אסף גרינברג
            </div>
            <div class="date_time">
                <span class="time">14:46</span>
                <span class="date">27.07.2012</span>
            </div>
            <div class="ratings">
                <span class="friends">1458</span>
                <span class="awards">3769</span>
            </div>
        </div>
        <div class="content">
            <div class="quote">
                <span class="credit">אלברט שמחוני כתב:</span>
                לא הבנתי למה צריך ערוץ בלי פרסומות? עוד יותר לא הבנתי למה מישהו חושב שזה ריאלי בכלל? אפילו היום פרסומות נוזלות לערוץ הזה מכל החורים... קצת ריאליזם לא יזיק. תקשורת בלי פרסומות - אין דבר כזה בעולם קפיטליסטי. הסיבה היחידה שאני מבין לכך שיש כל כך הרבה מתנגדים לרעיון שלי הוא: שכתבתי שרק חלק מן האגרה ימומן על ידי פרסומות.
            </div>
            הגיעה העת לבטל את אגרת הטלוויזיה. במקום לדחוף הצעות שאין להן סיכוי, מוצע כאן לבטל את גביית האגרה, להעביר חלק מן הנטל לתשלום שאנחנו משלמים ממילא בזמן חידוש רשיון הרכב, וכך לחסוך מיליונים רבים.
            <div class="quoted_by">צוטט ע"י: <span><a href="">שם לדוגמא</a></span>, <span><a href="">שם לדוגמא</a></span> </div>
        </div>
        <div class="comment_buttons">
            <input class="button_quote" type="button" />
            <input class="button_comment" type="button" />
            <div class="button_fb"><img src="/images/placeholder_fb_2.png" /></div>
        </div>
        <div class="rating_small">
            <a href=""><span class="good"></span></a>
            <span class="counter">15</span>
            <a href=""><span class="bad"></span></a>
        </div>
    </div>

<!--
    <div class="comment_wrapper even">
        <div class="comment_details">
            <div class="photo">
                <img src="/images/icon_person.png" />
            </div>
            <div class="name">
                אסף גרינברג
            </div>
            <div class="date_time">
                <span class="time">14:46</span>
                <span class="date">27.07.2012</span>
            </div>
            <div class="ratings">
                <span class="friends">1458</span>
                <span class="awards">3769</span>
            </div>
        </div>
        <div class="content">
            הגיעה העת לבטל את אגרת הטלוויזיה. במקום לדחוף הצעות שאין להן סיכוי, מוצע כאן לבטל את גביית האגרה, להעביר חלק מן הנטל לתשלום שאנחנו משלמים ממילא בזמן חידוש רשיון הרכב, וכך לחסוך מיליונים רבים.
        </div>
        <div class="comment_buttons">
            <input class="button_quote" type="button" />
            <input class="button_comment" type="button" />
            <div class="button_fb"><img src="/images/placeholder_fb_2.png" /></div>
        </div>
        <div class="rating_small">
            <a href=""><span class="good"></span></a>
            <span class="counter">15</span>
            <a href=""><span class="bad"></span></a>
        </div>
    </div>

    <div class="comment_wrapper odd">
        <div class="comment_details">
            <div class="photo">
                <img src="/images/icon_person.png" />
            </div>
            <div class="name">
                אסף גרינברג
            </div>
            <div class="date_time">
                <span class="time">14:46</span>
                <span class="date">27.07.2012</span>
            </div>
            <div class="ratings">
                <span class="friends">1458</span>
                <span class="awards">3769</span>
            </div>
        </div>
        <div class="content">
            הגיעה העת לבטל את אגרת הטלוויזיה. במקום לדחוף הצעות שאין להן סיכוי, מוצע כאן לבטל את גביית האגרה, להעביר חלק מן הנטל לתשלום שאנחנו משלמים ממילא בזמן חידוש רשיון הרכב, וכך לחסוך מיליונים רבים.
        </div>
        <div class="comment_buttons">
            <input class="button_quote" type="button" />
            <input class="button_comment" type="button" />
            <div class="button_fb"><img src="/images/placeholder_fb_2.png" /></div>
        </div>
        <div class="rating_small">
            <a href=""><span class="good"></span></a>
            <span class="counter">15</span>
            <a href=""><span class="bad"></span></a>
        </div>
    </div>

    <div class="comment_wrapper even">
        <div class="comment_details">
            <div class="photo">
                <img src="/images/icon_person.png" />
            </div>
            <div class="name">
                אסף גרינברג
            </div>
            <div class="date_time">
                <span class="time">14:46</span>
                <span class="date">27.07.2012</span>
            </div>
            <div class="ratings">
                <span class="friends">1458</span>
                <span class="awards">3769</span>
            </div>
        </div>
        <div class="content">
            הגיעה העת לבטל את אגרת הטלוויזיה. במקום לדחוף הצעות שאין להן סיכוי, מוצע כאן לבטל את גביית האגרה, להעביר חלק מן הנטל לתשלום שאנחנו משלמים ממילא בזמן חידוש רשיון הרכב, וכך לחסוך מיליונים רבים.
        </div>
    </div>
-->

    <div id="pagination_wrapper" class="second_pagination">
        <div id="pagination" class="pagination">
          <!--  <span class="title">עמודים (24):</span>
            <a href=""><span class="last"></span></a>
            <a href=""><span class="next"></span></a>-->
           <!-- <span class="page current">1</span>
            <span class="page"><a href="">2</a></span>
            <span class="page"><a href="">3</a></span>
            <span class="page"><a href="">4</a></span>
            <span class="page"><a href="">5</a></span>
            <span class="page"><a href="">6</a></span>
            <span class="page"><a href="">7</a></span>-->
           <!-- <span class="page">...</span>
            <a href=""><span class="prev"></span></a>
            <a href=""><span class="first"></span></a>-->
        </div>
    </div>

    <div id="add_comment_wrapper">
        <h2 class="title">כתיבת תגובה</h2>
        <div class="comment_wrapper">
            <div class="comment_details">
                <div class="photo">
                    <img src="/images/icon_person.png" />
                </div>
                <div class="name">
                    אסף גרינברג
                </div>
                <div class="date_time">
                    <span class="time">14:46</span>
                    <span class="date">27.07.2012</span>
                </div>
                <div class="ratings">
                    <span class="friends">1458</span>
                    <span class="awards">3769</span>
                </div>
            </div>
            <div class="content">
                <img src="/images/placeholder_txt_editor.png" />
            </div>
        </div>
        <input type="button" class="button_submit_comment" />
    </div>

    </div>


    </div>


    </div>
<% include partials/footer.ejs %>


<script type="text/javascript">







var current_section = 1;

$(document).ready(function () {

    $('.button_edit_comment').hover(function(){
        $(this).parent().toggleClass('edit');
    });

    $('.suggestion_holder.button').hover(function(){
        $(this).toggleClass('edit');
    });

    $('.edit_window').hover(function(){
        $(this).parent().toggleClass('edit');
    });

    $('.suggestion_holder.window .text.change_proposal').hover(function(){
        $('.edit_window').parent().toggleClass('edit');
    });

    /***************************************************/
//    var my_id = "<%=user_logged ? user._id : ''%>";
    var discussion_id = "<%=discussion_id%>";
//    <%
//    if (user_logged) { %>
//        var proxy = JSON.parse('<%-proxy%>');
//    <%
//    } else { %>
//        var proxy = [];
//    <%
//    }
//    %>
//
//    var creator_id = "<%=discussion.creator_id%>";
//    var mouseDown, mouseUp, top, left;
//    var grade_id = "<%= discussion.grade_obj ? discussion.grade_obj.grade_id : 0 %>";
//    var sugg_grade_id;
//    var new_post_ref_id = null;  //if not null =>the create new post is connected to anther post
//    var my_discussion_grade = Number("<%= discussion.grade_obj ? discussion.grade_obj.value || 0 : 0 %>");
//    var discussion_grade = Number("<%= discussion.grade%>");
    var discussion_title = "<%= discussion.title%>"
    var discussion_img_field_preview = "<%= discussion.image_field ? discussion.image_field.url ||'' : '' %>";

//    var postsNumber = 0;
//    var is_creator = (my_id == creator_id);
//
//    var vision = $('#discussion_content').text();
//
//    var onGiveProxy;
//
//    var editor;
//
//    $( '#discussion_comment' ).ckeditor(            {
//        height: 100,
//        'line-height':10,
//        language:'he',
//        removePlugins : 'elementspath',
//        on :
//        {
//            instanceReady : function( ev )
//            {
//                editor = this;
//            }
//        }
//    });
//
//    $("#proxy_form").dialog({
//        autoOpen:false,
//        height:300,
//        width:350,
//        modal:true,
//        buttons:{
//            "תן/קח אסימונים":function () {
//
//                var self = this;
//
//                $(self).dialog("disable");
//                var bValid = true;
//                if (onGiveProxy) {
//
//                    onGiveProxy(Number($('#give_tokens', this).val()), function () {
//                        $(self).dialog("close");
//                    });
//                }
//            },
//            'בטל':function () {
//                $(this).dialog("close");
//            }
//        },
//        open:function () {
//            $(this).dialog('enable');
//        }
//    });
//
//    $("#discussion_content").val($("#discussion_content").text());
//
//    $(".slider").slider({
//        disabled:is_creator,
//        value:my_discussion_grade,
//        range:"min",
//        min:0,
//        max:10,
//        step:0.10,
//        change:function (event, ui) {
//
//            if (event.originalEvent) {      //ugly hack because of slider api bug
//                var my_prev_grade = my_discussion_grade;
//                my_discussion_grade = ui.value;
//
//                var user_info = {
//                    user_logged_in : user.first_name ? true : false,
//                    action_done : (user.actions_done_by_user && user.actions_done_by_user.grade_object) ? true : false,
//                    action_name : "grade_object",
//                    tokens_owned : user.tokens ? user.tokens : 0,
//                    price: gamification_price['grade_discussion']
//                }
//
//                db_functions.addDiscussionGrade(discussion_id, my_discussion_grade, grade_id, user_info, function (err, data) {
//
//                    if (!err) {
//                        if(data == 'canceled'){
//                            $(".slider").slider('value',my_prev_grade);
//                        } else {
//    //                    if(!(user.actions_done_by_user && user.actions_done_by_user.grade_object))
//    //                    {
//    //                        user.actions_done_by_user.grade_object = true;
//    //                    }
//                            $("#amount").val(Math.round(data.new_grade * 100) / 100);
//                            $("#graders").text(Math.round(data.evaluate_counter));
//                            $(".dark_bar").css('width', (my_discussion_grade * 10) + '%');
//                            grade_id = data.grade_id;
//                        }
//                    }
//                    else
//                        console.log(err);
//                });
//            }
//        }
//    });
//
//    $(".inline").colorbox({ inline:true, width:"730" });
//
//
//    /***************************************************/
//
//
//    function setUserScore(userID, score) {
//        $('[ data-creator_id=' + userID + ']').find('.score').empty().append(score);
//    }
//
//    function setCommentNumber(number) {
//
//        $('#comments_number')[0].innerHTML = '(' + number + ')';
//    }
//
//    db_functions.getDiscussionShoppingCart(discussion_id, function (err, data) {
//
//        $.each(data.objects, function (index, item) {
//            dust.render('discussion_information_item', item, function (err, out) {
//                $('.slide-c').append(out);
//            });
//        });
//
//        $('.slide-c')
//                .after('<div id="nav2">')
//                .cycle({
//                    fx:'scrollHorz',
//                    speed:'fast',
//                    timeout:0,
//                    pager:'#nav2',
//                    next:'#prev',
//                    prev:'#next'
//                });
//
//        if (data.objects.length < 2) {
//            $("#prev").hide();
//            $("#next").hide();
//        }
//
//    });
//
//    $('.discussion_content').on('mousedown', function (e) {
//        mouseDown = e;
//        console.log(e);
//    })
//            .on('mouseup',
//            function (e) {
//                mouseUp = e;
//                var err = false;
//                var range = $(this).find('textarea').getSelection();
//
//                left = Math.ceil((mouseDown.clientX + mouseUp.clientX) / 2 - ($(".popup-window").width() / 2));
//                top = Math.min(mouseDown.clientY, mouseUp.clientY) - $(".popup-window").height() - 40 + $(window).scrollTop();
//
//            }).on('keydown',
//            function (e) {
//                console.log(e.keyCode == 27);
//                if (!(e.shiftKey && (e.keyCode <= 40 && e.keyCode >= 37) || (e.ctrlKey && e.keyCode == 65))) e.preventDefault();
//            }).on('dragstart', function (e) {
//                e.preventDefault();
//            });
//
//    $('.popup-window .close').on('click', function () {
//        $('.popup-window').hide();
//    });
//
//    $('.popup-window').on('focus', function (e) {
//        e.preventDefault();
//    });
//
//    $("#discussion_content").select(function () {
//        range = $(this).getSelection();
//        flag = false;
//        db_functions.getSuggestionByDiscussion(discussion_id, null, null, function(err, suggestions){
//            $.each(suggestions.objects, function (index, suggestion) {
//                if ((suggestion.parts[0].start >= range.start && suggestion.parts[0].start <= range.end)
//                        || (suggestion.parts[0].end >= range.start && suggestion.parts[0].end <= range.end)) {
//                    flag = true;
//                }
//            })
//            if(flag)
//                popupProvider.showOkPopup({message:"הטקסט סומן כבר בהצעה לשינוי קיימת"});
//            else
//                $(".popup-window")
//                    .css({ top:top + 20, left:left, opacity:0 })
//                    .show()
//                    .animate({ top:'-=20px', opacity:1 }, 100, 'linear');
//        });
//
//        console.log(range);
//    });
//
//
//    $('#pop_suggest_bt').on("click", function (e) {
//        e.preventDefault();
//        $('#discussion_content_txt').text('"' + range.text + '"');
//        $('#write-comment').show();
//        $('textarea#discussion_suggest').focus();
//        $('#reload-img').attr('src', $('#reload-img').attr('src'));
//        $(".popup-window").hide();
//    });
//
//
//    $('#comments-box').on('hover', '.date', function (e) {
//        alert('dsfdsf');
//    })
//
//    $('#suggestion_list').on('click', '#add_or_remove_proxy', function (e) {
//        var userData = $(this).parents('.discussion-item');
//        var proxyId = userData.data('creator_id');
//        var userName = userData.data('creator_name');
//        var post_id = $(this).parents('.comment-one').attr('id');
//
//        e.preventDefault();
//
//        if(!my_id){
//            popupProvider.showLoginPopup({}, function(err, result){
//                if(!err)
//                    window.location = window.location + '?user_name=' + userName + '&proxy_id=' + proxyId + '&post_id=' + post_id;
//            });
//        }else{
//            proxyCommon.addOrRemoveProxy(proxy, proxyId, userName, my_id, function(newProxy){
//                proxy = newProxy.proxy;
//            })
//        }
//    });
//
//    var user_name = getURLParameter('user_name');
//    var proxy_id = getURLParameter('proxy_id');
//    var post_id = getURLParameter('post_id');
//
//    if(user_name  && proxy_id && user_name !== 'null' && proxy_id != 'null'){
//        proxyCommon.addOrRemoveProxy(proxy, proxy_id, user_name, my_id, function(newProxy){
//            proxy = newProxy.proxy;
//            window.location = window.location.pathname+ '#' + post_id;
//        })
//    }
//
//    $('#comments').on('click', '#add_or_remove_proxy', function (e) {
//        var userData = $(this).parents('.comment-one');
//        var proxyId = userData.data('creator_id');
//        var userName = userData.data('creator_name');
//        var post_id = $(this).parents('.comment-one').attr('id');
//        e.preventDefault();
//        if(!my_id){
//            popupProvider.showLoginPopup({}, function(err, result){
//                if(!err)
//                    window.location = window.location + '?user_name=' + userName + '&proxy_id=' + proxyId + '&post_id=' + post_id;
//            });
//        }else{
//            proxyCommon.addOrRemoveProxy(proxy, proxyId, userName, my_id, function(newProxy){
//                proxy = newProxy.proxy;
//            })
//        }
//    });
//
//    function vote(actionType){
//        var post_id = $(this).parents('.comment-one').data("id");
//        var button = $(this);
//        var user_info = {
//            user_logged_in : user.first_name ? true : false,
//            action_done : (user.actions_done_by_user && user.actions_done_by_user.vote_on_object) ? true : false,
//            action_name : "vote_on_object",
//            tokens_owned : user.tokens ? user.tokens : 0,
//            price: gamification_price['vote_on_post']
//        }
//        var func = $(this).parents('#comments').length ? db_functions.voteForPost : db_functions.voteForSuggestion;
//        func.call(db_functions, post_id, actionType, user_info, function (err, post_obj) {
//            if(post_obj != 'canceled'){
//                if (!err) {
//                    if(user && !user.actions_done_by_user.vote_on_object)
//                    {
//                        user.actions_done_by_user.vote_on_object = true;
//                    }
//                       button.parents(".ratio").find(".count").text(Math.round(post_obj.votes_for-post_obj.votes_against ));
//                       var down_arrow = button.parents(".ratio").find(".down");
//                       var up_arrow =button.parents(".ratio").find(".up");
//                       down_arrow.removeClass("balance0").removeClass("balance1").removeClass("balance2").removeClass("balance3").removeClass("balance-1").removeClass("balance-2").removeClass("balance-3").addClass("balance"+post_obj.voter_balance);
//                       up_arrow.removeClass("balance0").removeClass("balance1").removeClass("balance2").removeClass("balance3").removeClass("balance-1").removeClass("balance-2").removeClass("balance-3").addClass("balance"+post_obj.voter_balance);
//                }
//                else {
//                    if (err.responseText == 'Error: there is not enought tokens')
//                        popupProvider.showOkPopup( {message:     'אין לך מספיק אסימונים'});
//                    if (err.responseText == 'user already voted for this post')
//                        popupProvider.showOkPopup( {message:     'באפשרותך לתת עד שלושה אסימונים לתגובה בדיון'});
//                    if (err.responseText == 'soory, can\'t vote to your own post')
//                        popupProvider.showOkPopup( {message:     'מצטערים, לא ניתן להצביע לתגובה של עצמך'});
//                }
//            }
//        })
//    }
//
//    $('#comments').on('click', '.vote_for', function () {
//        vote.apply($(this),['add']);
//    });
//
//    $('#comments').on('click', ".vote_against", function () {
//        vote.apply($(this),['remove']);
//
//    });
//
//    /*      $('.comments-box .comment-one .user-right').hover(function () {
//     $(this).toggleClass('hover');
//     });*/
//
//    $('#comments,#suggestion_list').on('mouseenter', ".side_menu",
//            function (e) {
//                $(this).addClass('hover');
//                $('.left', this).show().css({width:0}).animate({'width':87});
//
//            }).on('mouseleave', ".side_menu", function (e) {
//                var side = $(this);
//                side.removeClass('hover');
//                $('.left', this).animate({'width':0}, function () {
//                    $(this).hide();
//                });
//            });
//
//    // copy the post text+ user to   discussion_comment
//    $('#comments').on('click', ".quote_button", function (e) {
//
//
//        var userName,
//                text;
//        var postDiv = $(this).parents('.comment-one');
//        var text_height = $(this).parents('div').find('.post_text').height();
//
//        e.preventDefault();
//       // $("textarea#discussion_comment").focus();
//        userName = postDiv.data('creator_name');
//        new_post_ref_id = postDiv.data('id');
//
//        var text_to_quote = $('.actual_text', postDiv).length ? $('.actual_text', postDiv).text() : $('.post_text', postDiv).text();
//
//        text = "[ציטוט=" + '"' + userName + '"' + " " + "]\n"
//                + text_to_quote
//                + '\n'
//                + "[/ציטוט]"
//                + '<p>&nbsp;</p>';
//
//        $("textarea#discussion_comment").val($("textarea#discussion_comment").val() + text).focus();
//        focusOnCommentBox();
//
//        $('#cke_contents_discussion_comment').height($('#cke_contents_discussion_comment').height() + text_height)
//
//    });
//
//
//    $('#comments').on('click', ".post_quote a", function (e) {
//
//        var post_id = $(this).parents(".comment-one").data("id");
//        var ref_to_post_id = $(this).parents(".comment-one").data("ref-id");
////        var link = window.location.href;
////
////        //remove hash if exist
////        if(window.location.hash){
////            link = link.slice(0, link.indexOf("#"));
////        }
////        var post_ref_id;
////        link = link + "#post_id" + post_ref_id;
//
//        scrollTo("#post_" + ref_to_post_id);
//    })
//
//
//    $('#suggestion_list').on('click', ".grey-btn", function (e) {
//
//        var userName,
//                text;
//
//        var postDiv = $(this).parents('.one');
//
//        e.preventDefault();
//        $("textarea#discussion_comment").focus();
//        focusOnCommentBox();
//        userName = postDiv.data('creator_name');
//        new_post_ref_id = postDiv.data('id');
//
//        var change_text = $('.change_text', postDiv).text();
//        var explanation = $('.explanation', postDiv).text();
//
//
//        if ($('.explanation', postDiv).text().trim() == "נימוק:") {
//
//            text = "[quote=" + '"' + userName + '"' + " " + "]\n"
//                    + change_text
//                    + '\n'
//                    + "[/quote]"
//                    + '\n';
//        } else {
//            text = "[quote=" + '"' + userName + '"' + " " + "]\n"
//                    + change_text
//                    + '\n'
//                    + explanation
//                    + '\n'
//                    + "[/quote]"
//                    + '\n';
//        }
//        $("textarea#discussion_comment").val(text).focus();
//        focusOnCommentBox();
//    });
//
//    $('#comments,#suggestion_list').on('click', ".follow_user", function (e) {
//        var creator_id = $(this).parents('.comment-one,.one').data("creator_id");
//        var self = this;
//
//        db_functions.joinOrLeaveUserFollowers(creator_id, function (err, user) {
//            if (user.is_follower)
//                $(self).text("עקוב");
//            else
//                $(self).text("עזוב");
//
//
//        });
//    });
//
//    // focus and copy the selected text of discussion
//    $('#pop_post_bt').on("click", function (e) {
//        e.preventDefault();
//        new_post_ref_id = null;
//        $(".popup-window").hide();
//        $("textarea#discussion_comment").val('"' + range.text + '"').focus();
//
//
//    });
//
//    // just focus
//    $("#discussion_comment_reply_button").on('click', function (e) {
//        e.preventDefault();
//        var discussionComment = $("textarea#discussion_comment").focus();
//        focusOnCommentBox();
//    });
//
    var suggest_grade_id = new Object();
    var original = "<%=discussion.text_field%>";
    var current_offset = 0;
    var limit = 2;
    var num_of_pages;

    //render change suggestion
    function render_suggestion(suggestion) {
        // get original text and alternative text
        if (suggestion.parts && suggestion.parts.length) {
            suggestion.original_part = function () {
                var from = suggestion.parts[0].start;
                var end = suggestion.parts[0].end;
                return original.substr(from, end - from);
            };
            suggestion.alternative_part = function () {
                return suggestion.parts[0].text;
            };

            dust.render('discussion_suggestion', suggestion, function (err, out) {
                $('#suggestions_wrapper').prepend(out);
                image_autoscale($('#suggestions_wrapper .auto-scale img'));
            });
        }
        return null;
    };


    var first_suggestion;

    // get change suggestions and render
    db_functions.getSuggestionByDiscussion(discussion_id, 1, 0, function (err, data) {
        $.each(data.objects, function (index, suggestion) {
            render_suggestion(suggestion);

            var curr_suggestion = $('#suggestions_wrapper').find('[data-id=' + suggestion.id + ']') ;

            db_functions.getCommentsBySuggestion(suggestion.id, function(err, data){
                $.each(data.objects, function (index, comment) {

                    comment.is_even = (index % 2) == 0;
                    dust.render('comment_on_suggestion', comment, function (err, out) {
                        // append before "add_comment"
                        curr_suggestion.find('.add_comment').before(out);
                        image_autoscale(curr_suggestion.find('.auto-scale img'));
                    });
                });
            })
        });

        $('#suggestion_number').text(' (' + data.meta.total_count + ')');
        if (data.objects.length > 0) {
            first_suggestion = data.objects[0];
            $(".content_break_content").show();
            if (data.meta.total_count >= 2) {
                $(".more-deals").show();

                $(".more-deals a").on('click', function (e) {
                    var self = $(this);
                    if($(this).data('executing')){
                        $('#suggestions_wrapper').empty();
                        render_suggestion(first_suggestion);
                        self.text('עוד הצעות');
                        $(this).removeClass('flip');

                        $(this).data('executing', false);
                        return false;
                    }else{
                        db_functions.getSuggestionByDiscussion(discussion_id, null, 1, function (err, data) {
                            $.each(data.objects, function (index, suggestion) {
                                render_suggestion(suggestion);
                            });
                        });

                        self.text('סגור הצעות ');
                        $(this).addClass('flip');
                        $(this).data('executing', true);
                        return false;
                    }
                });
            }
        }
        else {
            $(".content_break_content").hide();
        }
    });

    $('.add_comment input').bind("enterKey",function(e){
        var text = $(this).val();
        var suggestion_id = $(this).parent('suggestion_wrapper').data('id');
        var add_comment = $(this).parent('.add_comment');
        var can_continue = $(this).parent().data('can-add');

        if (can_continue){
            $(this).parent().attr('data-can-add', false);
            db_functions.addCommentToSuggestion(suggestion_id, discussion_id, text, function(err, comment){
                $(this).parent().attr('data-can-add', true);

//                comment.is_even = (index % 2) == 0;
                dust.render('comment_on_suggestion', comment, function (err, out) {
                    // append before "add_comment"
                    add_comment.before(out);
//                    image_autoscale(curr_suggestion.find('.auto-scale img'));
                });
            });
        }
    });

    $('.add_comment input').keyup(function(e){
        if(e.keyCode == 13)
        {
            $(this).trigger("enterKey");
        }
    });

    function renderComments(comments) {

        //first clear existing comments
        $('.comment_wrapper').remove();


        var i;
        for (i = 0; i < comments.length; i++) {
            comments[i].isFirst = (i === 0);
            comments[i].is_even = ((i % 2)== 0);
            comments[i].voting = comments[i].votes_for - comments[i].votes_against;
        };

        // render
        dust.renderArray('discussion_comment', comments, null, function (err, out) {
            if (!err) {
                var pagination = $(".second_pagination");
                pagination.before(out);
                var hash = window.location.hash;
                if (hash) {
                    if (!scrollTo(hash)) {
                        var match = /^#post_([0-9a-f]+)/.exec(hash);
                        if (match) {
                            var post_id = match[1];

                            db_functions.getPostById(post_id, function (err, post) {
                                dust.render('discussion_comment', post, function (err, out) {
                                    if (!err)
                                        pagination.append(out);
                                    scrollTo(hash);
                                });
                            });
                        }
                    }
                }

                image_autoscale($('.auto-scale img', comments));
//                initTooltipWithMessage($('#comments .right .respect'), 'מוניטין');

            }
        });
    }

    //set pagination
    function setPagination(){
        var new_span;
        $('.pagination').append('' +
                '<span class="title">עמודים (' + num_of_pages + '):</span>' +
                '<a href=""><span class="last"></span></a>' +
                '<a href=""><span class="next"></span></a>');

        for (var i=1; i<num_of_pages+1; i++ ){
            if (i == 1){
//                new_span = '<span class="page current ' + i + '" >' + i + '</span>';
                new_span = '<span class="page current ' + i + '"><a href="javascript: void(0)">' + i + '</a></span>';
            }else{
                new_span = '<span class="page ' + i + '"><a href="javascript: void(0)">' + i + '</a></span>';
            }
            $('.pagination').append(new_span);
        }

        $('.pagination').append('' +
                '<span class="page">...</span>' +
                '<a href=""><span class="prev"></span></a>' +
                '<a href=""><span class="first"></span></a>');
    }

    function loadPosts(page_number) {
        var selectedOption = $("#comments_filter").data();
        current_offset = page_number ? (page_number - 1) * limit : 0;

        // get posts with current offset
        db_functions.getSortedPostByDiscussion(discussion_id, "-creation_date"/*selectedOption*/, current_offset, limit, function (err, data) {
            if (err) {
                console.log(err);
            } else {
                num_of_pages = Math.ceil(data.meta.total_count / limit);

                if(!page_number){
                    setPagination();
                }else{
                    $('.pagination span .current').append('<a href="javascript: void(0)">' + page_number + '</a>');
                    $('.pagination span').removeClass('current');
                    $('.pagination .' + page_number).addClass('current');
                    $('.pagination .' + page_number + 'a').remove();
                }

                $.each(data.objects, function (index, post) {
                    post.title = discussion_title;
                    post.image_field_preview = discussion_img_field_preview;
                });

                renderComments(data.objects);

                /*if(data.meta.total_count > current_offset )
                    $('.more_comments').show();
                else
                    $('.more_comments').hide();
                postsNumber = data.meta.total_count;
                setCommentNumber(postsNumber);

                if(typeof(FB) != 'undefined')
                    FB.XFBML.parse();*/
            }
        })
    }

    $('.pagination').on('click', 'span a', function(button){
        var page_number = parseInt($(this).text());
        loadPosts(page_number);
    });

    // just focus
    $("#content_wrapper_comments").on('click', 'button_comment', function (e) {

        // TODO focus to add comment
    });


//
//    $('.more_comments').click(function() {
//        loadPosts();
//    });
//
//    $('#comments').on('hover', ".right .proxy", function (e) {
//
//        var name = $(this).parents(".comment-one").data("creator_name");
//        var num_of_proxies = $(this).parents(".comment-one").data("num_of_proxies");
//        var text = "מנדטים: " + name + " מייצג " + num_of_proxies + " חברי עורו ";
//        initTooltipWithMessage($('#comments .right .proxy'), text);
//    })
//
//    $('#suggestion_list').on('hover', ".right .proxy", function (e) {
//
//        var name = $(this).parents(".comment-one").data("creator_name");
//        var num_of_proxies = $(this).parents(".comment-one").data("num_of_proxies");
//        var text = "מנדטים: " + name + " מייצג " + num_of_proxies + " חברי עורו ";
//        initTooltipWithMessage($('#comments .right .proxy'), text);
//    })
//
//    $('#sorting_select').change(function() {
//        $("#comments").empty();
//        current_offset = 0;
//        loadPosts();
//    });
//
    loadPosts();
    //
//    $("#cancelWriteCommentBT").live("click", function () {
//        $('#write-comment').hide();
//    });
//
//    $("#submit_post").on('click', function (e) {
//        e.preventDefault();
//        var $this = $(this);
//
//        if ($this.data('executing')){
//            return;
//        }
//
//        $this.data('executing', true);
//        $this.addClass('disable');
//
//        var user_info = {
//            user_logged_in : user.first_name ? true : false,
//            action_done : (user.actions_done_by_user && user.actions_done_by_user.post_on_object) ? true : false,
//            action_name : "post_on_object",
//            tokens_owned : user.tokens ? user.tokens : 0,
//            price: gamification_price['post_on_discussion']
//        }
//
//        db_functions.addPostToDiscussion(discussion_id, $("textarea#discussion_comment").val(), new_post_ref_id, user_info, function (err, post) {
//            // $("#user_tokens").text(post.updated_user_tokens);
//            if (!err) {
//                if(post == 'canceled'){
//                    $this.data('executing', false);
//                    $this.removeClass('disable');
//                }
//                else
//                {
//                    if(!user.actions_done_by_user.post_on_object)
//                    {
//                        user.actions_done_by_user.post_on_object = true;
//                    }
//                    if (my_id)
//                        setUserScore(my_id, post.creator_id.score);
//                    post.voting = post.votes_for - post.votes_against;
//                    dust.render('discussion_comment', post, function (err, out) {
//                        $("#comments").append(out);
//                        $("textarea#discussion_comment").val('');
//                        new_post_ref_id = null;
//                        postsNumber++;
//                        setCommentNumber(postsNumber);
//                        $this.data('executing', false);
//                        $this.removeClass('disable')
//                    });
//                }
//            }
//        })
//    });
//
//
////            $('.sugg_rating_button').click(function(){
//    $('#suggestion_list').on('click', '.sugg_rating_button', function () {
//        var rating = Number($(this).parent().find($(".sugg_rating_select")).val());
//        sugg_grade_id = $(this).parent().data('grade');
//
//        var suggestion_id = $(this).parent().attr('id');
//        var self = this;
//        var user_info = {
//            user_logged_in : user.first_name ? true : false,
//            action_done : (user.actions_done_by_user && user.actions_done_by_user.grade_object) ? true : false,
//            action_name : "grade_object",
//            tokens_owned : user.tokens ? user.tokens : 0,
//            price: gamification_price['grade_suggestion']
//        }
//        db_functions.addSuggestionGrade(suggestion_id, discussion_id, rating, sugg_grade_id, user_info, function (err, data) {
//            if (!err) {
////                if(!(user.actions_done_by_user && user.actions_done_by_user.grade_object))
////                {
////                    user.actions_done_by_user.grade_object = true;
////                }
//                db_functions.getSuggestionByDiscussion(discussion_id, function (err, data) {
//                    $.each(data.objects, function (index, suggestion) {
//                        render_suggestion(suggestion);
//                    });
//                })
//            }
//        });
//    });
//
//    $('#suggest_button').click(function () {
//        $('#suggest_div').show();
//    });
//
//    $('#close_suggest').click(function () {
//        $('#suggest_div').hide();
//        $("textarea#discussion_suggest").val('');
//    });
//
//    $('#send_suggestion').click(function () {
//        var part = {start:range.start, end:range.end, text:$("textarea#discussion_suggest").val()};
//        //arrange spaces
//        if (vision[part.end - 1] == " " && part.text[part.text.length - 1] != " ")
//
//            part.text += " ";
//        var explanation = $("#discussion_explanation").val();
//
//        var user_info = {
//            user_logged_in : user.first_name ? true : false,
//            action_done : (user.actions_done_by_user && user.actions_done_by_user.suggestion_on_object) ? true : false,
//            action_name : "suggestion_on_object",
//            tokens_owned : user.tokens ? user.tokens : 0,
//            price: gamification_price['suggestion_on_discussion']
//        }
//
//        db_functions.addSuggestionToDiscussion(discussion_id, [part], explanation, user_info, function (err, data) {
//            if (!err) {
//                if(data != 'canceled'){
//                    if(!user.actions_done_by_user.suggestion_on_object)
//                    {
//                        user.actions_done_by_user.suggestion_on_object = true;
//                    }
//                    $('#write-comment').hide();
//                    /*
//                     $("textarea#discussion_suggest").val('');
//                     $("#user_tokens").text(data.updated_user_tokens);*/
//                    render_suggestion(data)
//                    $(".deals-box").show();
//                }
//            } else {
//                var err = err;
//                if(err.responseText == "a suggestion with this indexes already exist")
//                    popupProvider.showOkPopup({message:"הטקסט סומן כבר בהצעה לשינוי קיימת"});
//            }
//        });
//
//
//    });
//
//
//    $('.system-notice .close').click(function () {
//
//        $(this).parents('.system-notice').fadeOut(800);
//    });
//
//    $('#read_more').click(function () {
//
//        $(this).parents('.text-box').addClass('extended');
//        var h=  $(".hidden_textarea").get(0).scrollHeight;
//        $(".discussion_content").height(h);
//    });
//
//    function focusOnCommentBox(){
//        editor.focus();
//        editor.focusManager.focus();
//
//        setTimeout(function(){
//            var s =  CKEDITOR.instances.discussion_comment.getSelection();
//            var b = CKEDITOR.instances.discussion_comment.document.getBody();
//            s.selectElement(b);
//            var selected_ranges = s.getRanges();
//            selected_ranges[0].collapse(false);  //  false collapses the range to the end of the selected node, true before the node.
//            s.selectRanges(selected_ranges);
//        },100);
//    };
});


</script>
</body>
</html>
