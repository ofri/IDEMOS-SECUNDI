<!DOCTYPE html>
<%
var error_message = error_message || '';
%>
<html>
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# <%= settings.facebook_app_name %>: http://ogp.me/ns/fb/<%= settings.facebook_app_name %>#">
    <meta property="fb:app_id" content="<%= settings.facebook_app_id %>" />
    <meta property="og:url" content="<%= settings.root_path %>/discussions/<%= discussion.id %>" />


    <% include partials/head.ejs %>
    <link href="/css/discussions.css" rel="stylesheet" />
</head>
<body>
<% include partials/body_top.ejs %>
<div id="wrap" class="discussions_page">
    <div id="header">
        <% include partials/menu.ejs %>
        <% include partials/user_box.ejs %>
        <% include partials/failures.ejs %>
        <% include partials/tag_search.ejs %>
    </div>
    <!--<div >-->
    <div id="content_wrapper">
        <div id="content_main_wrapper">
            <div id="content_main_holder">
                <div id="content_right_holder">
                    <div class="segment main">
                        <h2 class="title topic"><%=discussion.subject_name%> <img src="/images/arrow_left.png" /></h2>
                        <h2 class="title">  <%=discussion.title%> </h2>
                        <div class="social_holder">
                            <a class="share_icon" href=""><img src="/images/icon_fb.png"></a>
                            <a class="share_icon" href=""><img src="/images/icon_tw.png"></a>
                            <a class="share_icon" href=""><img src="/images/icon_gp.png"></a>
                            <a class="share_icon" href=""><img src="/images/icon_email.png"></a>
                        </div>
                        <% if(discussion.creator_id){ %>
                        <div class="author">הדיון נפתח ע"י: <a href="/myuru/<%=discussion.creator_id._id%>"> <%=discussion.creator_id.first_name+ " " +discussion.creator_id.last_name %> </a></div>
                        <% } %>
                        <hr />


                        <div id="short">

                            <div id="discussion_image" style="width: 260px;height: 190px; overflow:hidden;" class='auto-scale  img_holder'>
                                <img src="<%= discussion.image_field ? discussion.image_field.url ||'' : '' %>" title="<%= discussion.title %>"/>
                            </div>

                            <div class="text main_text" style="max-height:180px">

                                <%- discussion.text_field.replace(/\n/g, '<br />') %>
                            </div>
                            <a class="read_more" href="javascript:void(0);">המשך קריאה</a>
                        </div>

                        <div id="full">
                            <div class="msg">בחר בעזרת הסמן איזורים בטקסט שברצונך להציע לשנותם</div>
                            <div id="discussion_content" class=""><%- discussion.text_field.replace(/\n/g, '<br />') %></div>
                            <textarea id="discussion_content_textarea" class="hidden_textarea"><%=discussion.text_field%></textarea>
                            <a class="read_more" href="javascript:void(0);">סגור מאמר</a>


                        </div>

                        <% if( discussion.sub_branding && discussion.sub_branding.length>0) { %>

                            <hr />
                            <div class="content_credits">
                                <div id="sponsors_holder">
                                    <h2>שותפי תוכן</h2>
                                    <div id="sponsors_logos">

                                        <% for (var c = 0; c <discussion.sub_branding.length; c++) { %>
                                         <a target="_blank" href="<%= discussion.sub_branding[c].link %>">
                                             <div id="sub_branding_image" style="width: 100px;height: 70px; overflow:hidden;" class='auto-scale floatRight'>
                                                 <img src="<%= discussion.sub_branding[c].image ? discussion.sub_branding[c].image.url ||'' : '' %>" title="<%= discussion.sub_branding[c].title %>"/>
                                             </div>
                                         </a>
                                        <% }%>

                                    </div>
                                </div>
                            </div>
                        <% } %>
                        <hr />
                        <div class="tags">
                            <span class="tags_title">תגיות:</span>
                            <% for (var c = 0; c <discussion. tags.length; c++) { %>
                                <span class="tag"><a href="?tag_name=<%=discussion.tags[c]%>"><%=discussion. tags[c] %></a></span>

                            <% }%>


                        </div>
                        <hr />

                        <div class="segment_bottom">


                            <div class="rating_box">
                                <div class="rating_total">
                                    <%= Math.round(discussion.grade*100)/100 %>
                                </div>
                                <div class="raters">
                                    <%= Math.round(discussion.evaluate_counter) %>
                                    דירוגים
                                </div>
                            </div>
                            <div class="slide-box">

                                    <div class="slider ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
                                    <div class="ui-slider-range ui-widget-header ui-slider-range-min" style="width: 0%;"></div><a class="ui-slider-handle ui-state-default ui-corner-all" href="#" style="left: 0%;"></a></div>
                                    <div class="slider-numbers">
                                        <span>1</span>
                                        <span>2</span>
                                        <span>3</span>
                                        <span>4</span>
                                        <span>5</span>
                                        <span>6</span>
                                        <span>7</span>
                                        <span>8</span>
                                        <span>9</span>
                                        <span>10</span>
                                    </div>
                                </div>

                            <div class="button_add_comment">
                                <input type="button" />
                            </div>
                            <div class="button_suggest_revisions">
                                <input type="button" />
                            </div>



                            <div class="history_details_holder">

                                <hr />
                                <div class="item">
                                    <input  class="history" type="button" />
                                </div>
                                <div class="item draft_no">
                                    טיוטה מספר: <span>8</span>
                                </div>
                                <div class="item last">
                                    עדכון אחרון: <span>15.03.12</span>
                                </div>
                                <div class="item by">
                                    על ידי: <span>אברהם אבוחצירא השלישי</span>
                                </div>
                            </div>


                        </div>
                    </div>

                    <div class="segment info">
                        <h2 class="title">סל מידע</h2>
                        <div id="info_items" class="info_items">
                            <!-- MovingBoxes Slider -->
                            <ul id="slider">
                            </ul><!-- end Slider #1 -->
                        </div>
                    </div>

                </div>
                <div id="content_left_sidebar">
                    <div class="segment press">
                        <h2>מן העיתונות</h2>
                        <div id="press_sidebar_holder">
                            <div class="item">
                                <div class="title">
                                    <img class="logo" src="/images/logo_sample_1.png" />
                                    <span class="date">29.04.12</span>
										<span class="text">
											המאבק בריכוזיות במשק הישראלי כמו גם נושאים נוספים
										</span>
                                </div>
                                <div class="photo">
                                    <img src="/images/placeholder_img_1.png" />
                                </div>
                                <div class="text">
                                    לשלוט על כמעט כל תחום בחיינו, מהקורנפלקס בבוקר, עמלות הבנקים בצהרים והחדשות בערב. איך מתמודדים עם המצב.
                                </div>
                            </div>
                            <div class="item">
                                <div class="title">
                                    <img class="logo" src="/images/logo_sample_1.png" />
                                    <span class="date">29.04.12</span>
										<span class="text">
											המאבק בריכוזיות במשק הישראלי כמו גם נושאים נוספים
										</span>
                                </div>
                                <div class="photo">
                                    <img src="/images/placeholder_img_1.png" />
                                </div>
                                <div class="text">
                                    לשלוט על כמעט כל תחום בחיינו, מהקורנפלקס בבוקר, עמלות הבנקים בצהרים והחדשות בערב. איך מתמודדים עם המצב.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="segment links">
                        <h2>קישורים מועילים</h2>
                        <div id="press_sidebar_holder">
                            <div class="item">
                                <div class="title">
                                    <a href="">החזית העממית לשחרור השחרור</a>
                                </div>
                                <div class="text">
                                    הריכוזיות במשק מאפשרת למעטים לשלוט על כמעט כל תחום בחיינו, מהקורנפלקס...
                                </div>
                            </div>
                            <div class="item">
                                <div class="title">
                                    <a href="">החזית העממית לשחרור השחרור</a>
                                </div>
                                <div class="text">
                                    הריכוזיות במשק מאפשרת למעטים לשלוט על כמעט כל תחום בחיינו, מהקורנפלקס...
                                </div>
                            </div>
                            <div class="item">
                                <div class="title">
                                    <a href="">החזית העממית לשחרור השחרור</a>
                                </div>
                                <div class="text">
                                    הריכוזיות במשק מאפשרת למעטים לשלוט על כמעט כל תחום בחיינו, מהקורנפלקס...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>


<span class="popup-window">
    <div class="tooltip_2">
        <input id="pop_suggest_bt" value="הוסף הצעה" class="button_add_suggestion" type="text" />
        <input id="pop_post_bt" value="הגב" class="button_respond" type="text" />
    </div>
</span>


    <div id='write-comment' class="write-comment" style="display: none;">
        <h3>
            הצעה לשינוי
        </h3>

        <div class="text-box cf">
            <div class="left">
                <p id='discussion_content_txt'><strong></strong>

                </p>
                <label>
                    ההצעה לשינוי שלי:
                </label>
                <textarea id='discussion_suggest' class="five-col" cols="0" rows="0"></textarea>
                <label>
                    טיעונים, הצדקות ונימוקים:
                </label>
                <textarea id="discussion_explanation" class="two-col" cols="0" rows="0"></textarea>
            </div>
            <div class="user-right">
                <div class="img-box" style="overflow: hidden;">
                    <div   style="width:70px; height:70px;" class='auto-scale'>
                        <% if(user_logged) { %>
                        <img id="reload-img" src="<%=avatar%>" alt="אני"  style="width:70px; height:70px"/>
                        <% } %>
                    </div>
                    <span></span>
                </div>
                <h4>אני</h4>

                <div class="date"><%=(new Date()).format('dd.mm.yy') %></div>
                <% if(user_logged){ %>
                <div class="proxy">
                    <span>3</span>
                </div>
                <div class="respect">
                    <span>20</span>
                </div>
                <% } %>
            </div>
        </div>
        <a class="grey-btn" id="cancelWriteCommentBT" href="javascript:void(0);"><span>
מתחרט
            </span></a>
        <a id="send_suggestion" class="green-btn" href="javascript:void(0);">
            הצע
        </a>
    </div>

    <div class="content_break">
        <div class="content_break_content">
            <h2>הצעות לשינוי
                <small id="suggestion_number"></small>
            </h2>
        </div>
    </div>
    <div id="content_wrapper_suggestions">
        <div id="suggestions_wrapper">
        </div>
        <div class="more-deals" data-executing="false">
            <a href="">עוד הצעות</a>
        </div>
    </div>
    <div class="content_break comments">
        <div class="content_break_content comments">
            <h2 id="comments-title">תגובות <small id="comments_number"></small></h2>
            <div id="comments_filter">
                <input data-sort-by="-creation_date" class="button_order_chron selected" type="button" />
                <input data-sort-by="-popularity" class="button_order_popular" type="button" />
                <input data-sort-by="-total_votes" class="button_order_contro" type="button" />
            </div>
        </div>
    </div>
    <div id="content_wrapper_comments">
        <div id="comments_wrapper">
            <div class="pagination_wrapper first_pagination">
			<div class="pagination_wrapper first_pagination">
                <div class="pagination">
                </div>
            </div>
            <div class="pagination_wrapper second_pagination">
                <div class="pagination">
                </div>
            </div>

            <div id="add_comment_wrapper" <%if(user_logged){%> data-creator_id="<%=user._id%>" <%}%> >
                <h2 class="title">כתיבת תגובה</h2>
                <div class="comment_wrapper">
                    <div class="comment_details">
                        <div class="img-box" style="overflow: hidden;">
                            <div style="height:64px" class='auto-scale'>
                                <img src="<%=avatar%>" alt="אני"/>
                            </div>
                            <span></span>
                        </div>
                        <div class="name">
                            <%if(user_logged){%>
                            <%=user.first_name + ' '+ user.last_name%>
                            <%}else{%>
                            אני
                            <%}%>

                        </div>
                        <div class="date_time">
                            <span class="time"><%=(new Date()).format('H:MM') %></span>
                            <span class="date"><%=(new Date()).format('dd.mm.yy') %></span>
                        </div>
                        <% if(user_logged){ %>
                        <div class="ratings">
                            <span class="friends"><%=user.num_of_proxies_i_represent%></span>
                            <span class="awards"><%=user.score%></span>
                        </div>
                        <% } %>
                    </div>
                    <div class="content">
                        <textarea id="discussion_comment" dir="rtl" class="four-col" cols="0" rows="0"></textarea>
                    </div>
                </div>
                <input id="submit_post" type="button" class="button_submit_comment" />
            </div>
    </div>
  </div>

   <% include partials/footer.ejs %>


<script type="text/javascript">

var current_section = 1;

$(document).ready(function () {
    var my_id = "<%=user_logged ? user._id : ''%>";
    var discussion_id = "<%=discussion_id%>";
    var creator_id = "<%=discussion.creator_id%>";
    var is_creator = (my_id == creator_id);
    var my_discussion_grade = Number("<%= discussion.grade_obj ? discussion.grade_obj.value || 0 : 0 %>");
    var discussion_grade = Number("<%= discussion.grade%>");
    var grade_id = "<%= discussion.grade_obj ? discussion.grade_obj.grade_id : 0 %>";
    var suggestions_list=null;
    var original = $('#discussion_content_textarea').val() ;
    var range={};
    var editor;

    // toggle edit class to open/close contxt popup window or edit suggestion button
    $('#suggestions_wrapper').on('mouseenter', '.text.change_proposal', function(){
        var edit_window = $(this).find('.edit_window');
        var window_height = edit_window.height();
        var window_padding = parseInt(edit_window.css("padding-top"));
        var window_border = parseInt(edit_window.css("border-top-width"));

        $(this).parents('.suggestion_wrapper').toggleClass('edit');
        $(this).parents('.suggestion_wrapper').toggleClass('show_edit_button');

        //set window top
        edit_window.css('top', 0 - window_height - (window_padding * 2 + window_border * 2));
    }).on('mouseleave', '.text.change_proposal', function(){
        $(this).parents('.suggestion_wrapper').toggleClass('edit');
    });

    // when clicking the edit_comment popup show go to creatק suggestion window
    $('#suggestions_wrapper').on('click', '.button_edit_comment', function(){
//        var text = $(this).parent('.content').text();
//        var post_id = $(this).parents('.comment_wrapper').data('id');
//        var content = $(this).parent('.content');
        var $suggestion_content = $(this).next();
        var orig_text = $suggestion_content.find('.original_part').text();
        var alternative_part = $suggestion_content.find('.alternative_part').text();
        var explanation =  $suggestion_content.find('.explanation').text();

        // set text and then focus
        $('#discussion_content_txt').text('"' + orig_text + '"');
        $('#write-comment').show();
        $('#reload-img').attr('src', $('#reload-img').attr('src'));
        $('textarea#discussion_suggest').text(alternative_part);
        $('textarea#discussion_explanation').text(explanation);
        $('textarea#discussion_suggest').focus();

        // change button text and set it to edit instead of creating new suggestion
        $('#send_suggestion').text('ערוך');
        $('#send_suggestion').data('edit', true);

        var sug_id =  $(this).parents('.suggestion_wrapper').data('id');
        $('#send_suggestion').data('suggestion-id', sug_id);
    });


//    $('#suggestions_wrapper').on('mouseenter', '.suggestion_holder.button', function(){
//        debugger
//        $(this).toggleClass('edit');
//    }).on('mouseleave', '.suggestion_holder.button', function(){
//        $(this).toggleClass('edit');
//    });

//    $('#suggestions_wrapper').on('mouseenter', '.edit_window', function(){
//        $(this).parent().toggleClass('edit');
//    }).on('mouseleave', '.edit_window', function() {
//        $(this).parent().toggleClass('edit');
//    });
//
//    $('#suggestions_wrapper').on('mouseenter', '.suggestion_holder.window .text.change_proposal', function(){
//        $('.edit_window').parent().toggleClass('edit');
//    }).on('mouseleave', '.edit_window', function() {
//        $(this).parent().toggleClass('edit');
//    });

    // edit comment popup when hover in comment text (only if user is the comment creator and hovering in the first 15 min after published)
    $('#comments_wrapper').on('mouseenter', '.edit_comment .content', function(){
        $(this).parents('.comment_wrapper').toggleClass('edit');
    }).on('mouseleave', '.edit_comment .content', function() {
        $(this).parents('.comment_wrapper').toggleClass('edit');
    });

    // when clicking the edit_comment popup show text editor and update button
    $('#comments_wrapper').on('click', '.content .button_edit_comment', function(){
        var text = $(this).parent('.content').text();
        var post_id = $(this).parents('.comment_wrapper').data('id');
        var content = $(this).parent('.content');

        content.html(
            '<textarea id="discussion_edit_comment" dir="rtl" class="four-col" cols="0" rows="0" style="margin: 2px; width: 676px; height: 86px;">' + text +'</textarea>' +
            '<input id="update_post" value="עדכן" type="button" class="button_submit_comment_no_text">');

        var edit_editor;
        // set ck editor
        $( '#discussion_edit_comment').ckeditor({
            height: 100,
            'line-height':10,
            language:'he',
            removePlugins : 'elementspath',
            on :
            {
                instanceReady : function( ev )
                {
                    edit_editor = this;
                }
            }
        });

        // add click listener to update_button
        $('#update_post').click(function(){
            var updated_text = $(this).siblings('#discussion_edit_comment').val();
            db_functions.editDiscussionPost(post_id, updated_text, function(err, data){
                if(!err){
                    content.html(data.text);
                }
            });
        });
    });

    /*$('#comments_wrapper').on('mouseenter', '.suggestion_holder.window .text.change_proposal', function(){
        $('.edit_window').parent().toggleClass('edit');
    }).on('mouseleave', '.edit_window', function() {
        $(this).parent().toggleClass('edit');
    });*/

    $('.button_suggest_revisions').click(function(){
        $(this).toggleClass('active');
        $('#change_proposal').toggleClass('active');
    });

    $('input.history').click(function(){
        $(this).toggleClass('active');
    });

    $(".main_text").dotdotdot({
        //	configuration goes here
    });

    db_functions.getDiscussionShoppingCart(discussion_id, function (err, data) {
        $.each(data.objects, function (index, item) {
            dust.render('cycle_information_item', item, function (err, out) {
                $('#slider').append(out);
            });
        });

        $('#info_items #slider').movingBoxes({
            /* width and panelWidth options deprecated, but still work to keep the plugin backwards compatible
             width: 500,
             panelWidth: 0.5,
             */
            initAnimation :false,
            fixedHeight :true,
            reducedSize :1,
            startPanel   : 1,      // start with this panel
            wrap         : true,   // if true, the panel will "wrap" (it really rewinds/fast forwards) at the ends
            buildNav     : true,   // if true, navigation links will be added
            navFormatter : function(){ return "&#9679;"; } // function which returns the navigation text for each panel
        });
    });

    $('.read_more').on('click', function () {
        $('#short').toggle();
        $('#full').toggle();
        var h=  $("textarea").get(0).scrollHeight;
        $("#full").height(h);
    });

    $('#send_suggestion').click(function () {
        var part = {start:range.start, end:range.end, text:$("textarea#discussion_suggest").val()};

        // todo i have replaced vision with original, see that it works
        //arrange spaces
        if (original[part.end - 1] == " " && part.text[part.text.length - 1] != " ")

            part.text += " ";

        // in case of editing existing suggestion
        if ($('#send_suggestion').data('edit') === true){
            $('#send_suggestion').data('edit', false);

            var sugg_id = $('#send_suggestion').data('suggestion-id');

            db_functions.editSuggestion(sugg_id, part.text, function(err, data){
                if(!err){
                    // hide edit box
                    $('#write-comment').hide();

                    // change text of suggestion
                    $('#suggestions_wrapper').find('[data-id=' + sugg_id + ']').find('.alternative_part').text(part.text);

                    // edit button text back t what it used to be
                    $('#send_suggestion').text('הצע');
                }
            })
        }else{
            // create new suggestion
            var explanation = $("#discussion_explanation").val();
            var user_info = {
                user_logged_in : user.first_name ? true : false,
                action_done : (user.actions_done_by_user && user.actions_done_by_user.suggestion_on_object) ? true : false,
                action_name : "suggestion_on_object",
                tokens_owned : user.tokens ? user.tokens : 0,
                price: gamification_price['suggestion_on_discussion']
            }

            db_functions.addSuggestionToDiscussion(discussion_id, [part], explanation, user_info, function (err, data) {
                if (!err) {
                    if(data != 'canceled'){
                        if(!user.actions_done_by_user.suggestion_on_object)
                        {
                            user.actions_done_by_user.suggestion_on_object = true;
                        }
                        $('#write-comment').hide();
                        /*
                         $("textarea#discussion_suggest").val('');
                         $("#user_tokens").text(data.updated_user_tokens);*/
                        render_suggestion(data)
                        $(".deals-box").show();
                    }
                } else {
                    var err = err;
                    if(err.responseText == "a suggestion with this indexes already exist")
                        popupProvider.showOkPopup({message:"????? ???? ??? ????? ?????? ?????"});
                }
            });
        }
    });

    $("#cancelWriteCommentBT").live("click", function () {
        $('#write-comment').hide();
    });

    $('.button_add_comment').on("click", function (e) {
        e.preventDefault();
        focusOnCommentBox();
    });
	
	$('#comments_wrapper').on("click", ".button_comment",function (e) {
        e.preventDefault();
        focusOnCommentBox();
    });

    $(".slider").slider({
        disabled:is_creator,
        value:my_discussion_grade,
        range:"min",
        min:0,
        max:10,
        step:0.10 ,
        change:function (event, ui) {
            if (event.originalEvent) {      //ugly hack because of slider api bug
                var my_prev_grade = my_discussion_grade;
                my_discussion_grade = ui.value;

                var user_info = {
                    user_logged_in : user.first_name ? true : false,
                    action_done : (user.actions_done_by_user && user.actions_done_by_user.grade_object) ? true : false,
                    action_name : "grade_object",
                    tokens_owned : user.tokens ? user.tokens : 0,
                    price: gamification_price['grade_discussion']
                }

                db_functions.addDiscussionGrade(discussion_id, my_discussion_grade, grade_id, user_info, function (err, data) {

                    if (!err) {
                        if(data == 'canceled'){
                            $(".slider").slider('value',my_prev_grade);
                        } else {
    //                    if(!(user.actions_done_by_user && user.actions_done_by_user.grade_object))
    //                    {
    //                        user.actions_done_by_user.grade_object = true;
    //                    }
                            $(".rating_total").text(Math.round(data.new_grade * 100) / 100);
                            $(".raters").text(Math.round(data.evaluate_counter) + " דירוגים   ");
                           // $(".dark_bar").css('width', (my_discussion_grade * 10) + '%');
                            grade_id = data.grade_id;
                        }
                    }
                    else
                        console.log(err);
                });
            }
        }
    });

    $("#submit_post").on('click', function (e) {
        e.preventDefault();
        var $this = $(this);

        if ($this.data('executing')){
            return;
        }

        $this.data('executing', true);
        $this.addClass('disable');

        var user_info = {
            user_logged_in : user.first_name ? true : false,
            action_done : (user.actions_done_by_user && user.actions_done_by_user.post_on_object) ? true : false,
            action_name : "post_on_object",
            tokens_owned : user.tokens ? user.tokens : 0,
            price: gamification_price['post_on_discussion']
        }

        db_functions.addPostToDiscussion(discussion_id, $("textarea#discussion_comment").val(), new_post_ref_id, user_info, function (err, post) {
            // $("#user_tokens").text(post.updated_user_tokens);
            if (!err) {
                if(post == 'canceled'){
                    $this.data('executing', false);
                    $this.removeClass('disable');
                }
                else
                {
                    if(!user.actions_done_by_user.post_on_object)
                    {
                        user.actions_done_by_user.post_on_object = true;
                    }
                    if (my_id)
                        setUserScore(my_id, post.creator_id.score);
                    post.voting = post.votes_for - post.votes_against;
                    dust.render('discussion_comment', post, function (err, out) {
                        $("#comments").append(out);
                        $("textarea#discussion_comment").val('');
                        new_post_ref_id = null;
                        postsNumber++;
                        setCommentNumber(postsNumber);
                        $this.data('executing', false);
                        $this.removeClass('disable')
                    });
                }
            }
        })
    });



//    $('.popup-window .close').on('click', function () {
//        $('.popup-window').hide();
//    });
//
//    $('.popup-window').on('focus', function (e) {
//        e.preventDefault();
//    });


    /***************************************************/

//    <%
//    if (user_logged) { %>
//        var proxy = JSON.parse('<%-proxy%>');
//    <%
//    } else { %>
//        var proxy = [];
//    <%
//    }
//    %>
//


//    var sugg_grade_id;
//    var new_post_ref_id = null;  //if not null =>the create new post is connected to anther post

    var discussion_title = "<%= discussion.title%>"
    var discussion_img_field_preview = "<%= discussion.image_field ? discussion.image_field.url ||'' : '' %>";

//    var postsNumber = 0;

//
//    var vision = $('#discussion_content').text();
//
//    var onGiveProxy;
//

//
//    $( '#discussion_comment' ).ckeditor(            {
//        height: 100,
//        'line-height':10,
//        language:'he',
//        removePlugins : 'elementspath',
//        on :
//        {
//            instanceReady : function( ev )
//            {
//                editor = this;
//            }
//        }
//    });
//
//    $("#proxy_form").dialog({
//        autoOpen:false,
//        height:300,
//        width:350,
//        modal:true,
//        buttons:{
//            "תן/קח אסימונים":function () {
//
//                var self = this;
//
//                $(self).dialog("disable");
//                var bValid = true;
//                if (onGiveProxy) {
//
//                    onGiveProxy(Number($('#give_tokens', this).val()), function () {
//                        $(self).dialog("close");
//                    });
//                }
//            },
//            'בטל':function () {
//                $(this).dialog("close");
//            }
//        },
//        open:function () {
//            $(this).dialog('enable');
//        }
//    });
//
//    $("#discussion_content").val($("#discussion_content").text());
//
//
//
//    $(".inline").colorbox({ inline:true, width:"730" });
//
//
//    /***************************************************/
//
//
//    function setUserScore(userID, score) {
//        $('[ data-creator_id=' + userID + ']').find('.score').empty().append(score);
//    }
//
//    function setCommentNumber(number) {
//
//        $('#comments_number')[0].innerHTML = '(' + number + ')';
//    }
//
//
//
//

//
//
//    $('#comments-box').on('hover', '.date', function (e) {
//        alert('dsfdsf');
//    })
//
//    $('#suggestion_list').on('click', '#add_or_remove_proxy', function (e) {
//        var userData = $(this).parents('.discussion-item');
//        var proxyId = userData.data('creator_id');
//        var userName = userData.data('creator_name');
//        var post_id = $(this).parents('.comment-one').attr('id');
//
//        e.preventDefault();
//
//        if(!my_id){
//            popupProvider.showLoginPopup({}, function(err, result){
//                if(!err)
//                    window.location = window.location + '?user_name=' + userName + '&proxy_id=' + proxyId + '&post_id=' + post_id;
//            });
//        }else{
//            proxyCommon.addOrRemoveProxy(proxy, proxyId, userName, my_id, function(newProxy){
//                proxy = newProxy.proxy;
//            })
//        }
//    });
//
//    var user_name = getURLParameter('user_name');
//    var proxy_id = getURLParameter('proxy_id');
//    var post_id = getURLParameter('post_id');
//
//    if(user_name  && proxy_id && user_name !== 'null' && proxy_id != 'null'){
//        proxyCommon.addOrRemoveProxy(proxy, proxy_id, user_name, my_id, function(newProxy){
//            proxy = newProxy.proxy;
//            window.location = window.location.pathname+ '#' + post_id;
//        })
//    }
//
//    $('#comments').on('click', '#add_or_remove_proxy', function (e) {
//        var userData = $(this).parents('.comment-one');
//        var proxyId = userData.data('creator_id');
//        var userName = userData.data('creator_name');
//        var post_id = $(this).parents('.comment-one').attr('id');
//        e.preventDefault();
//        if(!my_id){
//            popupProvider.showLoginPopup({}, function(err, result){
//                if(!err)
//                    window.location = window.location + '?user_name=' + userName + '&proxy_id=' + proxyId + '&post_id=' + post_id;
//            });
//        }else{
//            proxyCommon.addOrRemoveProxy(proxy, proxyId, userName, my_id, function(newProxy){
//                proxy = newProxy.proxy;
//            })
//        }
//    });
//
    function vote(actionType){
        var post_id = $(this).parents('.comment_wrapper').data("id");
        var button = $(this);
        var user_info = {
            user_logged_in : user.first_name ? true : false,
            action_done : (user.actions_done_by_user && user.actions_done_by_user.vote_on_object) ? true : false,
            action_name : "vote_on_object",
            tokens_owned : user.tokens ? user.tokens : 0,
            price: gamification_price['vote_on_post']
        }
        var func = $(this).parents('#comments_wrapper').length ? db_functions.voteForPost : db_functions.voteForSuggestion;
        func.call(db_functions, post_id, actionType, user_info, function (err, post_obj) {
            if(post_obj != 'canceled'){
                if (!err) {
                    if(user && !user.actions_done_by_user.vote_on_object)
                    {
                        user.actions_done_by_user.vote_on_object = true;
                    }
                       button.parents(".rating_small").find(".counter").text(Math.round(post_obj.votes_for-post_obj.votes_against ));
                       var down_arrow = button.parents(".rating_small").find(".bad");
                       var up_arrow =button.parents(".rating_small").find(".good");
                       down_arrow.removeClass("balance0").removeClass("balance1").removeClass("balance-1").addClass("balance"+post_obj.voter_balance);
                       up_arrow.removeClass("balance0").removeClass("balance1").removeClass("balance-1").addClass("balance"+post_obj.voter_balance);
                }
                else {
                    if (err.responseText == 'Error: there is not enought tokens')
                        popupProvider.showOkPopup( {message:     'אין לך מספיק אסימונים'});
                    if (err.responseText == 'user already voted for this post')
                        popupProvider.showOkPopup( {message:     'באפשרותך לתת אסימון אחד לתגובה'});
                    if (err.responseText == 'soory, can\'t vote to your own post')
                        popupProvider.showOkPopup( {message:     'מצטערים, לא ניתן להצביע לתגובה של עצמך'});
                }
            }
        })
    }

    $('#comments_wrapper').on('click', '.good', function () {
        vote.apply($(this),['add']);
    });

    $('#comments_wrapper').on('click', ".bad", function () {
        vote.apply($(this),['remove']);
    });

//    /*      $('.comments-box .comment-one .user-right').hover(function () {
//     $(this).toggleClass('hover');
//     });*/
//
//    $('#comments,#suggestion_list').on('mouseenter', ".side_menu",
//            function (e) {
//                $(this).addClass('hover');
//                $('.left', this).show().css({width:0}).animate({'width':87});
//
//            }).on('mouseleave', ".side_menu", function (e) {
//                var side = $(this);
//                side.removeClass('hover');
//                $('.left', this).animate({'width':0}, function () {
//                    $(this).hide();
//                });
//            });
//
    // copy the post text+ user to   discussion_comment
    $('#comments_wrapper').on('click', ".button_quote", function (e) {
        var userName;
        var text;
        var postDiv = $(this).parents('.comment_wrapper');
        // TODO chnge this text height
        var text_height = $(this).parents('.comment_wrapper ').find('.content').height();
        var new_post_ref_id;
        e.preventDefault();
        userName = postDiv.data('creator_name');
        new_post_ref_id = postDiv.data('id');

        // TODO replace actual_text selector
        var text_to_quote = $('.actual_text', postDiv).length ? $('.actual_text', postDiv).text() : $('.content', postDiv).text();

        text = "[ציטוט=" + '"' + userName + '"' + " " + "]\n"
                + text_to_quote
                + '\n'
                + "[/ציטוט]"
                + '<p>&nbsp;</p>';

        $("textarea#discussion_comment").val($("textarea#discussion_comment").val() + text).focus();
        focusOnCommentBox(text_height);

        $("textarea#discussion_comment").height($("textarea#discussion_comment").height() + text_height);
    });

//    $('#comments').on('click', ".post_quote a", function (e) {
//
//        var post_id = $(this).parents(".comment-one").data("id");
//        var ref_to_post_id = $(this).parents(".comment-one").data("ref-id");
////        var link = window.location.href;
////
////        //remove hash if exist
////        if(window.location.hash){
////            link = link.slice(0, link.indexOf("#"));
////        }
////        var post_ref_id;
////        link = link + "#post_id" + post_ref_id;
//
//        scrollTo("#post_" + ref_to_post_id);
//    })
//
//
//    $('#suggestion_list').on('click', ".grey-btn", function (e) {
//
//        var userName,
//                text;
//
//        var postDiv = $(this).parents('.one');
//
//        e.preventDefault();
//        $("textarea#discussion_comment").focus();
//        focusOnCommentBox();
//        userName = postDiv.data('creator_name');
//        new_post_ref_id = postDiv.data('id');
//
//        var change_text = $('.change_text', postDiv).text();
//        var explanation = $('.explanation', postDiv).text();
//
//
//        if ($('.explanation', postDiv).text().trim() == "נימוק:") {
//
//            text = "[quote=" + '"' + userName + '"' + " " + "]\n"
//                    + change_text
//                    + '\n'
//                    + "[/quote]"
//                    + '\n';
//        } else {
//            text = "[quote=" + '"' + userName + '"' + " " + "]\n"
//                    + change_text
//                    + '\n'
//                    + explanation
//                    + '\n'
//                    + "[/quote]"
//                    + '\n';
//        }
//        $("textarea#discussion_comment").val(text).focus();
//        focusOnCommentBox();
//    });
//
//    $('#comments,#suggestion_list').on('click', ".follow_user", function (e) {
//        var creator_id = $(this).parents('.comment-one,.one').data("creator_id");
//        var self = this;
//
//        db_functions.joinOrLeaveUserFollowers(creator_id, function (err, user) {
//            if (user.is_follower)
//                $(self).text("עקוב");
//            else
//                $(self).text("עזוב");
//
//
//        });
//    });
//

//
//    // just focus
//    $("#discussion_comment_reply_button").on('click', function (e) {
//        e.preventDefault();
//        var discussionComment = $("textarea#discussion_comment").focus();
//        focusOnCommentBox();
//    });
//
    var suggest_grade_id = new Object();

    var current_offset = 0;
    var limit = 2;
    var num_of_pages;
    var num_of_pages_in_section = 7;
    var total_post_count;

    //render change suggestion
    function render_suggestion(suggestion) {
        // get original text and alternative text
        if (suggestion.parts && suggestion.parts.length) {
            suggestion.original_part = function () {
                var from = suggestion.parts[0].start;
                var end = suggestion.parts[0].end;
                return original.substr(from, end - from);
            };
            suggestion.alternative_part = function () {
                return suggestion.parts[0].text;
            };

            dust.render('discussion_suggestion', suggestion, function (err, out) {
                $('#suggestions_wrapper').prepend(out);
                image_autoscale($('#suggestions_wrapper .auto-scale img'));
            });
        }
        return null;
    };


    var first_suggestion;

    // get change suggestions and render
    db_functions.getSuggestionByDiscussion(discussion_id, 1, 0, function (err, data) {
        suggestions_list = data.objects ;
        displaySuggestionsRanges();
        $.each(data.objects, function (index, suggestion) {
            render_suggestion(suggestion);

            var curr_suggestion = $('#suggestions_wrapper').find('[data-id=' + suggestion.id + ']');

            db_functions.getCommentsBySuggestion(suggestion.id, function(err, data){

                // set comments counter
                curr_suggestion.find('.comments_counter span').text(data.objects.length);

                $.each(data.objects, function (index, comment) {
                    comment.is_even = (index % 2) == 0;
                    dust.render('comment_on_suggestion', comment, function (err, out) {
                        // append before "add_comment"
                        curr_suggestion.find('.add_comment').before(out);
                        image_autoscale(curr_suggestion.find('.auto-scale img'));
                    });
                });
            })
        });

        $('#suggestion_number').text(' (' + data.meta.total_count + ')');
        if (data.objects.length > 0) {
            var curr_suggestion;
            first_suggestion = data.objects[0];
            $(".content_break_content").show();
            if (data.meta.total_count >= 2) {
                $(".more-deals").show();

                $(".more-deals a").on('click', function (e) {
                    var self = $(this);
                    if($(this).data('executing')){
                        $('#suggestions_wrapper').empty();
                        render_suggestion(first_suggestion);
                        curr_suggestion = $('#suggestions_wrapper').find('[data-id=' + first_suggestion.id + ']');

                        db_functions.getCommentsBySuggestion(first_suggestion.id, function(err, data){
                            // set comments counter
                            curr_suggestion.find('.comments_counter span').text(data.objects.length);

                            $.each(data.objects, function (index, comment) {
                                comment.is_even = (index % 2) == 0;
                                dust.render('comment_on_suggestion', comment, function (err, out) {
                                    // append before "add_comment"
                                    curr_suggestion.find('.add_comment').before(out);
                                    image_autoscale(curr_suggestion.find('.auto-scale img'));
                                });
                            });
                        })
                        self.text('עוד הצעות');
                        $(this).removeClass('flip');

                        $(this).data('executing', false);
                        return false;
                    }else{
                        db_functions.getSuggestionByDiscussion(discussion_id, null, 1, function (err, data) {
                            $.each(data.objects, function (index, suggestion) {
                                render_suggestion(suggestion);

                                db_functions.getCommentsBySuggestion(suggestion.id, function(err, data){
                                    curr_suggestion = $('#suggestions_wrapper').find('[data-id=' + suggestion.id + ']') ;

                                    // set comments counter
                                    curr_suggestion.find('.comments_counter span').text(data.objects.length);

                                    $.each(data.objects, function (index, comment) {

                                        comment.is_even = (index % 2) == 0;
                                        dust.render('comment_on_suggestion', comment, function (err, out) {
                                            // append before "add_comment"
                                            curr_suggestion.find('.add_comment').before(out);
                                            image_autoscale(curr_suggestion.find('.auto-scale img'));
                                        });
                                    });
                                })
                            });
                        });

                        self.text('סגור הצעות ');
                        $(this).addClass('flip');
                        $(this).data('executing', true);
                        return false;
                    }
                });
            }
        }
        else {
            $(".content_break_content").hide();
        }
    });

//    $('.add_comment input').bind("enterKey",function(e){
//        var text = $(this).val();
//        var suggestion_id = $(this).parent('suggestion_wrapper').data('id');
//        var add_comment = $(this).parent('.add_comment');
//        var can_continue = $(this).parent().data('can-add');
//
//        if (can_continue){
//            $(this).parent().attr('data-can-add', false);
//            db_functions.addCommentToSuggestion(suggestion_id, discussion_id, text, function(err, comment){
//                $(this).parent().attr('data-can-add', true);
//
////                comment.is_even = (index % 2) == 0;
//                dust.render('comment_on_suggestion', comment, function (err, out) {
//                    // append before "add_comment"
//                    add_comment.before(out);
////                    image_autoscale(curr_suggestion.find('.auto-scale img'));
//                });
//            });
//        }
//    });

    $('#suggestions_wrapper').on('keyup', '.add_comment input', function(e){
        if(e.keyCode == 13)
        {
            var text = $(this).val();
            var suggestion_id = $(this).parents('.suggestion_wrapper').data('id');
            var add_comment = $(this).parent('.add_comment');
            var can_continue = $(this).parent().data('can-add');

            if (can_continue){
                $(this).parent().attr('data-can-add', false);
                db_functions.addCommentToSuggestion(suggestion_id, discussion_id, text, function(err, comment){
                    $(this).parent().attr('data-can-add', true);
                    add_comment.find('input').val('');
//                comment.is_even = (index % 2) == 0;
                    dust.render('comment_on_suggestion', comment, function (err, out) {
                        // append before "add_comment"
                        add_comment.before(out);
                        image_autoscale(add_comment.parent('.suggestion_comments_holder').find('.auto-scale img'));
                    });
                });
            }
        }
    });

    // close/open suggestion comments
    $('#suggestions_wrapper').on('click', '.suggestion_bottom .close', function(){
        $(this).hide();
        $(this).parents('.suggestion_wrapper').find('.comment').hide();
    });

    function renderComments(comments) {

        //first clear existing comments
        $('.comment_wrapper.even, .comment_wrapper.odd').remove();

        var i;
        for (i = 0; i < comments.length; i++) {
            comments[i].isFirst = (i === 0);
            comments[i].is_even = ((i % 2)== 0);
            comments[i].voting = comments[i].votes_for - comments[i].votes_against;
        };

        // render
        dust.renderArray('discussion_comment', comments, null, function (err, out) {
            if (!err) {
                var pagination = $(".second_pagination");
                pagination.before(out);
                var hash = window.location.hash;
                if (hash) {
                    if (!scrollTo(hash)) {
                        var match = /^#post_([0-9a-f]+)/.exec(hash);
                        if (match) {
                            var post_id = match[1];

                            db_functions.getPostById(post_id, function (err, post) {
                                dust.render('discussion_comment', post, function (err, out) {
                                    if (!err){
                                        pagination.append(out);
                                    }
                                    scrollTo(hash);
                                });
                            });
                        }
                    }
                }

                image_autoscale($('.auto-scale img', comments));

                // i paste it here to prevent the weird bug "cannot insertBefore null"
                $('#discussion_comment').ckeditor({
                    height: 70,
                    width: 810,
                    'line-height':10,
                    language:'he',
                    removePlugins : 'elementspath',
                    on :
                    {
                        instanceReady : function( ev )
                        {
                            editor = this;
                            editor = this;
                        }
                    }
                });
//             initTooltipWithMessage($('#comments .right .respect'), 'מוניטין');
            }
        });
    }

    //set pagination
    function setPagination(){
        var new_span;
        var pages = Math.min(num_of_pages_in_section, num_of_pages);
        $('.pagination').append('' +
                '<span class="title">עמודים (' + num_of_pages + '):</span>' +
                '<a href="javascript: void(0)"><span class="first"></span></a>' +
                '<a href="javascript: void(0)"><span class="prev"></span></a>');

        for (var i=1; i<pages+1; i++ ){
            if (i == 1){
                new_span = '<span class="page current" data-first="true"><a href="javascript: void(0)">' + i + '</a></span>';
            }else if (i==pages){
                new_span = '<span class="page" data-last="true"><a href="javascript: void(0)">' + i + '</a></span>';
            }else{
                new_span = '<span class="page"><a href="javascript: void(0)">' + i + '</a></span>';
            }
            $('.pagination').append(new_span);
        }

        if (num_of_pages > pages) $('.pagination').append('<span class="page up-dots">...</span>');

        $('.pagination').append('' +
            '<a href="javascript: void(0)"><span class="next"></span></a>' +
            '<a href="javascript: void(0)"><span class="last"></span></a>');
    }

	 function loadSpecialPost(type, class_type, title){
        db_functions.getPostByTypeByDiscussion(discussion_id, type, function(err, data){
            if (!err){
                var special_post = data.objects[0];
                special_post.class_type = class_type;
                special_post.title = title;

                dust.render('discussion_special_comment', special_post, function (err, out) {
                    $('#comments_wrapper').prepend(out);
                    $('.comment_wrapper .content').dotdotdot({});
                    image_autoscale($('#comments_wrapper .auto-scale img'));
                });
            }
        })
    };


    function loadPosts(page_number, pagination_action) {
        var selectedOption = $("#comments_filter .selected").data('sort-by');
        current_offset = page_number ? (page_number - 1) * limit : 0;

        // get posts with current offset
        db_functions.getSortedPostByDiscussion(discussion_id, selectedOption || '-creation_date', current_offset, limit, function (err, data) {
            if (err) {
                console.log(err);
            } else {
                total_post_count = data.meta.total_count;
                num_of_pages = Math.ceil(total_post_count / limit);
                $('#comments_number').text(' (' + data.meta.total_count + ')');

                if(!page_number){
                    setPagination();
                }else{
                    if (pagination_action === 'move_up'){
                        var paging_up = Math.min(Math.floor(num_of_pages_in_section / 2), num_of_pages - page_number);

                        $.each($('.pagination .page a'), function(index, page){
                            var a = $(this);
                            a.text(parseInt(a.text()) + paging_up);
                        });

                        // addinnd 3 dots
                        if ($('.pagination .down-dots').length === 0){
                            $('.pagination').find("[data-first=true]").before('<span class="page down-dots">...</span>');
                        }

                        //removeing 3 dots
                        if ((parseInt($('.first_pagination .pagination .page[data-last=true]').text()) === num_of_pages)){
                            //remove 3 dots
                            $('.pagination .up-dots').remove();
                        }
                    }
                    if (pagination_action === 'move_down'){
                        var paging_down = Math.min(Math.floor(num_of_pages_in_section / 2), page_number - 1);

                        $.each($('.pagination .page a'), function(index, page){
                            var a = $(this);
                            a.text(parseInt(a.text()) - paging_down);
                        });

                        if ($('.first_pagination .pagination .page[data-first=true]').text() === "1"){
                            //remove 3 dots
                            $('.pagination .down-dots').remove();
                        }
                        // addinnd 3 dots
                        if ($('.pagination .up-dots').length === 0 && parseInt($('.first_pagination .pagination .page[data-last=true]').text()) < num_of_pages ){
                            $('.pagination .next').before('<span class="page up-dots">...</span>');
                        }
                    }
                    if (pagination_action === 'first' || pagination_action === 'last'){
                        var pages = Math.min(num_of_pages_in_section, num_of_pages);
                        var page_counter;

                        if (pagination_action === 'first'){
                            page_counter = 1;

                            //remove 3 dots
                            $('.pagination .down-dots').remove();
                        }else{
                            if(num_of_pages_in_section === num_of_pages){
                                // no need to change page numbers
                                page_counter = 0;
                            }else{
                                page_counter = num_of_pages - num_of_pages_in_section + 1;
                            }

                            //remove 3 dots
                            $('.pagination .up-dots').remove();
                        }

                        var temp_counter = page_counter;
                        $.each($('.first_pagination .pagination .page a'), function(index, page){
                            var a = $(this);
                            a.text(temp_counter++);
                        });

                        temp_counter = page_counter;
                        $.each($('.second_pagination .pagination .page a'), function(index, page){
                            var a = $(this);
                            a.text(temp_counter++);
                        });

                        // addinnd 3 dots
                        if ($('.pagination .down-dots').length === 0 && parseInt($('.first_pagination .pagination [data-first=true]').text()) > 1){
                            $('.pagination').find("[data-first=true]").before('<span class="page down-dots">...</span>');
                        }
                    }

                    $('.pagination span').removeClass('current');
                    $('.pagination .page:contains("' + page_number + '")').addClass('current');
                    $('.pagination .' + page_number + 'a').remove();
                }

                $.each(data.objects, function (index, post) {
                    post.title = discussion_title;
                    post.image_field_preview = discussion_img_field_preview;
                });

                renderComments(data.objects);


                /*if(data.meta.total_count > current_offset )
                    $('.more_comments').show();
                else
                    $('.more_comments').hide();
                postsNumber = data.meta.total_count;
                setCommentNumber(postsNumber);

                if(typeof(FB) != 'undefined')
                    FB.XFBML.parse();*/
            }
        })
    }

    $('.pagination').on('click', 'a', function(button){
        var page_number = parseInt($(this).text());
        var current_page = $('.pagination .current')[0];
        var current_page_link = $('.pagination .current a')[0];
        var action;
        var is_first = $(current_page).data('first');
        var is_last = $(current_page).data('last');


        // in case clicking one of the prev/next etc
        if (isNaN(page_number)){
            page_number =  parseInt($(current_page_link).text());
            action = $(this).find('span').attr('class');

            if (page_number === 1 && action === 'prev') return false;
            if (page_number === num_of_pages && action === 'next') return false;
            if (is_last && action === 'next'){
                action = 'move_up';
            }
            if (is_first && action === 'prev'){
                action = 'move_down';
            }

            if (action === 'prev') --page_number;
            if (action === 'next') ++page_number;
            if (action === 'first') page_number = 1;
            if (action === 'last') page_number = num_of_pages;
        }

        loadPosts(page_number, action);
    });

    $("#comments_filter input").click(function(){

        var inputs = $(this).parent().find("input");

        //set selected class to the selected
        inputs.removeClass('selected');
        inputs.removeClass('hover');
        $(this).addClass('selected');
        
        loadPosts(1);
    });

    $("#comments_filter input").hover(function(){
        var inputs = $(this).parent().find("input");

        //set hover class to the selected
        inputs.removeClass('been_hover');
        $(this).addClass('been_hover');
    });
//
//    $('.more_comments').click(function() {
//        loadPosts();
//    });
//
//    $('#comments').on('hover', ".right .proxy", function (e) {
//
//        var name = $(this).parents(".comment-one").data("creator_name");
//        var num_of_proxies = $(this).parents(".comment-one").data("num_of_proxies");
//        var text = "מנדטים: " + name + " מייצג " + num_of_proxies + " חברי עורו ";
//        initTooltipWithMessage($('#comments .right .proxy'), text);
//    })
//
//    $('#suggestion_list').on('hover', ".right .proxy", function (e) {
//
//        var name = $(this).parents(".comment-one").data("creator_name");
//        var num_of_proxies = $(this).parents(".comment-one").data("num_of_proxies");
//        var text = "מנדטים: " + name + " מייצג " + num_of_proxies + " חברי עורו ";
//        initTooltipWithMessage($('#comments .right .proxy'), text);
//    })
//
//    $('#sorting_select').change(function() {
//        $("#comments").empty();
//        current_offset = 0;
//        loadPosts();
//    });

    loadSpecialPost('total_votes', 'most_contr', 'התגובה השנויה במחלוקת');
    loadSpecialPost('popularity', 'most_pop', 'התגובה הפופולרית ביותר');
    loadPosts();

    function focusOnCommentBox(text_height){
        editor.focus();
        editor.focusManager.focus();

        setTimeout(function(){
            var s =  CKEDITOR.instances.discussion_comment.getSelection();
            var b = CKEDITOR.instances.discussion_comment.document.getBody();
            s.selectElement(b);
            var selected_ranges = s.getRanges();
            selected_ranges[0].collapse(false);  //  false collapses the range to the end of the selected node, true before the node.
            s.selectRanges(selected_ranges);

            if(text_height){
                CKEDITOR.instances.discussion_comment.resize(755, 100 + text_height);
                $('#comments_wrapper #add_comment_wrapper .comment_wrapper').height(100 + text_height);
            }

        },100);
    };

    function displaySuggestionsRanges(){
        $.each(suggestions_list, function (index, suggestion) {
           var text =  original.substr(suggestion.parts[0].start,suggestion.parts[0].end - suggestion.parts[0].start);
           console.log(text);
           text=text.replace(/\r\n/g, '<br />');
            console.log(text);
          //  <span class="marker_1">ללחצים פוליטיים דרך מערכת המינויים. מצד שני, המדינה מממנת ישירות לא מעט גופים שנותרים עצמאיים בכל זאת, כמו בתי המשפט, מבקר המדינה, </span>
           var html =    $('#discussion_content').html();
            html=html.replace(text,'<span data-id="'+suggestion.id+'" class="marker_1">'+text+'</span>');
           $('#discussion_content').html(html);

        })
    }

    var mouseDown, mouseUp, top, left;
    var range_txt;
    $('#discussion_content')
            .on('mousedown', function (e) {mouseDown = e;})
            .on('keydown', function (e) {                if (!(e.shiftKey && (e.keyCode <= 40 && e.keyCode >= 37) || (e.ctrlKey && e.keyCode == 65))) e.preventDefault();})
            .on('dragstart', function (e) {                e.preventDefault();               })
            .on('mouseup',function (e) {


                e.stopPropagation();
                mouseUp = e;
                var err = false;

                left = Math.ceil((mouseDown.clientX + mouseUp.clientX) / 2 - 97);
                top = Math.min(mouseDown.clientY, mouseUp.clientY) - $(".popup-window").height() - 40 + $(window).scrollTop() + 40;

               // original = $('<div />').html(original).text();
//                if(window.getSelection){
                range_txt = window.getSelection().toString();
                    //range_txt=range.toString();//.replace(/\s{2,}/g, ' ')

//                }else if(document.getSelection){
//                    range = document.getSelection();
//                }else if(document.selection){
//                    range = document.selection.createRange();
//                }

                //////////////////  show pop up   /////////////////
                discoverRange (range_txt)  ;
                flag = false;
                $.each(suggestions_list, function (index, suggestion) {
                    if (        (suggestion.parts[0].start >= range.start && suggestion.parts[0].start <= range.end)
                            ||  (suggestion.parts[0].end >= range.start && suggestion.parts[0].end <= range.end)
                            ||  (range.start >= suggestion.parts[0].start && range.end  <= suggestion.parts[0].end )) {
                        flag = true;
                    }
                })
                if(flag) {
                    popupProvider.showOkPopup({message:"הטקסט סומן כבר בהצעה לשינוי קיימת"});
                }else if(range_txt.length >0){
                    $(".popup-window")
                            .css({ top:top, left:left, opacity:0 })
                            .show()
                            .animate({ top:'-=20px', opacity:1 }, 100, 'linear');
                } else{
                    $(".popup-window").hide();
                }
                //////////////////////////////////////////////////
                console.log(range_txt.length+'  '+range_txt);
            });

    function discoverRange(text){
        var t=text;
        if(original.indexOf(text)!=-1){//no linebreaks
            range.start= original.indexOf(text);
            range.end=  range.start+  text.length;
        }  else{//chrome
            t=text.replace(" \n","\n");
            if(original.indexOf(t)!=-1){
                range.start= original.indexOf(t);
                range.end=  range.start+  t.length;
            }else
            {
                t=text.replace(/\r/g,"");
                if(original.indexOf(t)!=-1){
                    range.start= original.indexOf(t);
                    range.end=  range.start+  t.length;
                }else
                {
                    range.start= 0;
                    range.end=  0;
                   console.log("error");
                }
            }
        }
        console.log("start="+range.start +" | end=" +range.end )    ;
    }


    $('body').mouseup(function(){
        $(".popup-window").hide();
    });


    // focus and copy the selected text of discussion
    $('#pop_post_bt').click( function (e) {
        e.preventDefault();
        e.stopPropagation();
        new_post_ref_id = null;
        $(".popup-window").hide();
        $("textarea#discussion_comment").val('"' + range_txt + '"');
        focusOnCommentBox();
    });

    $('#pop_suggest_bt').click( function (e) {
        e.stopPropagation();
        e.preventDefault();
        $('#discussion_content_txt').text('"' + range_txt + '"');
        $('#write-comment').show();
        $('textarea#discussion_suggest').focus();
        $('#reload-img').attr('src', $('#reload-img').attr('src'));
        $(".popup-window").hide();
    });
});


</script>
</body>
</html>
