<!DOCTYPE html>

<html>
<head>
    <%- partial('partials/head.ejs') %>
    <script src="/resources/js/jquery-fieldselection.js" type="text/javascript"></script>
</head>
<body>
<div id="wrap">
    <div id="header">
        <%-partial('partials/menu.ejs')%>
        <%-partial('partials/user_box.ejs')%>
        <%-partial('partials/failures.ejs')%>
        <%- partial('partials/tag_search.ejs') %>
    </div>
    <div id="content" class="cf">
        <div class="add-offer">
            <h2><span class="arrow">
נושא הדיון
            </span>
                <%=discussion.title%>
            </h2>
            <div class="text-box cf">
                <div  style="width: 212px;height: 164px" class='auto-scale floatRight'>
                  <img src="<%= discussion.image_field ? discussion.image_field.url : '' %>" alt="" />
                </div>
                <div class="discussion_content discussion content">
                    <textarea id="discussion_content" ><%=discussion.vision_text%></textarea>
                </div>

                <p><a href="">
                    קרא עוד
                </a></p>
            </div>
            <div class="add-offer-bottom cf">
                <div class="btn-box">
                    <a class="btn-green" id="discussion_comment_reply_button" href="#">
                        הגב
                    </a>
                    <a class="btn-grey" href="">
                        שתף
                    </a>
                    <div class="btns-grey">
                        <a href="">
                            הצעה לשינוי
                        </a>
                        <a href="">
                            היסטוריה
                        </a>
                    </div>
                </div>
                <div class="tags">
                    <a href="">
                        אבטלה
                    </a>
                    <a href="">
                        כלכלה
                    </a>
                    <a href="">
                        עוני
                    </a>
                    <div class="more">
                        <span></span>
                        <ul>
                            <li><a href="">
                                הצג עוד תגיות
                            </a></li>
                            <li><a href="">
                                הוסף תגית
                            </a></li>
                        </ul>
                    </div>
                </div>
                <div class="slide-box">
                    <div class="summary">
                        <input type="text" id="amount" value="6.20" />
                        <span> <%= discussion.evaluate_counter %> מדרגים</span>
                    </div>
                    <div class="slider">
                    </div>
                    <div class="slider-numbers">
                        <span>1</span>
                        <span>2</span>
                        <span>3</span>
                        <span>4</span>
                        <span>5</span>
                        <span>6</span>
                        <span>7</span>
                        <span>8</span>
                        <span>9</span>
                        <span>10</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-left">
            <h3><span>
עגלת המידע
            </span></h3>
            <div class="comment-slide">
                <a href="" id="prev" ></a>
                <a href="" id="next" ></a>
                <div class="slide-c">
                </div>
            </div>
        </div>
        <div id='write-comment' class="write-comment" style="display: none;">
            <h3>
                הצעה לשינוי
            </h3>
            <div class="text-box cf">
                <div class="left">
                    <p id='discussion_content_txt'> <strong>:רובין כתב</strong>
					
					</p>
                    <label>
                        ההצעה לשינוי שלי:
                    </label>
                    <textarea id='discussion_suggest' class="five-col" cols="0" rows="0"></textarea>
                    <label>
                        טיעונים, הצדקות ונימוקים:
                    </label>
                    <textarea id="discussion_explanation" class="two-col" cols="0" rows="0"></textarea>
                </div>
                <div class="user-right">
                    <div class="img-box" style="overflow: hidden;" >
                        <div style="width:70px; height:70px;" class='auto-scale'>
                         <img  src="<%=avatar%>" alt="<%=user.username%>"  />
                        </div>
                        <span></span>
                    </div>
                    <h4>אני</h4>
                    <div class="date">13.3.12</div>
                    <div class="proxy">
                        <span>3</span>
                    </div>
                    <div class="respect">
                        <span>20</span>
                    </div>
                </div>
            </div>
            <a class="grey-btn" id="cancelWriteCommentBT" href="#"><span>
מתחרט
            </span></a>
            <a  id="send_suggestion" class="green-btn" href="#">
                הצע
            </a>
        </div>
    </div>
</div>
<div class="system-notice">
    <div class="extra">
        <a class="close" href=""></a>
        <strong>
            הודעת מערכת:
        </strong>
        דיון זה מתעתד להיות מעגל תנופה. שתפו, הגיבו וגרמו לזה לקרות
    </div>
</div>
<div class="comments-box">
    <div class="extra cf">
        <select class="left-select">
            <option>
                מיין לפי תאריך
            </option>
            <option>
                מיין לפי יוזר
            </option>
            <option>
                מיין לפי תוצאות
            </option>
        </select>
        <h2>
            תגובות
            <small id="comments_number"></small></h2>
        <div id="comments">

            </div>
        <div class="write-comment">
            <h3>
                כתיבת תגובה
            </h3>
            <div class="text-box cf">
                <div class="left">
                    <textarea id="discussion_comment" class="four-col" cols="0" rows="0"></textarea>
                </div>
                <div class="user-right">
                    <div class="img-box" style="overflow: hidden;">
                        <div style="width:70px; height:70px;" class='auto-scale'>
                            <img  src="<%=avatar%>" alt="<%=user.username%>"  />
                        </div>
                        <span></span>
                    </div>
                    <h4>אני</h4>
                    <div class="date"><%=new Date() %></div>
                    <div class="proxy">
                        <span>3</span>
                    </div>
                    <div class="respect">
                        <span>20</span>
                    </div>
                </div>
            </div>
            <a class="green-btn" href="">עצה</a>
        </div>
    </div>
</div>
<!--<div class="add-offer">
<div class="text-box">
<span class="edit-text">-->
     <span class="popup-window">
         <span class="arrow"></span>
         <a class="close" href="#" ></a>
        	 <a class="green-btn" href="#">הגב</a>
         <a class="grey-btn suggest" href="#">
     הצע הצעה לשינוי
         </a>
     </span>
 <!--</span>
</div>
</div>
-->


<%- partial('partials/footer.ejs') %>
<script type="text/javascript">
    $(document).ready(function () {

        $(".inline").colorbox({ inline: true, width: "730" });


        $(".slider").slider({
            value: 5.0,
            min: 0,
            max: 10,
            step: 0.10,
            slide: function (event, ui) {
                $("#amount").val(ui.value);
            }
        });
        $("#amount").val($(".slider").slider("value"));
        $('.comments-box .comment-one .user-right').hover(function () {
            $(this).toggleClass('hover');
        });


        /***************************************************/


              function setCommentNumber(number) {
                 $('#comments_number')[0].innerHTML='('+number+')';
              }

            var discussion_id = "<%=discussion.id%>";
            var mouseDown, mouseUp, top, left;
            var grade_id = "<%=discussion.grade_obj.grade_id%>";
            var sugg_grade_id;

            db_functions.getDiscussionShoppingCart(discussion_id,function(err,data){
                $.each(data.objects,function(index,item){
                    dust.render('discussion_information_item',item,function(err,out){
                        $('.slide-c').append(out);
                    });
                });

                $('.slide-c')
                        .after('<div id="nav2">')
                        .cycle({
                            fx: 'scrollHorz',
                            speed: 'fast',
                            timeout: 0,
                            pager: '#nav2',
                            next: '#next',
                            prev: '#prev'
                        });

            });

        $('.discussion_content')
                    .on('mousedown', function(e) {
                        mouseDown = e;
                    })
                    .on('mouseup', function(e){
                        mouseUp = e;

                        left = Math.ceil((mouseDown.clientX + mouseUp.clientX) / 2 - ($(".popup-window").width() / 2));
                        top = Math.min(mouseDown.clientY, mouseUp.clientY) - $(".popup-window").height() - 20 + $(window).scrollTop();

                    }).on('keydown', function(e){
                        console.log(e.keyCode == 27);
                        if(!(e.shiftKey && (e.keyCode <=40 && e.keyCode >=37) || (e.ctrlKey && e.keyCode == 65))) e.preventDefault();
                    }).on('dragstart', function(e){
                        e.preventDefault();
                    });

            $('.popup-window .close').on('click', function(){
                $('.popup-window').hide();
            });

            $('.popup-window').on('focus', function(e){
                e.preventDefault();
            });

            $("#discussion_content").select(function(){
                range = $(this).getSelection();
                $(".popup-window")
                        .css({ top: top + 20, left: left, opacity: 0 })
                        .show()
                        .animate({ top: '-=20px', opacity: 1 }, 100, 'linear');

                console.log(range);
            });

            $("button.reply, .suggest").on("click", function(e){
                e.preventDefault();

                if($(this).hasClass("reply")){
                    $("textarea#discussion_comment").val('"' + range.text +'"').focus();
                }

                if($(this).hasClass("suggest")){
                    $('#discussion_content_txt').text('"' + range.text +'"');
                    $('#write-comment').show();
                    $('textarea#discussion_suggest').focus();
                    $(".popup-window").hide();
                }
            });

            $("#discussion_comment_reply_button").on('click', function(e){
                var commenText;
                var discussionComment=  $("textarea#discussion_comment")[0]  ;
               commenText= '"'+ $('#discussion_content')[0].value+'"';
                e.preventDefault();
                discussionComment.focus();
                discussionComment.value=commenText;
            });

            $('#posts,#suggestion_list').on('click','.vote_for',function(){
                var post_id = $(this).parent('div').data("id");
                var button = $(this);
                var func = $(this).parents('#posts').length ? db_functions.voteForPost : db_functions.voteForSuggestion;
                func.call(db_functions,post_id, "add", function(err, post_obj){
                    if(!err){
                        var span = $('span',button);
//                        span.text(Number(span.text()) + 1);
                        var vote_against = button.closest('div.action').find('a.vote_against');
                        vote_against.text(post_obj.votes_against);
                        button.text(post_obj.votes_for);
                    }
                    else
                    {
                        if(err.responseText == 'Error: there is not enought tokens')
                            alert('not enough tokens');
                        if(err.responseText == 'user already voted for this post')
                            alert('already voted');
                        if(err.responseText == 'soory, can\'t vote to your own suggestion')
                            alert('can\'t vote for your own suggestion');
                    }
                })
            });

            $('#posts,#suggestion_list').on('click',".vote_against", function(){
                var post_id = $(this).parent('div').data("id");
                var button = $(this);
                var func = $(this).parents('#posts').length ? db_functions.voteForPost : db_functions.voteForSuggestion;
                func.call(db_functions,post_id, "remove", function(err, post_obj){
                    if(!err){
                        var span = $('span',button);
                        var vote_for = button.closest('div.action').find('a.vote_for');
                        vote_for.text(post_obj.votes_for);
                        button.text(post_obj.votes_against);
                    }
                    else
                    {
                        if(err.responseText == 'Error: there is not enought tokens')
                            alert('not enough tokens');
                        if(err.responseText == 'user already voted for this post')
                            alert('already voted');
                        if(err.responseText == 'soory, can\'t vote to your own suggestion')
                            alert('can\'t vote for your own suggestion');

                    }

                })
            });

            $('#posts,#suggestion_list').on('click',".quote_button",function(){
                var text = $('.post_text',$(this).parents('li')).text();
                $("textarea#discussion_comment").val('"' + text +'"').focus();
            });

          /*  db_functions.getDiscussionShoppingCart(discussion_id, function(err, data){

                if(err){}
                else{
                    for (var i in data.objects){
                        //shopping_cart_items.add(data.objects[i]);
                    }
                }
            });

                */
            db_functions.getPostByDiscussion(discussion_id, function(err, data){
                if(err){
                    console.log(err);
                }else{
                    setCommentNumber( data.objects.length);
                    dust.renderArray('discussion_comment', data.objects, null, function(err, out){
                        if(!err){
                            $("#comments").append(out);
                           // $('#posts img').autoscale();
                        }
                    });
                }
            });
            /*

            function render_suggestion(suggestion)
            {
                if(suggestion.parts && suggestion.parts.length)
                {
                    var original = $('#discussion_content').val();



                    suggestion.original_part = function(){
                        var from = suggestion.parts[0].start;
                        var end = suggestion.parts[0].end;
                        return original.substr(from,end-from);
                    };

                    suggestion.alternative_part = function(){
                        return suggestion.parts[0].text;
                    };

                    dust.render('discussion_suggestion',suggestion,function(err,out)
                    {
                        $('#suggestion_list').append(out);
                    });
                }
                return null;
            }

            db_functions.getSuggestionByDiscussion(discussion_id,function(err,data)
            {
                $.each(data.objects,function(index,suggestion)
                {
                    render_suggestion(suggestion);
                });
            });*/

            $('#sorting_select').change(function() {
                $("#posts").empty();

                if ($(this).val() === 'op_date') {
                    db_functions.getPostByDiscussion(discussion_id, function(err, data){
                        if(err){
                            console.log(err);
                        }else{dust.renderArray('post', data.objects, null, function(err, out){
                            if(!err){
                                $("#posts").append(out);
                                $('#posts img').autoscale();
                            }
                        })
                        }
                    });
                }
                else{
                    if ($(this).val() === 'op_back_date') {
                        db_functions.getSortedPostByDiscussion(discussion_id, "order_by=creation_date", function(err, data){
                            if(err){
                                console.log(err);
                            }else{
                                dust.renderArray('post', data.objects, null, function(err, out){
                                    if(!err){
                                        $("#posts").append(out);
                                        $('#posts img').autoscale();
                                    }
                                })
                            }
                        });
                    }else{
                        if ($(this).val() === 'op_votes_for') {
                            db_functions.getSortedPostByDiscussion(discussion_id, "order_by=-votes_for", function(err, data){
                                if(err){
                                    console.log(err);
                                }else{
                                    dust.renderArray('post', data.objects, null, function(err, out){
                                        if(!err){
                                            $("#posts").append(out);
                                        }
                                    })
                                }
                            });

                        }else{
                            if ($(this).val() === 'op_most_voted') {
                                db_functions.getSortedPostByDiscussion(discussion_id, "order_by=-total_votes, -votes_for", function(err, data){
                                    if(err){
                                        console.log(err);
                                    }else{
                                        dust.renderArray('post', data.objects, null, function(err, out){
                                            if(!err){
                                                $("#posts").append(out);
                                            }
                                        })
                                    }
                                });
                            }
                        }
                    }
                }
            });

            $("#cancelWriteCommentBT").live("click", function(){
                $('#write-comment').hide();
            });

            $("#submit_post").on('click', function(e){
                db_functions.addPostToDiscussion(discussion_id, $("textarea#discussion_comment").val(), function(err, post){
                    $("#user_tokens").text(post.updated_user_tokens);
                    dust.render('post', post, function(err, out){
                        $("#posts").append(out);
                        $("textarea#discussion_comment").val('');

                    });
                })
            });

            $('form').on('submit', function(e){
                e.preventDefault();
            });


            $('#rating_button').click(function(){
                var rating = Number($('#rating_select').val());
                db_functions.addDiscussionGrade(discussion_id,rating, grade_id, function(err,data)
                {
                    $("#user_tokens").text(data.updated_user_tokens);
                    $("#current_grade").text(data.new_grade);
                    $("#current_graders").text(data.evaluate_counter);

                    $.each(data.suggestions, function(err, suggestion){
                        $("#" + suggestion._id + " .sugg_current_grade").text("suggestion grade:" + suggestion.grade);
                        $("#" + suggestion._id + " .sugg_current_graders").text("num of evaluates:" + suggestion.evaluators_counter);
                    })
                });
            });

//            $('.sugg_rating_button').click(function(){
            $('#suggestion_list').on('click','.sugg_rating_button',function(){
                var rating = Number($(this).parent().find($(".sugg_rating_select")).val());
                sugg_grade_id = $(this).parent().data('grade');

                var suggestion_id = $(this).parent().attr('id');
                var self = this;
                db_functions.addSuggestionGrade(suggestion_id, discussion_id,rating, sugg_grade_id, function(err,data)
                {
                    if(!err){
                        db_functions.getSuggestionByDiscussion(discussion_id, function(err, data){
                            $.each(data.objects,function(index,suggestion)
                            {
                                render_suggestion(suggestion);
                            });
                        })
                    }
                });
            });

            $('#suggest_button').click(function()
            {
                $('#suggest_div').show();
            });

            $('#close_suggest').click(function(){
                $('#suggest_div').hide();
                $("textarea#discussion_suggest").val('');
            });

            $('#send_suggestion').click(function(){
                var part = {start:range.start, end:range.end, text:$("textarea#discussion_suggest").val()};
                var explanation = $("#discussion_explanation").val();

                db_functions.addSuggestionToDiscussion(discussion_id,[part], explanation, function(err,data)
                {
                    if(!err)
                    {
                        $('#suggest_div').hide();
                        render_suggestion(data);
                        $("textarea#discussion_suggest").val('');
                        $("#user_tokens").text(data.updated_user_tokens);
                    }
                });
            });

    });
</script>
</body>
</html>
