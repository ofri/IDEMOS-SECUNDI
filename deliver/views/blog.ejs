<!DOCTYPE html>

<html>
<head>
    <%- partial('partials/head.ejs') %>
    <script src="/resources/js/jquery-fieldselection.js" type="text/javascript"></script>
</head>
<body>
<%- partial('partials/body_top.ejs') %>
<div id="wrap">
        <div id="header">
            <%-partial('partials/menu.ejs')%>
            <%-partial('partials/user_box.ejs')%>
            <%-partial('partials/failures.ejs')%>
            <%-partial('partials/tag_search.ejs') %>
        </div>
        <div id="content" class="cf">
            <h2><a class="arrow" href="">כותרת הבלוג</a> כותרת משנה כותרת משנה</h2>
            <div class="rightCol">
                <% for (var i = 0; i < articles.length && i < 8 ; i++) { %>
                        <div class="one-post" item_id="<%= articles[i].id %>" id="<%= articles[i].id %>">
                         <a href="/blogs/article/<%= articles[i].id %>">
                            <h3>
                                <%= articles[i].title %>
                             </h3>
                          </a>
                            <div class="date-post">
                                <%= articles[i].time.format('dd/mm/yy') %>
                            </div>
                            <img class="floatRight" src="images/post-1.jpg" alt="" />
                            <%= articles[i].text %>
                            <div class="bottom cf">
                                <div class="right">
                                    <div class="tags">
                                        <a class="like-btn" href=""><img src="images/like-btn.png" alt="" /></a>
                                     <% for (var c = 0; c <articles[i].tags.length; c++) { %>
                                           <a href="#"> <%=articles[i].tags[c] %></a>
                                     <% }%>

                                    </div>
                                </div>
                                 <% if (!isBlog) { %>
                                    <a href="#write-comment" class="btn-grey" href="">הגב</a>
                                 <% }%>
                            </div>
                            <div class="post-comment">
                                <h3>תגובות</h3>
                            </div>

                        </div>
                <% }%>

                     <% if (articles.length>8) { %>
                    <div class="nav-post">
                        <a href="">פוסטים קודמים</a> | <a href="">פוסטים הבאים</a>
                    </div>
                <% }%>
            </div>
            <div class="leftCol leftCol-width noPadding">
                <div class="profile-box">
                    <div class="profile-info cf">
                       <% if (blogger.avatar_url) { %>
                       <div class="img-box">
                            <img src="<%=blogger.avatar_url %> " alt="" />
                            <span></span>
                        </div>
                        <% } %>
                        <div class="left">
                            <h4><%=blogger.first_name %></h4>

                        <% if (blogger.blog_text_1) { %>        <p><%=blogger.blog_text_1 %></p>      <% } %>
                        <% if (blogger.blog_text_2) { %>        <p><%=blogger.blog_text_2 %></p>      <% } %>
                        <% if (blogger.blog_text_3) { %>        <p><%=blogger.blog_text_3 %></p>      <% } %>
                        </div>
                        <div class="badges cf">
                            <div class="proxy">
                                <span><%=blogger.num_of_proxies_i_represent %></span> מנדטים
                            </div>
                            <div class="respect">
                                <span><%=blogger.score %></span> מוניטין
                            </div>
                        </div>
                     </div>
                    <% if (blogger.biography) { %>        <p><%=blogger.biography %></p>      <% } %>

                    <div class="links">
                        <p><a href="">www.mywebsite.com</a></p>
                        <p><a href="">www.facebook.com/myname</a></p>
                    </div>

                    <div class="btns-box cf">
                        <a class="floatLeft" href="">RSS</a>
                        <a href="" class="floatRight">דואר</a>
                    </div>
                </div>
                <div class="left-search">
                    <form action="#">
                        <label>חיפוש</label>
                        <input type="text" value="" />
                        <input type="submit" value="שפח" />
                    </form>
                </div>
                <div class="left-tags">
                    <h3>תגיות</h3>
                    <div class="tags">
                        <% for (var i = 0; i < tags.length && i < 8 ; i++) { %>
                               <a href=""><%= tags[i].tag %></a>
                        <% }%>


                    </div>
                </div>
            </div>
        </div>

<% if (!isBlog) { %>
<a name="write-comment">       </a>
<div class="comments-box">
        <div class="extra cf">
            <div class="write-comment">
                <h3>
                    כתיבת תגובה
                </h3>

                <div class="text-box cf"
                <%if(user_logged){%> data-creator_id="<%=user._id%>" <%}%> >
                <div class="left">
                    <textarea id="article_comment" dir="rtl" class="four-col" cols="0" rows="0"></textarea>
                </div>
                <div class="user-right">
                    <div class="img-box" style="overflow: hidden;">
                        <div style="width:70px; height:70px;" class='auto-scale'>
                            <% if(user_logged) { %>
                            <img src="<%=avatar%>" alt="אני"/>
                            <% } %>
                        </div>
                        <span></span>
                    </div>
                    <h4>אני</h4>

                    <div class="date"><%=(new Date()).format('dd.mm.yy') %></div>
                    <% if(user_logged){ %>
                    <div class="proxy">
                        <span>3</span>
                    </div>
                    <div class="respect">
                        <span class="score"><%=user.score%></span>
                    </div>
                    <% } %>
                </div>
            </div>
            <a id="submit_post" class="green-btn" href="javascript:void(0);">
                פרסם
            </a>
        </div>
    </div>
        <% } %>
</div>

<%- partial('partials/footer.ejs') %>

<script type="text/javascript">

var current_section=3;
var bloggerId='<%=blogger ? blogger._id:'' %>';
var currentUserId='<%=user ? user._id:'' %>';
var isBlog=<%=isBlog %>;
<% if (!isBlog) { %>
var single_article_id  ='<%=articles[0]._id %>';
<% } %>
$(document).ready(function () {


    $.each($(".one-post"), function (index,item) {
              getComments  (item.id)  ;
    });
});

function getComments(article_id) {
    if(article_id)
    {
        db_functions.getArticleComments(article_id, function(err, data){
                var comments    =  isBlog?  data.objects.slice(0,2):data.objects;
                for (i = 0; i < comments.length; i++) {
                    //    comments[i].isFirst = (i === 0);
                    //    comments[i].isEven = ((i % 2)== 0);
                        comments[i].voting =      comments[i].votes_for - comments[i].votes_against;
                }
                dust.renderArray('article_comment', comments, null, function (err, out) {

                    $("#"+article_id+" .post-comment").append(out);
                });


        });
    }
}

 $("#submit_post").on('click', function (e) {
        e.preventDefault();
        db_functions.addArticleComment($("textarea#article_comment").val(),single_article_id , function (err, post) {
            // $("#user_tokens").text(post.updated_user_tokens);
            if (err==="success") {
              //  if (my_id)
              //      setUserScore(my_id, post.creator_id.score);
                post.voting = post.votes_for - post.votes_against;
                dust.render('article_comment', post, function (err, out) {
                    $("#"+single_article_id+" .post-comment").append(out);
                    $("textarea#article_comment").val('');
                });
            }
        })
    });

      $('#comments').on('click', '.vote_for', function () {
          vote.apply($(this),['add']);

      });

      $('#comments').on('click', ".vote_against", function () {
          vote.apply($(this),['remove']);

      });
      function vote(actionType){
              var post_id = $(this).parents('.comment-one').data("id");
              var button = $(this);
              var func = $(this).parents('#comments').length ? db_functions.voteForPost : db_functions.voteForSuggestion;
              func.call(db_functions, post_id, actionType,
              db_functions.voteOnArticleComment(   post_id,function (err, post_obj)
              {
                  if (!err) {

                         button.parents(".ratio").find(".count").text(Math.round(post_obj.votes_for-post_obj.votes_against ));
                         var down_arrow = button.parents(".ratio").find(".down");
                         var up_arrow =button.parents(".ratio").find(".up");
                         down_arrow.removeClass("balance0").removeClass("balance1").removeClass("balance2").removeClass("balance3").removeClass("balance-1").removeClass("balance-2").removeClass("balance-3").addClass("balance"+post_obj.voter_balance);
                         up_arrow.removeClass("balance0").removeClass("balance1").removeClass("balance2").removeClass("balance3").removeClass("balance-1").removeClass("balance-2").removeClass("balance-3").addClass("balance"+post_obj.voter_balance);
                  }
                  else {
                      if (err.responseText == 'Error: there is not enought tokens')
                          popupProvider.showOkPopup( {massage:     'אין לך מספיק טוקנים'});
                      if (err.responseText == 'user already voted for this post')
                          popupProvider.showOkPopup( {massage:     'באפשרותך לתת עד שלושה אסימונים לתגובה בדיון'});
                      if (err.responseText == 'soory, can\'t vote to your own post')
                          popupProvider.showOkPopup( {massage:     'מצטערים, לא ניתן להצביע לתגובה של עצמך'});
                  }
              })
      }

 </script>
</body>
</html>
