<!DOCTYPE html>

<html>
<head>
    <% include partials/head.ejs %>
    <meta property="fb:admins" content="1096517123,569038621,775273695"/>
    <meta property="fb:app_id" content="375874372423704"/>
    <script src="/resources/js/jquery-fieldselection.js" type="text/javascript"></script>
</head>
<body>
<% include partials/body_top.ejs %>
<div id="wrap">
        <div id="header">
            <% include partials/menu.ejs %>
            <% include partials/user_box.ejs %>
            <% include partials/failures.ejs %>
            <% include partials/tag_search.ejs %>
        </div>
        <div id="content" class="cf">
            <h2><a class="arrow no_underline" href="/blogs/<%=blogger._id%>"><%= blogger.blog_title || ""%> </a> <%= blogger.blog_sub_titile || ""%></h2>
            <div class="rightCol" id="articles" >
                <% for (var i = 0; i < articles.length && i < 8 ; i++) { %>
                       <div class="one-post" item_id="<%= articles[i].id %>" id="<%= articles[i].id %>">
                         <a href="/blogs/article/<%= articles[i].id %>">
                            <h3>
                                <%= articles[i].title %>
                             </h3>
                          </a>
                            <div class="date-post">
                                <%= articles[i].time.format('dd/mm/yy') %>
                            </div>
                             <div class="img-box floatRight" style="overflow: hidden;">
                                <div style="width:253px; height:168px; overflow:hidden; " class='auto-scale' >
                                       <img style="margin: 3px 0 5px 25px;" src="<%=articles[i].image_field ? articles[i].image_field.url ||'' : '' %>" alt=""/>
                          <!--         <img class="floatRight" src="http://uru.s3.amazonaws.com/wind_755.jpg" alt="" />   -->
                                    <br>
                                </div>
                                <span></span>
                            </div>

                                <p><%-articles[i].text%></p>

                            <div class="bottom cf">
                                <div class="right">
                                    <div class="tags">


                                     <% for (var c = 0; c <articles[i].tags.length; c++) { %>
                                           <a class="tag-search" href="/blogs/article/?tag_name=<%= articles[i].tags[c]%>""><%=articles[i].tags[c] %></a>
                                     <% }%>

                                        <!--<a class="like-btn gray_and_soon" href=""><img src="images/like-btn.png" alt="" /></a>-->


                                    </div>

                                </div>

                           <% if (!isBlog) { %>
                                    <a href="#write-comment" class="btn-grey" href="">הגב</a>
                                 <% }%>

                                <div class="like-btn fb-like"
                                <% if (!isBlog) { %>
                                data-href="http://www.uru.org.il/blogs/article/<%= articles[i]._id %>"
                                <% }else{%>
                                data-href="http://www.uru.org.il/blogs/<%= articles[0].user_id %>"
                                <% }%>
                                data-send="false" data-width="450" data-show-faces="true">
                            </div>

                       </div>
                            <div class="post-comment">
                                <div class="fb-comments"
                                <% if (!isBlog) { %>
                                data-href="http://www.uru.org.il/blogs/article/<%= articles[i]._id %>"
                                <% }else{%>
                                data-href="http://www.uru.org.il/blogs/<%= articles[0].user_id %>"
                                <% }%>
                                     data-num-posts="3" data-width="570">
                            </div>

                                <h3>תגובות</h3>
                            </div>

                        </div>
                <% }%>

                     <% if (articles.length>8) { %>
                    <div class="nav-post">
                        <a href="">פוסטים קודמים</a> | <a href="">פוסטים הבאים</a>
                    </div>
                <% }%>
            </div>
            <div class="leftCol leftCol-width noPadding">
                <div class="profile-box">
                    <div class="profile-info cf">
                        <%if (blogger.avatar_url) { %>
                        <a href="/myuru/<%=blogger._id%>">
                           <div class="img-box">
                                <img width="112" height="120" src="<%=blogger.avatar_url() %> " alt="" />
                                <span></span>
                            </div>
                        </a>

                        <% } %>
                        <div class="left">
                            <h4><%=blogger.first_name %> <%=blogger.last_name %></h4>

                        <p>
                            <!--<a class="no_underline_cursor_when_hover" href='<% if (blogger.blog_text_2) { %>       <%=blogger.blog_text_2 %>     <% } %>'><% if (blogger.blog_text_1) { %>       <%=blogger.blog_text_1 %>     <% } %>&nbsp;</a>-->
                            <%- blogger.blog_text_2 %>

                        </p>
                        <p>&nbsp;</p>

                        <p><% if (blogger.blog_text_3) { %>        <%=blogger.blog_text_3 %>      <% } %>&nbsp;</p>
                        </div>
                        <div class="badges cf">
                            <div class="proxy">
                                <span><%=blogger.num_of_proxies_i_represent %> </span>
                                מנדטים
                            </div>
                            <div class="respect">
                                <span><%=blogger.score %></span> מוניטין
                            </div>
                        </div>
                     </div>


                    <!--<div class="links">-->
                        <!--<p><a href="">www.mywebsite.com</a></p>-->
                        <!--<p><a href="">www.facebook.com/myname</a></p>-->
                    <!--</div>-->

                    <% if (blogger.biography) { %>
                    <p><%=blogger.biography %></p>
                    <% } %>

                    <% if (user) { %>
         	    	<div class="email-registration btns-box cf">
                         <form id="email-signup" name="email-signup">
                             <input type="email" name="email" class="floatLeft" placeholder="הרשם לעדכונים בדואר"> </input>
                             <a class="mail-subscription floatRight" data-put-url="/api/follow_blog_by_mail/<%=user._id%>" href="javascript:void(0)">
                                 הרשמה במייל
                             </a>
                             <a href="/api/articles/?user_id=<%=blogger._id%>&rss=true" class="rss_bt">

                             </a>
                         </form>
                    </div>

                    <div class="btns-box cf">
                        <a class="subscribe" data-not-follow-text="הפסק לעקוב" data-follow-text="הרשם לבלוג" data-put-url="/api/follow_blog/<%=user._id%>" href="javascript:void(0)" title="עקוב אחרי הבלוג באמצעות הפיד באתר עורו">
                            <% if (articles[0].is_blog_follower) { %>     הפסק לעקוב      <% } else {%> הרשם לבלוג <% } %>
                        </a>
                    </div>
                    <% } %>


                    <!--<div class="btns-box cf">-->
                        <!--<% if (blogger) { %>-->
                            <!--<a class="floatLeft" href="/api/articles/?user_id=<%=blogger._id%>&rss=true ">RSS</a>-->
                        <!--<% } else {%>-->
                            <!--<a class="floatLeft" href="javascript:void(0);">RSS</a>-->
                        <!--<% } %>-->
                        <!--<a href="javascript:void(0);" class="floatRight gray_and_soon">דואר</a>-->
                    <!--</div>-->
                </div>
                <div class="left-search">
                    <form class="bolg-search"  action="#">
                        <label>
                           חיפוש בבלוג של
                            <%=blogger.first_name %>
                        </label>
                        <input class="search_term" type="text" value="" />
                        <input type="submit" value="חפש" />
                    </form>
                </div>
                <div class="left-tags">
                    <h3>תגיות</h3>
                    <div class="tags">
                        <% for (var i = 0; i < tags.length ; i++) { %>
                               <a class="tag-search" href="javascript:void(0);"><%= tags[i].tag %></a>
                        <% }%>
                    </div>
                </div>
                <div style="background-color: white;" class="fb-recommendations" data-site="uru.org.il" data-app-id="375874372423704" data-width="300" data-height="300" data-header="true" data-border-color="white"></div>
            </div>
        </div>

<% if (!isBlog) { %>
<a name="write-comment">       </a>
<div class="comments-box">
        <div class="extra cf">
            <div class="write-comment">
                <h3>
                    כתיבת תגובה
                </h3>

                <div class="text-box cf"
                <%if(user_logged){%> data-creator_id="<%=user._id%>" <%}%> >
                <div class="left">
                    <textarea id="article_comment" dir="rtl" class="four-col" cols="0" rows="0"></textarea>
                </div>
                <div class="user-right">
                    <div class="img-box" style="overflow: hidden;">
                        <div style="width:70px; height:70px;" class='auto-scale'>
                            <% if(user_logged) { %>
                            <img src="<%=avatar%>" alt="אני"/>
                            <% } %>
                        </div>
                        <span></span>
                    </div>
                    <h4>אני</h4>

                    <div class="date"><%=(new Date()).format('dd.mm.yy') %></div>
                    <% if(user_logged){ %>
                    <div class="proxy">
                        <span>3</span>
                    </div>
                    <div class="respect">
                        <span class="score"><%=user.score%></span>
                    </div>
                    <% } %>
                </div>
            </div>
            <a id="submit_post" class="green-btn" href="javascript:void(0);">
                פרסם
            </a>
        </div>
</div>
        <% } %>
</div>
</div>
<% include partials/footer.ejs %>

<script type="text/javascript">

var current_section=4;
var bloggerId='<%=blogger ? blogger._id:'' %>';
var currentUserId='<%=user ? user._id:'' %>';
var isBlog=<%=isBlog %>;
<% if (!isBlog) { %>
var single_article_id  ='<%=articles[0]._id %>';
<% } %>

$(document).ready(function () {
    $.each($(".one-post"), function (index,item) {
              getComments  (item.id)  ;
    });
});

function getComments(article_id) {
    if(article_id)
    {
        db_functions.getArticleComments(article_id, function(err, data){
                var comments    =  isBlog?  data.objects.slice(0,2):data.objects;
                for (i = 0; i < comments.length; i++) {
                    //    comments[i].isFirst = (i === 0);
                    //    comments[i].isEven = ((i % 2)== 0);
                        comments[i].voting =      comments[i].votes_for - comments[i].votes_against;
                        comments[i].isBalancePositive =( comments[i].balance>0);
                        comments[i].isBalanceNegative =( comments[i].balance<0);
                }
                dust.renderArray('article_comment', comments, null, function (err, out) {

                    $("#"+article_id+" .post-comment").append(out);
                });


        });
    }
}

$("#submit_post").on('click', function (e) {
        e.preventDefault();
        db_functions.addArticleComment($("textarea#article_comment").val(),single_article_id , function (err, post) {
            // $("#user_tokens").text(post.updated_user_tokens);
            if (err==="success") {
              //  if (my_id)
              //      setUserScore(my_id, post.creator_id.score);
                post.voting = post.votes_for - post.votes_against;
                dust.render('article_comment', post, function (err, out) {
                    $("#"+single_article_id+" .post-comment").append(out);
                    $("textarea#article_comment").val('');
                });
            }
        })
    });


     $('.vote_for').live("click", function(event){
        vote.apply($(this),['add']);
      });
      $('.vote_against').live('click', function (e) {
          vote.apply($(this),['remove']);

      });
      function vote(actionType){
              var post_id = $(this).parents('.one').data("id");
              var button = $(this);
              // var func = $(this).parents('#comments').length ? db_functions.voteForPost : db_functions.voteForSuggestion;

              var user_info = {
                  user_logged_in : user.first_name ? true : false,
                  action_done : (user.actions_done_by_user && user.actions_done_by_user.vote_on_object) ? true : false,
                  action_name : "vote_on_object",
                  tokens_owned : user.tokens ? user.tokens : 0
              }
              db_functions.voteOnArticleComment( post_id,actionType, user_info, function (err, post_obj)
              {
                  if (err==="success") {

                      if(!user.actions_done_by_user.vote_on_object)
                      {
                          user.actions_done_by_user.vote_on_object = true;
                      }

                         button.parents(".ratio").find(".count").text(Math.round(post_obj.votes_for-post_obj.votes_against ));
                         var down_arrow = button.parents(".ratio").find(".down");
                         var up_arrow =button.parents(".ratio").find(".up");
                          down_arrow.removeClass("balance-negative");
                          up_arrow.removeClass("balance-positive");
                          if(post_obj.balance>0){
                              up_arrow.addClass("balance-positive");
                          }
                          if(post_obj.balance<0){
                              down_arrow.addClass("balance-negative");
                          }


                  }
                  else {
                      if (err.responseText == 'Error: there is not enought tokens')
                          popupProvider.showOkPopup( {message:     'אין לך מספיק אסימונים'});
                      if (err.responseText == 'soory, can\'t vote to your own post')
                          popupProvider.showOkPopup( {message:     'מצטערים, לא ניתן להצביע לתגובה של עצמך'});
                  }
              })
      }

    $('.bolg-search').live("submit",function () {
       searchTerm = $(this).find(".search_term").val();
       db_functions.getUserArticlesByKeywords(bloggerId, searchTerm, null, function(err, data){
           $.each(data.objects, function (index,item) {
                 item.text=item.text.replace(searchTerm,'<span class="highlight">'+searchTerm+'</span>' )
          });
          $("#articles").empty()
          dust.renderArray('blog_article', data.objects, null, function (err, out) {

              $("#articles").append(out);
               $.each(data.objects, function (index,item) {
                            getComments  (item._id)  ;
                  });
          });
       });
       return false;

    });

    var errors = 0;



    $('.email-registration a').click(function(){
        $('#email-signup').validate({
            errorElement: "p",

            rules:{
                email:{
                    required: true
                }
            },
            messages:{
                email:{
                    required:'נא להזין כתובת מייל',
                    email:'אנא בידקו את כתובת המייל שהוזנה'
                }
            },
            highlight: function (element, errorClass) {
                $(element).addClass('error').removeClass('valid');
            },
            unhighlight: function (element, errorClass) {
                $(element).removeClass('error').addClass('valid');
            },

            invalidHandler: function(form, validator) {
                errors = validator.numberOfInvalids();
            },
            submitHandler:function(form){
                if ($("#email-signup").valid()) {
                    ajaxSubmit($('.mail-subscription'));
                }
            }
        });


        $('#email-signup').submit();
    });

    var ajaxSubmit = function (button) {
		var originalButtonText = button.text();
        button.text('...');

        $.ajax({
            type: 'PUT',
            url: button.data('put-url'),
            data: {blog_id: bloggerId, mail: $('.email-registration input').val()},
            success: function (result) {
                var text = result.is_follower ? button.data('not-follow-text') : button.data('follow-text');
				button.text(text || originalButtonText);
            }
        });

    };
    $('a.subscribe').click(function(){
        event.preventDefault();
        var button = $(this);
        ajaxSubmit(button);
    });

 </script>
</body>
</html>
