<!DOCTYPE html>

<html>
<head>
    <% include partials/head.ejs %>
    <script src="/resources/js/jquery-fieldselection.js" type="text/javascript"></script>
</head>
<body>
<% include partials/body_top.ejs %>
<div id="wrap">
        <div id="header">
            <% include partials/menu.ejs %>
            <% include partials/user_box.ejs %>
            <% include partials/failures.ejs %>
            <% include partials/tag_search.ejs %>
        </div>


        <div id="content" class="cf">
            <div class="right-add-offer">
                <div id="cycle" class="add-offer add-offer-small">
                    <h2><span class="arrow"> <%= cycle.subject_name %></span> <%= cycle.title %></h2>
                    <div class="text-box cf">
                    <div class="cycle-content">
                    <% if (cycle.image_field) { %>

                      <div class="img-box floatRight" style="overflow: hidden;">
                                <div style="width:260px; height:190px;" class='auto-scale'>
                                      <img src="<%=cycle.image_field.url %>" alt=""/>

                                </div>
                                <span></span>
                            </div>
                    <% } %>
                        <h3><%- cycle.discussion_title %></h3>
                        <p> <%- cycle.text_field %>   </p>
                        </div>
                        <p id="read_more"> <a href="javascript:void(0);"> קרא עוד </a> </p> </div>
                    <div class="add-offer-bottom cf">
                        <div class="right">
                            <div class="tags">
                            <!--
                                <div class="info">
                                    <span class="talks">33</span>
                                    <span class="watched">151</span>
                                </div>
                                -->
                                <% if (cycle.tags) for (var c = 0; c<cycle.tags.length; c++) { %>
                                      <a href="?tag_name=<%=cycle.tags[c]%>"> <%=cycle.tags[c] %></a>
                                <% }%>
                            </div>
                        </div>
                         <a class="fraction-btn share" data-title="<%= cycle.title %>" data-text_preview="<%= cycle.text_field %>" data-img_src="<%= cycle.image_field.url %>" rel="/cycles/<%= cycle.id %>" href="/facebookShare?link=/cycles/<%= cycle.id %>" target="_blank">שתף</a>

                    </div>
                </div>
                <div class="popular-comments cf">
                    <div class="top">
                        <a href=""><span></span>  תגובות פופולריות</a>
                    </div>
                    <div class="hide-box">

                    </div>
                </div>
            </div>
            <div class="card-left">
                <h3><span>עגלת המידע</span></h3>
                <div class="comment-slide">
                    <a href="" id="prev" ></a>
                    <a href="" id="next" ></a>
                    <div class="slide-c"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="blue-bar">
        <div class="extra">
            <a class="green-btn" href="">עקוב אחרי מעגל התנופה</a>
            <p>מספר העוקבים אחרי מעגל תנופה זה: <strong>12,876</strong></p>
        </div>
    </div>
    <div class="followers-box">
        <div class="extra">
            <h2><span>טיימליין</span> 2012</h2>
            <div class="followers-diagram">
                <div style="left: 0px" class="event event-prev">
                    <div class="icon prev-icon">
                        <span class="i"></span>
                    </div>
                    <span class="number">
                        2.2
                    </span>
                    <span class="text">
                        יצירת דיון
                    </span>
                </div>
                <div style="left: 600px" class="event event-plus">
                    <div class="icon plus-icon">
                        <span class="i"></span>
                    </div>
                    <span class="number">
                        2.2
                    </span>
                    <span class="text">
                        יצירת דיון
                    </span>
                </div>
                <div style="left: 750px" class="event event-triangle">
                    <div class="icon triangle-icon">
                        <span class="i"></span>
                    </div>
                    <span class="number">
                        8.3
                    </span>
                    <span class="text">
                        היום
                    </span>
                </div>
                <div style="left: 150px" class="event">
                    <div class="icon green-icon">
                        <span class="i"></span>
                        <div class="popup-event type-one">
                            <div class="popup-text">
                                <h4>הפגנה למען הקיפודים</h4>
                                <p>אחד העם 19</p>
                                <p>תל אביב</p><br />
                                <p>20:00</p>
                                <a class="join-btn" href="">הצטרף</a>
                            </div>
                        </div>
                    </div>
                    <span class="number">
                        4.4
                    </span>
                    <span class="text">
                        דיון פתוח
                    </span>
                </div>
                <div style="left: 300px" class="event">
                    <div class="icon blue-icon">
                        <span class="i"></span>
                        <div class="popup-event type-two">
                            <div class="popup-text">
                                <img src="images/sample-7.jpg" width="112" class="floatRight" alt="" />
                                <h5>אירוע חשוב מאוד</h5>
                                <p>הרצאה יוצאת מן הכלל מפי פרופ’ כהן אחד העם 91, תל אביב</p>
                            </div>
                        </div>
                    </div>
                    <span class="number">
                        4.4
                    </span>
                    <span class="text">
                        דיון פתוח
                    </span>
                </div>
                <div style="left: 450px" class="event">
                    <div class="icon grey-icon">
                        <span class="i"></span>
                        <div class="popup-event type-three">
                            <div class="popup-text">
                                <h3>פברואר</h3>
                                <ul class="">
                                    <li><strong>2.2</strong> - יצירת דיון</li>
                                    <li><strong>8.2</strong> - הפגנה</li>
                                    <li><strong>2.2</strong> - דיון</li>
                                    <li><strong>2.2</strong> - יצירת דיון</li>
                                    <li><strong>8.2</strong> - הפגנה</li>
                                    <li><strong>2.2</strong> - דיון</li>
                                    <li><strong>2.2</strong> - יצירת דיון</li>
                                    <li><strong>8.2</strong> - הפגנה</li>
                                    <li><strong>2.2</strong> - דיון</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <span class="number">
                        4.4
                    </span>
                    <span class="text">
                        דיון פתוח
                    </span>
                </div>
                <div style="left: 100%" class="event event-next">
                    <div class="icon next-icon">
                        <span class="i"></span>
                    </div>
                    <span class="number">
                        15.4
                    </span>
                    <span class="text">
                        תאריך יעד
                    </span>
                </div>
            </div>
            <div class="btn-box">
                <a href="">+ הצע פעולה חדשה</a>
            </div>
        </div>
    </div>
    <div class="comments-box">
        <div class="extra cf">
            <div class="updates-box cf">
                <div class="right">
                    <h2>עדכונים</h2>
                    <div class="updates">
                    </div>
                </div>
                <div class="left">
                    <h2>פעולות הממתינות לאישור</h2>
                    <div class="anticipation-box">

                        <a href="" class="btn">הראה לי את כולן</a>
                    </div>
                </div>
            </div>
            <div class="blog-box cf">
                <h2>מובילי דעת קהל</h2>


                     <% if (cycle.opinion_shapers) for (var c = 0; c<cycle.opinion_shapers.length && c<3 ; c++) { %>
                             <div class="one <% if (c==2) {%>last<% }%> ">



                              <div class="img-box" style="overflow: hidden;">
                                 <div style="width:112px;height:120px; overflow:hidden; " class='auto-scale' >
                                     <img  src="http://profile.ak.fbcdn.net/hprofile-ak-snc4/49136_745621901_4865704_n.jpg" alt=""/>
                                     <span class="fillter"></span>
                                 </div>
                                 <span></span>
                             </div>


                                                 <h4><a href=""><%=cycle.opinion_shapers[c].first_name %> <%=cycle.opinion_shapers[c].last_name %></a></h4>
                                                <p><% if (cycle.opinion_shapers[c].opinion_text) {%>  <%=cycle.opinion_shapers[c].opinion_text %>  <% } %></p>
                                                 <div class="badges">
                                                     <div class="proxy">
                                                         <span><%=cycle.opinion_shapers[c].num_of_proxies_i_represent %></span>
                                                     </div>
                                                     <div class="respect">
                                                         <span><%=cycle.opinion_shapers[c].score %></span>
                                                     </div>
                                                 </div>
                                             </div>
                     <% }%>




            </div>
            <div class="followers-ppl cf" id="followers">
                <h2>עוקבים</h2>



            </div>
        </div>
    </div>


<% include partials/footer.ejs %>

<script type="text/javascript">
    $(document).ready(function () {
            var cycle_id = "<%=cycle.id%>";
            $(".inline").colorbox({ inline: true, width: "730" });

            $('.popular-comments .user-right').hover(function () {
                $(this).toggleClass('hover');
            });
            $('.comments-box .comment-one .user-right').hover(function () {
                $(this).toggleClass('hover');
            });
            $('.popular-comments .top a').click(function () {
                $(this).parents('.popular-comments').find('.hide-box').slideToggle();
                $(this).parents('.popular-comments').toggleClass('hover');
                return false;
            });


            db_functions.getCycleShoppingCart(cycle_id, function (err, data) {

                    $.each(data.objects, function (index, item) {
                        dust.render('discussion_information_item', item, function (err, out) {
                            $('.slide-c').append(out);
                        });


                    });

                    $('.slide-c')
                       .after('<div id="nav2">')
                       .cycle({
                           fx: 'turnDown',
                           speed: 'fast',
                           timeout: 0,
                           pager: '#nav2',
                           next: '#next',
                           prev: '#prev'
                       });
                    if (data.objects.length < 2) {
                        $("#prev").hide();
                        $("#next").hide();
                    }

            });

            db_functions.getCycleUpdates(cycle_id, function (err, data) {

                        $.each(data.objects, function (index, item) {
                            item.text_field = item.text_field.trim().substring(0, 300).split(" ").slice(0, -1).join(" ") + "... ";
                        });
                        dust.renderArray('cycle_update', data.objects, function (err, out) {
                            $('.updates').append(out);

                        });
           });

            db_functions.getPendingActionsByCycle(cycle_id, function ( data,err) {

                    dust.renderArray('cycle_pending_action', data.objects, function (err, out) {
                        $('.anticipation-box').prepend(out);

                    });
           });





           	var killScroll = false;
           	var followersPage=0;
           	getFollowers();

            function   getFollowers()
            {

                 db_functions.getCylceFollowers(cycle_id, followersPage,function (err, data) {
                    followersPage++;
                   if(data.meta.total_count<14) {
                         killScroll = true;
                     }
                    dust.renderArray('cycle_follower', data.objects, function (err, out) {
                        $('#followers').append(out);

                    });
                });
            }
            	// Detect that we are at bottom of page, and call autoloading function
            $(window).scroll(function(){
                if  ($(window).scrollTop()+100 >= ($(document).height() - ($(window).height()))){
                    if (killScroll == false) { // - Keeps the loader from fetching more than once.
                        //killScroll = true; // - Set killScroll to true, to make sure we do not trigger this code again before it's done running.
                         getFollowers();
                    }
                }
            });

            $('#read_more').click(function () {
                $(".cycle-content").height("auto");
                 $(this).hide();
            });

            $('.hide-box').on('mouseenter', ".side_menu",
                        function (e) {
                            $(this).addClass('hover');
                            $('.left', this).show().css({width:0}).animate({'width':87});

                        }).on('mouseleave', ".side_menu", function (e) {
                            var side = $(this);
                            side.removeClass('hover');
                            $('.left', this).animate({'width':0}, function () {
                                $(this).hide();
                            });
             });

             db_functions.getCyclePosts(cycle_id, function (err, data) {

                               for (i = 0; i < data.objects.length; i++) {
                                   data.objects[i].isFirst = (i === 0);

                                   data.objects[i].isEven = ((i % 2)== 0);
                                   data.objects[i].voting =      data.objects[i].votes_for - data.objects[i].votes_against;
                               }
                              dust.renderArray('cycle_post', data.objects, function (err, out) {
                                  $('.hide-box').append(out);
                              });
                       });
              $('.hide-box').on('click', '.vote_for', function () {
                     vote.apply($(this),['add']);

             });

             $('.hide-box').on('click', ".vote_against", function () {
                 vote.apply($(this),['remove']);

             });


        function vote(actionType){
            var post_id = $(this).parents('.one').data("id");
            var button = $(this);

            db_functions.voteForPost(post_id, actionType, function (err, post_obj) {
                if (!err) {

                       button.parents(".ratio").find(".count").text(Math.round(post_obj.votes_for-post_obj.votes_against ));
                       var down_arrow = button.parents(".ratio").find(".down");
                       var up_arrow =button.parents(".ratio").find(".up");
                       down_arrow.removeClass("balance0").removeClass("balance1").removeClass("balance2").removeClass("balance3").removeClass("balance-1").removeClass("balance-2").removeClass("balance-3").addClass("balance"+post_obj.voter_balance);
                       up_arrow.removeClass("balance0").removeClass("balance1").removeClass("balance2").removeClass("balance3").removeClass("balance-1").removeClass("balance-2").removeClass("balance-3").addClass("balance"+post_obj.voter_balance);
                }
                else {
                    if (err.responseText == 'Error: there is not enought tokens')
                        popupProvider.showOkPopup( {message:     'אין לך מספיק אסימונים'});
                    if (err.responseText == 'user already voted for this post')
                        popupProvider.showOkPopup( {message:     'באפשרותך לתת עד שלושה אסימונים לתגובה בדיון'});
                    if (err.responseText == 'soory, can\'t vote to your own post')
                        popupProvider.showOkPopup( {message:     'מצטערים, לא ניתן להצביע לתגובה של עצמך'});
                }
            })
        }


});
</script>
</body>
</html>
