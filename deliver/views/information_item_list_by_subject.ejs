<!DOCTYPE html>

<html>
<head>

  <%- partial('partials/head.ejs') %>

</head>
<body>
<%- partial('partials/body_top.ejs') %>
<div id="wrap">
<div id="header">
    <%-partial('partials/menu.ejs')%>
    <%-partial('partials/user_box.ejs')%>
    <%-partial('partials/failures.ejs')%>
    <%-partial('partials/tag_search.ejs') %>
</div>
<div id="content" class="cf">
<div class="rightCol">
    <select class="left-select left-select-inner">
        <option>מיין לפי יוזר</option>
        <option>מיין לפי תוצאות</option>
        <option>מיין לפי כמות דיונים</option>
    </select>
    <h2>
        <a href="/information_items/subject/<%= subject.id %>"><%= subject.name %></a>  <% if(tag_name) { %> <a class="last_breadcrum" href="/information_items/subject/<%= subject.id %>?tag_name=<%= tag_name %>"><%= tag_name %></a><% } %>
    </h2>
    <div class="main-text" id="info_items"></div>
</div>
<%- partial('partials/shopping_cart.ejs') %>
</div>
</div>
<%- partial('partials/footer.ejs') %>
  <script type="text/javascript">
        $(document).ready(function () {

            var subject_id = "<%= subject.id%>";
            var tag_name = "<%=tag_name || ''%>";
            current_section=0;
            db_functions.getInfoItemsOfSubjectByKeywords(tag_name,subject_id,function(err,data)
            {
                  dust.renderArray('information_item', data.objects,null,function(err,out)
                  {
                      $('#info_items').append(out);
                  });
                  //add notices to each item
                   $.each(data.objects,function(index,information_item){
                        $.each(information_item.discussions,function(index,discussion){
                                discussion.section="דיון";
                               dust.render('information_item_notice',discussion,function(err,out)
                               {
                                   $("#notices_"+information_item._id).append(out);
                               });
                        } );
                        $.each(information_item.cycles,function(index,cycle){
                               cycle.section="מעגל תנופה";
                               dust.render('information_item_notice',cycle,function(err,out)
                               {
                                   $("#notices_"+information_item._id).append(out);
                               });

                        } );
                        $.each(information_item.actions,function(index,action){
                               action.section="פעולה";
                               dust.render('information_item_notice',action,function(err,out)
                               {
                                   $("#notices_"+information_item._id).append(out);
                               });
                        } );

                   } );

                  // add shopping cart and remove 'add' button
                  db_functions.getUserShopingCart(function(err,data)
                  {
                        $.each(data.objects,function(index,information_item)
                        {
                            dust.render('information_item_box',information_item,function(err,out)
                            {
                                $(".card-products-left").append(out);
                            });
                            $("#add_button_"+information_item._id).hide();
                        });
                  });


            });

        $('.delete-app').live("click",removeItemFromCart);
        $('.delete').live("click",removeItemFromCart);

        function removeItemFromCart()
        {
              var item_id = $(this).attr('item_id');
              db_functions.removeInfoItemFromShoppingCart(item_id,function(err,data) {
                    $('#'+item_id).remove();
              });
               $("#add_button_"+item_id).show();

               return false  ;
        }
        $(".add_button").live("click", function(){
            var item_id=$(this).attr('add_item_id');
            db_functions.addInfoItemToShoppingCart(item_id, function(err, information_item){
                if(!err){
                   dust.render('information_item_box',information_item,function(err,out)
                   {
                       $(".card-products-left").append(out);
                   });
                   $("#add_button_"+item_id).hide();
                }
            });
        });




            $(".inline").colorbox({ inline: true, width: "730" });


            $("#amount").val($(".slider").slider("value"));
            $('.comments-box .comment-one .user-right').hover(function () {
                $(this).toggleClass('hover');
            });
        });
    </script>
</body>
</html>
