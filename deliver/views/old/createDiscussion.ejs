<div id="content">
    <div class="wrapper clearfix">
        <div id="main">
            <div class="post clearfix">
                <h2><%=subject.name%></h2>

                <div id="discussions" class="form clearfix">
                    <form action="#" method="post">
                        <div class="frame image">
                            <div style="width:220px; height:170px;">
                                <img id="subject_img" src="<%= subject.image_field ? subject.image_field.url : '' %>" src="" alt="<%=subject.name%>"/>
                            </div>
                        </div>

                        <div class="textarea-container clearfix two-third" style="height:27px; min-height:27px; margin-bottom:10px">
                            <textarea id="title" rows="1" cols="1" style="height:40px;" title="textarea" onfocus="if(this.value=='כותרת לרעיון') this.value='';" onblur="if(this.value=='') this.value='כותרת לרעיון';">כותרת לרעיון</textarea>
                        </div>

                        <div class="textarea-container clearfix two-third" style="min-height:102px;">
                            <textarea id="vision" rows="3" cols="1" title="textarea" style="min-height:102px;" onfocus="if(this.value=='כתוב את החזון הכללי של הרעיון שלך..') this.value='';" onblur="if(this.value=='') this.value='כתוב את החזון הכללי של הרעיון שלך..';">כתוב את החזון הכללי של הרעיון שלך..</textarea>
                        </div>

                        <div class="textarea-container clearfix two-third" style="min-height:1px; width:820px; height:27px; min-height:27px;">
                            <textarea id="tags" rows="1" cols="1" title="textarea" style="width:800px;" onfocus="
                            if(this.value=='הוסף תגיות')
                             this.value='';" onblur="if(this.value=='') this.value='הוסף תגיות';">הוסף תגיות</textarea>
                        </div>

                        <div class="textarea-container clearfix">
                            <textarea id="first_post" rows="3" cols="1" title="textarea" onfocus="if(this.value=='כתיבת פוסט ראשון:  תנאים להצלחה  דרכי פעולה (הצעת פעולה?)') this.value='';" onblur="if(this.value=='') this.value='כתיבת פוסט ראשון:  תנאים להצלחה  דרכי פעולה (הצעת פעולה?)';">כתיבת פוסט ראשון:  תנאים להצלחה  דרכי פעולה (הצעת פעולה?)</textarea>
                        </div>
                        <p><input id="create_discussion_btn" class="submit-btn" title="submit" value="יצירת דיון"/></p>

                    </form>
                </div>

                <div class="box1 clearfix" id="shopping_cart">
                    <h2 class="flR">עגלת המידע</h2>
                    <a href="#" class="button flL">שתף</a>


                </div>
            </div>
        </div>
    </div>
</div>
<!--/Content-->
<script type="text/javascript">
    $(function() {

        $('#subject_img').autoscale();

        var subject_id = "<%=subject.id%>", subject_name = "<%=subject.name%>";

        var items = {
            add: function(data, parent) {
                var item =
                        $('<div class="item">' +
                                '<h2>' + data.title + '</h2>' +
                                '<p>' + data.text_field +'</p>' +
                                '<button class="add" value="' + data._id + '">add to your shopping cart</button>' +
                                '<button class="remove hide" value="' + data._id + '">remove from your shopping cart</button>' +
                                '</div>')

                                .appendTo('.' + parent);

                item.find('button.add').click(function() {
                    console.log("in add");
                    var self = $(this);
                    db_functions.dbAddInfoItemToShoppingCart($(this).val(), function didSucceed(flag){
                        if(flag){
                            var item = self.parent('.item').clone().appendTo('.shopping_cart');
                            items.changeButton(item);
                            /////////////////////////////////////////////////////////////
                            item.find('button.remove').click(function() {
                                console.log("In remove");
                                db_functions.dbDeleteInfoItemFromShoppingCart(data._id);
                                $(this).parent('.item').remove();
                            });
                            //////////////////////////////////////////////////////////////
                        }else{
                            console.log('information item is already in shopping cart');
                        }
                    });
                });

                item.find('button.remove').click(function() {
                    console.log("in remove");
                    db_functions.dbDeleteInfoItemFromShoppingCart(data._id);
                    $(this).parent('.item').remove();
                });

                return item;
            },

            changeButton: function(item) {
                item.find('button').toggle();
            },

            buttonRemoveItem: function(item, info_item_id){
                item.find('button.remove').click(function() {
                    console.log("in remove");
                    db_functions.dbDeleteInfoItemFromShoppingCart(info_item_id);
                    $(this).parent('.item').remove();
                });
            }
        }


        var created_discussion_id = null;

            var vision, title, first_post, tags;
            var user_Shopping_cart;

            db_functions.getUserShopingCart(function(err,data){
                user_Shopping_cart = data;
                for (var i=0; i < data.objects.length; i++) {
                    var item = items.add(data.objects[i], "shopping_cart");
                    items.changeButton(item);
                }
                data.objects.forEach(function(obj)
                {
                    obj.get_link = function( )
                    {
                        return '/meida/' + obj._id;
                    }
                });
                dust.renderArray('information_item_in_discussion', data.objects,null,function(err,out)
                {
                    $('#shopping_cart').append(out);
                    $('#shopping_cart img').autoscale();
                });
            });

            $(".preview_btn").live("click", function(){
                console.log("preview_button");
                console.log(user_Shopping_cart);

                title = $(".title").val();
                vision = $(".vision").val();
                first_post = $(".first_post").val();

                db_functions.createPreviewDiscussion(subject_id, vision, title, function(err, data){
                    if (err){
                        console.log(err);
                    }
                    else{
                        created_discussion_id = data._id;
                        var counter = user_Shopping_cart.objects.length;
                        function on_finish()
                        {
                            console.log(counter);
                            if(--counter == 0)
                            {
                                window.location.replace("/discussions/" + created_discussion_id);
                            }
                        };

                        if ($.trim(first_post) != ""){
                            counter++;
                            db_functions.addPostToDiscussion(created_discussion_id, first_post, function(err, data ){
                                if (err){
                                    console.log(err);
                                }
                                else{
                                    on_finish()
                                }
                            });
                        }
                    }
                });
            });

            $("#create_discussion_btn").click(function(){
                title = $("#title").val();
                vision = $("#vision").val();
                first_post = $("#first_post").val();
                tags = $("#tags").val();
                tags = tags.split(" ");


                if (!created_discussion_id){
                    db_functions.createDiscussion(subject_id, subject_name, vision, title, tags, function(err, data){
                        if (err){
                        }else{
                            created_discussion_id = data._id;
//                                $("#user_tokens").text(data.updated_user_tokens);
                            if ($.trim(first_post) != ""){
                                db_functions.addPostToDiscussion(created_discussion_id, first_post, function(err, data){
                                    if (err){
                                        console.log(err);
                                    }else{
                                        window.location.replace("/discussions/" + created_discussion_id);
                                    }
                                });
                            }else{
                                window.location.replace("/discussions/" + created_discussion_id);

                            }
                        }
                    });
                }else{
                    db_functions.diployDiscussion(created_discussion_id, function(err){
                        if (err){
                            console.log(err);
                        }
                        else{
                            console.log("discussion was diployed");
                            alert("discussion created!");
                            if ($.trim(first_post) != ""){
                                db_functions.addPostToDiscussion(created_discussion_id, first_post, function(err, data){
                                    if (err){
                                        console.log(err);
                                    }else{
                                        window.location.replace("/discussions/" + created_discussion_id);
                                    }
                                });
                            }else{
                                window.location.replace("/discussions/" + created_discussion_id);

                            }
                        }
                    });
                }
            });

    });
</script>