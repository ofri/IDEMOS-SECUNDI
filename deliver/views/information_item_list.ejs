<!DOCTYPE html>

<html>
<head>
    <%- partial('partials/head.ejs') %>
</head>
<body>
<div id="wrap">
<div id="header">
    <%-partial('partials/menu.ejs')%>
    <%-partial('partials/user_box.ejs')%>
    <%-partial('partials/failures.ejs')%>
    <%- partial('partials/tag_search.ejs') %>
</div>
<div id="content" class="cf">
    <div class="services-box cf">
        <h2><span dir='rtl'>
7 תחומי על:
        </span>
            כאן תוכלו למצוא מחקרים, ניירות מידע, גרפים, וידאו ודו"חות
            <br />
            הנוגעים לסוגיות הרלוונטיות למשתמשי עורו ולדיונים שמתנהלים במערכת.
            <br />
            אתם מוזמנים להעלות לעמוד זה פרטי מידע חדשים.
        </h2>
        <div class="services-blue cf" id="subjects_list">
        </div>
        <div class="services-green">
            <span class="empty"></span>
            <a href="javascript:void(0)" class="service-8"><span class="text">הוסף פריט מידע</span><span class="icon"></span></a>
            <a href="javascript:void(0)" class="service-9"><span class="text">
                לעגלת המידע
            </span><span class="icon"></span></a>
            <a href="" id="uru_subject_button" class="service-10"><span class="text">
                עורו
            </span><span class="icon"></span></a>
            <span class="empty"></span>
            <span class="empty"></span>
        </div>
    </div>
    <h2>
עוררו עניין
    </h2>
    <div class="news-list cf">
        <div class="slide" id="slide_list" style="height:752px;">
        </div>
    </div>
</div>
</div>
<%- partial('partials/footer.ejs') %>
</body>
</html>
<script type="text/javascript">

    var tag_name = "<%= tag_name %>";


    $(function(){

        if(tag_name!= '')
       {
             db_functions.getItemsCountByTagName(tag_name,function(err,data)
             {
                 dust.render('search_results',data,function(err,out)
                 {
                    $("body").addClass("search-ative");
                    $(".search-box").before(out);
                    addSlides("infos" ,data.info_items_count,db_functions.getInfoItemsByTagName);
                    addSlides("discussions" ,data.discussions_count,db_functions.getDiscussionsByTagName);
                    addSlides("cycles" ,data.cycles_count,db_functions.getCyclesByTagName);
                    addSlides("actions" ,data.actions_count,db_functions.getActionsByTagName);
                   // addSlides("blogs" ,data.blogs_count,db_functions.getBlogsByTagName);
                    $(".search-result-box .tabs").tabs();
                 });
             });
       }



       function addSlides(name,count, getItemsByTagName)
       {
            if (count>0)
            {
                getItemsByTagName  (tag_name,function(err,data)
                {
                    var section_data = new Object();
                    section_data.name= name;
                    section_data.scroll =    data.objects.length >3;
                    dust.render('search_section',section_data,function(err,out)
                    {
                        $(".tabs").append(out);

                       /*   var citrus = fruits.slice(1,3);
                           $('.tab-slide-'+name)
                           .after('<div class="nav-'+name+' nav">')
                           .cycle({
                               fx: 'scrollLeft',
                               speed: 'fast',
                               timeout: 0,
                               pager: '.nav-'+name,
                               next: '.next-'+name,
                               prev: '.prev-'+name
                           });

                           */
                    });

                });

            }
            else
            {
                dust.render('search_section_empty',null,function(err,out) {
                     $(".tabs").append(out);
                });
            }



       }

        db_functions.getAllSubjects(function(err,data)
        {
            var uru_subject = data.objects[0];
            $('#uru_subject_button').attr('href','/information_items/subject/' + uru_subject._id);
            $.each(data.objects.slice(1),function(index,subject)
            {
                dust.render('subject',subject,function(err,out)
                {
                    $('#subjects_list').append(out);
                })
            });

        });

        function loadHotInfoItems(slide_page,objects)
        {
            $.each(objects,function(index,hot_item)
            {
                dust.render('hot_information_item',hot_item,function(err,out)
                {
                    slide_page.append(out);
                })
            });
            slide_page.attr('data-loaded','true');
        }

        db_functions.getHotInfoItems(0,function(err,data)
        {
            var num_of_pages = Math.ceil(data.meta.total_count/data.meta.limit);
            for(var i=0; i<num_of_pages; i++)
            {
                $('#slide_list').append($('<div class="one-slide"></div>'));
            }
            if(data.meta.total_count > data.meta.limit)
            {
                $('.slide').before('<div id="nav">')
                        .cycle({
                            fx:     'scrollHorz',
                            speed:  '2000',
                            timeout: 0,
                            pager:  '#nav',
                            before:function(currSlideElement, nextSlideElement, options, forwardFlag){
                                var elm = $(nextSlideElement);
                                var index = elm.index();
                                if(!elm.data('loaded'))
                                {
                                    db_functions.getHotInfoItems(index*6,function(err,data)
                                    {
                                        loadHotInfoItems(elm,data.objects);
                                    });
                                }

                            }
                        });
            }
            else{
                loadHotInfoItems($($('.slide .one-slide')[0]),data.objects);
            }


        });



    });


</script>

