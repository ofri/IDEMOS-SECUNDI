<!DOCTYPE html>

<html>
<head>
    <style>
        .subject_selected{color: #ff0000 ; font-size: 50px}
    </style>
    <% include partials/head.ejs %>
    <script type="text/javascript">
        $(document).ready(function () {
            $('.tikunim-box h2').click(function () {
                $(this).parent().toggleClass('active');
            });
        });
    </script>
</head>
<body>
<% include partials/body_top.ejs %>
<div id="wrap">
    <div id="header">
        <% include partials/menu.ejs %>
        <% include partials/user_box.ejs %>
        <% include partials/failures.ejs %>
        <% include partials/tag_search.ejs %>

    </div>
    <div id="content" class="cf">

        <div id="subjects" class="services-box services-box-all cf">
            <div id="subjectsLevel1_blue" class="services-blue services-blue-two cf">

            </div>
            <div id="subjectsLevel2_blue" class="services-blue services-blue-three cf">

            </div>
            <div class="services-green">
                <span class="empty"></span>
                <a href="javascript:void(0);" class="service-10 subjectItem"  data-subject_id=""><span class="text">
עורו
                </span><span class="icon"></span></a>
            </div>
            <a  id="new_discussion_bt"  class="green-btn" href="#">צור דיון חדש</a>
        </div>
        <select id="sorting_select" class="left-select">
            <option value="-last_updated">
                עדכון אחרון
            </option>
            <option value="-creation_date" >
						תאריך
						</option>
            <option value="-grade">
						דירוג
						</option>
            <option value="-followers_count">
						עוקבים
						</option>
        </select>
        <h2>כל הדיונים במערכת</h2>
        <div id="discussions_list">

        </div>
    </div>
</div>
<% include partials/footer.ejs %>
</body>
</html>
<script type="text/javascript">

    var current_section = 1;
    $(function(){


        var selectedTag = '<%=tag_name ? tag_name : '' %>';
        var user_id = '<%=user_id%>';
        var has_voted = <%=has_voted%>;
        var selectedSubject;

        db_functions.getAllSubjects(function(err,data) {
            $.each(data.objects, function(index,disc) {
                disc.type = 'discussions';
            });
            var uru_subject = data.objects[0];
            var level1subjects = data.objects.slice(1,6);
            var level2subjects = data.objects.slice(6,8);

            $('.services-green .subjectItem').data('subject_id', uru_subject._id).attr('href', '/discussions/subject/' + uru_subject._id);

            $.each(level1subjects,function(index,subject){
                dust.render('subject',subject,function(err,out) {
                    $('#subjectsLevel1_blue').append(out);
                })
            });

            $.each(level2subjects,function(index,subject){
                dust.render('subject',subject,function(err,out) {
                    $('#subjectsLevel2_blue').append(out);
                })
            });

        });
        //remove this for now, till the next elections or something
        /*if (has_voted) db_functions.loggedInAjax({
            url: '/api/user_chosen_discussions/' + user_id,
            type: "GET",
            async: true,
            success: function (data) {
                $.each(data, function(index,obj) {
                    obj.word_count = function() {
                        return Math.min($.trim(obj.name).split(/\s+/).length,3);
                    };
                    obj.type = 'discussions';
                    dust.render('dicussion_elected', obj, function(err, out) {
                        $('#elected_discussions_list').append(out);
                    })
                });
            },
            error:function(data)
            {
                alert(data);
            }
        });*/

        function createDiscussionsQuery(){
            var sortby = $('#sorting_select').val();
            var query='order_by='+sortby;
//            if(selectedTag){
//                query =query+'&tags='+selectedTag;
//            }
            if(selectedSubject){
                query = query+'&subject_id='+selectedSubject;
            }
            query = query+'&is_private='+false;
            return query;
        }

        function loadDiscussionsListToPage(){
            var query = createDiscussionsQuery();
            listCommon.reloadList('discussions_list', 'discussions', 'discussion_list_item', query);

        }

//        $('#subjects').on('click','.subjectItem',function(e){
//
//            var subjectId= $(this).data('subject_id');
//            e.preventDefault();
//
//            $('#subjects .subjectItem').removeClass('selected-subject')
//            if( selectedSubject!==subjectId){//select
//                selectedSubject=subjectId;
//                $(this).addClass('selected-subject')
//
//            }
//            else{ //unSelect
//
//                selectedSubject='';
//            }
//            loadDiscussionsListToPage();
//        })

        $('#discussions_list').on('click','.join_button',function(e){
            var item=  $(this).parents('[data-id]');
            var item_id=   item.data('id');
            var actionType=  $(this).data('action');
            e.preventDefault();
            db_functions.joinToDiscussionFollowers(item_id,actionType,function(err,data){
                dust.render('discussion_list_item', data, function(err, html){
                   // $("#"+data._id).replaceWith(html);
                    item.replaceWith(html);
                })
            })
        });

        $('#sorting_select').change(loadDiscussionsListToPage);
        loadDiscussionsListToPage();

        $('#new_discussion_bt').on('click',function(e){
            e.preventDefault();
            if(selectedSubject){
                window.location = 'discussions/new/' + selectedSubject;
            } else {
                var config = {
                   message:'בחר נושא בבקשה'
				  ,okButtonText:'סגור'
                };
                popupProvider.showOkPopup(config);
            }
        })
    });

</script>
