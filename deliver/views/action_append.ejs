<!DOCTYPE html>
<%
var error_message = error_message || '';
%>

<html>
<head>
<!--<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# <%= settings.facebook_app_name %>: http://ogp.me/ns/fb/<%= settings.facebook_app_name %>#">-->
    <% include partials/head.ejs %>
    <script src="/js/jquery-fieldselection.js" type="text/javascript"></script>
    <script src="/plugins/ckeditor/ckeditor.js"></script>
    <script src="/plugins/ckeditor/adapters/jquery.js"></script>
    <script src="http://maps-api-ssl.google.com/maps/api/js?v=3&sensor=false&language=he"  type="text/javascript"></script>

  <!--  <meta property="fb:app_id" content="<XXX%= settings.facebook_app_id %>" />
    <meta property="og:type"   content="<XXX%= settings.facebook_app_name %>:discussion" />
    <meta property="og:url"    content="<XXX%= settings.root_path %>/discussions/<XXX%= discussion.id %>" />
    <meta property="og:title"  content="<XXX%=discussion.title%>" />
    <meta property="og:description"  content="<XXX%=discussion.text_field%>" />
    <meta property="og:image"  content="<XXX%= discussion.image_field && discussion.image_field.url ? discussion.image_field.url : 'http://site.e-dologic.co.il/philip_morris/Xls_script/uru_mailing/logo.jpg' %>" />
-->


</head>
<body class="body-action">
<% include partials/body_top.ejs %>
<div id="wrap">
    <div id="header">
        <% include partials/menu.ejs %>
        <% include partials/user_box.ejs %>
        <% include partials/failures.ejs %>
        <% include partials/tag_search.ejs %>
    </div>
<div id="content" class="cf">
<div class="followers-box">
    <div class="extra">
        <h2><span>ציר הזמן</span> חייבים להציל את הקיפודים</h2>
        <div class="followers-diagram">
            <div class="event event-prev" style="left: 0px">
                <div class="icon prev-icon">
                    <span class="i"></span>
                </div>
                            <span class="number">
                                2.2
                            </span>
                            <span class="text">
                                יצירת דיון
                            </span>
            </div>
            <div class="event event-plus" style="left: 600px">
                <div class="icon plus-icon">
                    <span class="i"></span>
                </div>
                            <span class="number">
                                2.2
                            </span>
                            <span class="text">
                                יצירת דיון
                            </span>
            </div>
            <div class="event event-triangle" style="left: 750px">
                <div class="icon triangle-icon">
                    <span class="i"></span>
                </div>
                            <span class="number">
                                8.3
                            </span>
                            <span class="text">
                                היום
                            </span>
            </div>
            <div class="event" style="left: 150px">
                <div class="icon green-icon">
                    <span class="i"></span>
                    <div class="popup-event type-one">
                        <div class="popup-text">
                            <h4>הפגנה למען הקיפודים</h4>
                            <p>אחד העם 19</p>
                            <p>תל אביב</p><br>
                            <p>20:00</p>
                            <a href="" class="join-btn">הצטרף</a>
                        </div>
                    </div>
                </div>
                            <span class="number">
                                4.4
                            </span>
                            <span class="text">
                                דיון פתוח
                            </span>
            </div>
            <div class="event" style="left: 300px">
                <div class="icon blue-icon">
                    <span class="i"></span>
                    <div class="popup-event type-two">
                        <div class="popup-text">
                            <img width="112" alt="" class="floatRight" src="images/sample-7.jpg">
                            <h5>אירוע חשוב מאוד</h5>
                            <p>הרצאה יוצאת מן הכלל מפי פרופ’ כהן אחד העם 91, תל אביב</p>
                        </div>
                    </div>
                </div>
                            <span class="number">
                                4.4
                            </span>
                            <span class="text">
                                דיון פתוח
                            </span>
            </div>
            <div class="event" style="left: 450px">
                <div class="icon grey-icon">
                    <span class="i"></span>
                    <div class="popup-event type-three">
                        <div class="popup-text">
                            <h3>פברואר</h3>
                            <ul class="">
                                <li><strong>2.2</strong> - יצירת דיון</li>
                                <li><strong>8.2</strong> - הפגנה</li>
                                <li><strong>2.2</strong> - דיון</li>
                                <li><strong>2.2</strong> - יצירת דיון</li>
                                <li><strong>8.2</strong> - הפגנה</li>
                                <li><strong>2.2</strong> - דיון</li>
                                <li><strong>2.2</strong> - יצירת דיון</li>
                                <li><strong>8.2</strong> - הפגנה</li>
                                <li><strong>2.2</strong> - דיון</li>
                            </ul>
                        </div>
                    </div>
                </div>
                            <span class="number">
                                4.4
                            </span>
                            <span class="text">
                                דיון פתוח
                            </span>
            </div>
            <div class="event event-next" style="left: 100%">
                <div class="icon next-icon">
                    <span class="i"></span>
                </div>
                            <span class="number">
                                15.4
                            </span>
                            <span class="text">
                                תאריך יעד
                            </span>
            </div>
        </div>
    </div>
</div>

<div class="add-offer add-offer-inner">
   <h2>
  <span class="arrow">
		<%=action.type%>
		</span>
       <%=action.admin_text%>

	</h2>
    <div  id="minInfo" class="text-box cf">
        <h3><span class="arrow">
            <a href="/cycles/<%=action.cycle_id._id%>" style="color: #50504F;position: initial;">
                <%=action.cycle_id.title%></a> </span>
            <span class="blue-title"><%=action.title%></span></h3>

        <div id="discussion_image" style="width: 212px;height: 164px; overflow:hidden;" class='auto-scale floatRight'>
            <img src="<%= action.image_field ? action.image_field.url ||'' : '' %>" alt=""/>
            <!--  images/sample-2.jpg" -->

        </div>
        <div class="add-offer-info">
            תאריך: 
			<strong><%=action.from_date.format('dd.mm.yyyy') %></strong> 
			|  שעה: 
			<strong><%=action.from_date.format('HH:MM') %>-<%=action.to_date.format('HH:MM') %></strong>
        </div>
        <div class="add-offer-info m-2">
            מיקום:
            <strong><%=action.location?action.location.address:''%></strong>
        </div>
        <div class="discussion_content action-text-overflow">
      <!--    <p><%-action.text_field%></p>-->
            <textarea id="discussion_content" class="hidden_textarea"><%=action.text_field%></textarea>

         </div>

        <a class="more-text" href="">קרא עוד</a>

        <div class="add-offer-users">
            כמות משתתפים רצויה:
			<%=action.required_participants%>
        </div>
    </div>

    <div id="fullInfo" class="add-offer text-box cf fullInfo" style="display: none">
        <!--  <h2><span class="arrow">פעולת שטח</span> <a href="">מפגינים מול ביתו של שר התשתיות</a></h2>-->
        <h3><span class="arrow">
            <a href="/cycles/<%=action.cycle_id._id%>" style="color: #50504F;position: initial;">
                <%=action.cycle_id.title%></a> </span>
            <span class="blue-title"><%=action.title%></span></h3>
        <div class="text-box cf">
            <div id="discussion_image" style="width: 139px;height: 135px; overflow:hidden;" class='auto-scale floatRight'>
                <img src="<%= action.image_field ? action.image_field.url ||'' : '' %>" alt=""/>
                <!--  images/sample-2.jpg" -->

            </div>
            <!--<img class="floatRight" src="../images/sample-8.jpg" alt="" />-->
            <div class="details">
                <div class="detail-date">
                    <span class="icon"></span>
                    תאריך:
                    <strong><%=action.from_date.format('dd.mm.yyyy') %></strong>
                    |  שעה:
                    <strong><%=action.from_date.format('HH:MM') %>-<%=action.to_date.format('HH:MM') %></strong>
                </div>
                <div class="detail-resourse">
                    <span class="icon"></span>
                    משאבים נדרשים:
                    <% for (var i=0;i < action.action_resources.length;i++){%>
                    <span class="check"><%=action.action_resources[i].resource.name %></span>
                    <% } %>

                </div>
                <div class="detail-ratio">
                    <span class="icon"></span>
                    כמות משתתפים רצויה:
                    <strong class="green"><%=action.required_participants %></strong>
                    |  כמות משתתפים נוכחית:
                    <strong class="red going_red"></strong>
                </div>
                <div class="detail-address">
                    <span class="icon"></span>
                    מיקום:
                    <strong><%=action.location?action.location.address:''%></strong>
                </div>
            </div>
            <p><%-action.text_field%></p>

            <a id="readLess" class="read_less" href="">
                קרא פחות
            </a></p>
        </div>

        <div id="map" class="map" style="width:691px ;height:125px ">
            <!--<img src="../images/map.jpg" alt="" />
            <div class="map-popup">
                <a class="close" href=""></a>
                <h4>התעשייה 12, תל אביב</h4>
                <p><a href="">צפה במפה</a> | <a href="">קבל מסלול נסיעה</a></p>
            </div>-->
        </div>


    </div>
	
	
	
    <div class="add-offer-bottom cf">
        <div class="btn-box">
            <a class="btn-green" href="#" id="action_comment_reply_button">הגב</a>
        <!--    <a class="btn-grey" href="">שתף</a>-->

            <a class="btn-grey share" rel="/actions/<%=action._id%>"
               data-img_src="<%= action.image_field ? action.image_field.url ||'' : '' %>" data-text_preview="<%=action.text_field_preview%>" data-title="<%=action.title%>"
               data-name="<%=action.text_field_preview%>"
               href="/facebookShare?link=/actions/<%=action._id%>">
                שתף
            </a>
            <div class="btns-grey">
                <a href="">הצעה לשינוי</a>
                <a href="">היסטוריה</a>
            </div>
        </div>
        <div class="tags">
             <% for (var c = 0; c<action.tags.length ; c++) { %>
                    <a href="/discussions/?tag_name=<%=action.tags[c]%>"> <%=action.tags[c] %></a>
           <% }%>

        </div>
        <div class="slide-box">

            <div class="summary">
                <input type="text" id="amount" value="<%= Math.round(action.grade*100)/100 %>"/>
                        <span> <div class="inlinediv" id="graders"><%= Math.round(action.evaluate_counter) %>
                        </div> מדרגים</span>
            </div>
            <div class="slider slider-one">
            </div>
            <div class="slider-numbers">
                <span>1</span>
                <span>2</span>
                <span>3</span>
                <span>4</span>
                <span>5</span>
                <span>6</span>
                <span>7</span>
                <span>8</span>
                <span>9</span>
                <span>10</span>
            </div>
        </div>
    </div>
    <div class="add-offer-btn-box">
       <!-- <a href="">אם זה קורה, אני שם</a>-->
        <a href="#" >
        <% if(!action.is_going) { %>
אם זה קורה, אני שם
        <% } else{ %>
        עזוב
        <% } %>
            </a>

    </div>
</div>

<% include partials/action_shopping_cart.ejs %>

<div id='write-comment' class="write-comment" style="display: none;" >
    <h3>
        הצעה לשינוי
    </h3>

    <div class="text-box cf">
        <div class="left">
            <p id='discussion_content_txt'><strong></strong>

            </p>
            <label>
                ההצעה לשינוי שלי:
            </label>
            <textarea id='discussion_suggest' class="five-col" cols="0" rows="0"></textarea>
            <label>
                טיעונים, הצדקות ונימוקים:
            </label>
            <textarea id="discussion_explanation" class="two-col" cols="0" rows="0"></textarea>
        </div>
        <div class="user-right">
            <div class="img-box" style="overflow: hidden;">
                <div   style="width:70px; height:70px;" class='auto-scale'>
                    <% if(user_logged) { %>
                    <img id="reload-img" src="<%=avatar%>" alt="אני"  style="width:70px; height:70px"/>
                    <% } %>
                </div>
                <span></span>
            </div>
            <h4>אני</h4>

            <div class="date"><%=(new Date()).format('dd.mm.yy') %></div>
            <% if(user_logged){ %>
            <div class="proxy">
                <span>3</span>
            </div>
            <div class="respect">
                <span>20</span>
            </div>
            <% } %>
        </div>
    </div>
    <a class="grey-btn" id="cancelWriteCommentBT" href="javascript:void(0);"><span>
מתחרט
            </span></a>
    <a id="send_suggestion" class="green-btn" href="javascript:void(0);">
        הצע
    </a>
</div>





<div class="members-box members-box-action-approved cf ">
    <h2>משתתפים
        <small id="going_number"></small></h2>
    <div  id="participant">
    </div>

    <br clear="all" />
    <div class="more-deals" >
        <a href="">עוד הצעות</a>
    </div>
</div>



<div class="deals-box">
    <h2>הצעות לשינוי
        <small id="suggestion_number"></small>
    </h2>
    <div id="suggestion_list"></div>
    <div class="more-deals" >
        <a href="">עוד הצעות</a>
    </div>
</div>
</div>
</div>




<div class="system-notice" <%-action.system_message? '' :'style="display: none;"' %>>
    <div class="extra">
        <a class="close" href=""></a>
        <%- action.system_message %>
    </div>
</div>

<div class="comments-box comments-box-inner">
    <div class="extra cf">
        <select class="left-select">
            <option>
                מיין לפי תאריך
            </option>
            <option>
                מיין לפי יוזר
            </option>
            <option>
                מיין לפי תוצאות
            </option>
        </select>
        <h2>
            תגובות
            <small id="comments_number"></small></h2>
        <div id="comments">

        </div>
        <a href="javascript:void(0)" class="more_comments" style="display:none;">הראה עוד</a>
        <div class="write-comment">
            <h3>
                כתיבת תגובה
            </h3>

            <div class="text-box cf"
            <%if(user_logged){%> data-creator_id="<%=user._id%>" <%}%> >
            <div class="left">
                <textarea id="discussion_comment" dir="rtl" class="four-col" cols="0" rows="0"></textarea>
            </div>
            <div class="user-right">
                <div class="img-box" style="overflow: hidden;">
                    <div style="width:70px; height:70px;" class='auto-scale'>
                        <% if(user_logged) { %>
                        <img src="<%=avatar%>" alt="אני"/>
                        <% } %>
                    </div>
                    <span></span>
                </div>
                <h4>אני</h4>

                <div class="date"><%=(new Date()).format('dd.mm.yy') %></div>
                <% if(user_logged){ %>
                <div class="proxy">
                    <span><%=user.num_of_proxies_i_represent%> </span>
                </div>
                <div class="respect">
                    <span class="score"><%=user.score%></span>
                </div>
                <% } %>
            </div>
        </div>
        <a id="submit_post" class="green-btn" href="javascript:void(0);">
            הצע
        </a>
    </div>
</div>
 <span class="popup-window">
         <span class="arrow"></span>
         <a class="close" href="javascript:void(0);"></a>
        	 <a id="pop_post_bt" class="green-btn" href="javascript:void(0);">הגב</a>
             <a id="pop_suggest_bt" class="grey-btn suggest" href="javascript:void(0);">
                 הצע הצעה לשינוי
             </a>
     </span>

<% include partials/action_common.ejs %>
<% include partials/footer.ejs %>

 <script type="text/javascript">
     var action_id='<%=action._id%>';
     var my_id = "<%=user_logged ? user._id : ''%>";
     var my_discussion_grade = Number("<%= action.grade_obj ? action.grade_obj.value || 0 : 0 %>");
     var creator_id = "<%=action.creator_id%>";
     $(function(){
         var grade_id = "<%= action.grade_obj ? action.grade_obj.grade_id : 0 %>";
         var is_creator = (my_id == creator_id);
         $('.system-notice .close').click(function (e) {
             e.preventDefault();
             $(this).parents('.system-notice').fadeOut(800);
         });

         (function propselModule(){
             var mouseDown, mouseUp, top, left;
             $('.discussion_content').on('mousedown', function (e) {
                 mouseDown = e;
                 console.log(e);
             })
                     .on('mouseup',
                     function (e) {
                         mouseUp = e;
                         var err = false;
                         var range = $(this).find('textarea').getSelection();

//                console.log(e);


                         left = Math.ceil((mouseDown.clientX + mouseUp.clientX) / 2 - ($(".popup-window").width() / 2));
                         top = Math.min(mouseDown.clientY, mouseUp.clientY) - $(".popup-window").height() - 40 + $(window).scrollTop();



                     }).on('keydown',
                     function (e) {
                         console.log(e.keyCode == 27);
                         if (!(e.shiftKey && (e.keyCode <= 40 && e.keyCode >= 37) || (e.ctrlKey && e.keyCode == 65))) e.preventDefault();
                     }).on('dragstart', function (e) {
                         e.preventDefault();
                     });

             $('.popup-window .close').on('click', function () {
                 $('.popup-window').hide();
             });

             $('.popup-window').on('focus', function (e) {
                 e.preventDefault();
             });
             $("#discussion_content").select(function () {
                 range = $(this).getSelection();
                 flag = false;
                 /* db_functions.getSuggestionByDiscussion(action_id, null, null, function(err, suggestions){
                     $.each(suggestions.objects, function (index, suggestion) {
                         if ((suggestion.parts[0].start >= range.start && suggestion.parts[0].start <= range.end)
                                 || (suggestion.parts[0].end >= range.start && suggestion.parts[0].end <= range.end)) {
                             flag = true;
                         }
                     })*/
                     if(flag)
                         popupProvider.showOkPopup({message:"הטקסט סומן כבר בהצעה לשינוי קיימת"});
                     else
                         $(".popup-window")
                                 .css({ top:top + 20, left:left, opacity:0 })
                                 .show()
                                 .animate({ top:'-=20px', opacity:1 }, 100, 'linear');
                // });

                 console.log(range);
             });

             $('#pop_suggest_bt').on("click", function (e) {
                 e.preventDefault();
                 $('#discussion_content_txt').text('"' + range.text + '"');
                 $('#write-comment').show();
                 $('textarea#discussion_suggest').focus();
                 $('#reload-img').attr('src', $('#reload-img').attr('src'));
                 $(".popup-window").hide();
             });
             $('#pop_post_bt').on("click", function (e) {
                 e.preventDefault();
                 new_post_ref_id = null;
                 $(".popup-window").hide();
                 $("textarea#discussion_comment").val('"' + range.text + '"').focus();


             });

             $('#suggest_button').click(function () {
                 $('#suggest_div').show();
             });

             $('#close_suggest').click(function () {
                 $('#suggest_div').hide();
                 $("textarea#discussion_suggest").val('');
             });

             $('#send_suggestion').click(function () {
                 var part = {start:range.start, end:range.end, text:$("textarea#discussion_suggest").val()};
                 //arrange spaces
                 if (vision[part.end - 1] == " " && part.text[part.text.length - 1] != " ")

                     part.text += " ";
                 var explanation = $("#discussion_explanation").val();
                 db_functions.addSuggestionToDiscussion(discussion_id, [part], explanation, function (err, data) {
                     if (!err) {
                         $('#write-comment').hide();
                         render_suggestion(data)
                         $(".deals-box").show();
                     } else {
                         var err = err;
                         if(err.responseText == "a suggestion with this indexes already exist")
                             popupProvider.showOkPopup({message:"הטקסט סומן כבר בהצעה לשינוי קיימת"});
                     }
                 });
             });

             $("#cancelWriteCommentBT").live("click", function () {
                 $('#write-comment').hide();
             });


         } )();

         $(".slider").slider({
             disabled:is_creator,
             value:my_discussion_grade,
             range:"min",
             min:0,
             max:10,
             step:0.10,
             change:function (event, ui) {

                 my_discussion_grade = ui.value;
                 db_functions.addDiscussionGrade(action_id, my_discussion_grade, grade_id, function (err, data) {

                     if (!err) {
                         $("#amount").val(Math.round(data.new_grade * 100) / 100);
                         $("#graders").text(Math.round(data.evaluate_counter));
                         $(".dark_bar").css('width', (my_discussion_grade * 10) + '%');
                         grade_id = data.grade_id;
                     }
                     else
                         console.log(err);
                 });
             }
         });

         var goingModel= new  window.uru.GoingModel({
             joinString:'אם זה קורה, אני שם'
         });
         //start from index 0 loding 1 rows 7 items
         goingModel.loadGoingUsers(0,1);
        // loadPosts();
     });




 </script>

</body>
</html>
