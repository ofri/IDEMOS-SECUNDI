<div id="main-thing">
    <div class="main-thing-in">
        <div class="what"></div>

        <ul id="display-inline-block-example">
            <li class="uru1">
                <div class="intext"><p><strong>חינוך טוב יותר</strong><br>תוגדל ההשקעה בתגמול והכשרת מורים ובכיתות קטנות
                </p>

                    <div class="intext-checkbox"><input type="checkbox" class="checkBox" value="0"/></div>
                </div>
                <div class="intext"><p><strong>שיוויון הזדמנויות לכל ילד</strong><br>סל תלמיד אחיד וחובת לימוד ליבה לכל
                </p>

                    <div class="intext-checkbox"><input type="checkbox" class="checkBox" value="1"/></div>
                </div>
            </li>
            <li class="uru2">
                <div class="intext"><p><strong>חיזוק דעת הרוב</strong><br>יועלה אחוז החסימה בבחירות הכלליות לכנסת</p>

                    <div class="intext-checkbox"><input type="checkbox" class="checkBox" value="2"/></div>
                </div>
                <div class="intext"><p><strong>יוגבל גודל הממשל</strong><br>עד 18 שרים ו-6 סגני שרים, לחיסכון תקציבי
                    וחיזוק הכנסת</p>

                    <div class="intext-checkbox"><input type="checkbox" class="checkBox" value="3"/></div>
                </div>
            </li>
            <li class="uru3">
                <div class="intext"><p><strong>הפחתת יוקר המחיה</strong><br>יופחתו עמלות וריביות הבנקים ללקוחות ועסקים
                    קטנים</p>

                    <div class="intext-checkbox"><input type="checkbox" class="checkBox" value="4"/></div>
                </div>
                <div class="intext"><p><strong>הוזלת הדיור</strong><br>אישור בנייה לפרוייקטים גדולים יותנה בהקצאה לדיור
                    בר-השגה</p>

                    <div class="intext-checkbox"><input type="checkbox" class="checkBox" value="5"/></div>
                </div>
            </li>
            <li class="uru4">
                <div class="intext"><p><strong>גיוס לכל</strong><br>תיקבע חובה אחידה של שירות צבאי או אזרחי בגיל 18 לכלל
                    האזרחים</p>

                    <div class="intext-checkbox"><input type="checkbox" class="checkBox" value="6"/></div>
                </div>
                <div class="intext"><p><strong>תגמול הולם</strong><br>יינתן תגמול גבוה יותר למשרתים ויוגבלו הקצבות
                    לפטורים משירות</p>

                    <div class="intext-checkbox"><input type="checkbox" class="checkBox" value="7"/></div>
                </div>
            </li>
            <li class="uru5">
                <div class="intext"><p><strong>שיפור תנאים</strong><br>יאכפו חוקי העבודה על כלל העובדים, לרבות עובדי
                    קבלן וזרים</p>

                    <div class="intext-checkbox"><input type="checkbox" class="checkBox" value="8"/></div>
                </div>
                <div class="intext"><p><strong>בריאות נגישה</strong><br>יועלה משמעותית מספר מיטות האשפוז והסגל בבתי
                    החולים</p>

                    <div class="intext-checkbox"><input type="checkbox" class="checkBox" value="9"/></div>
                </div>
            </li>
            <li class="uru6">
                <div class="intext"><p><strong>אנרגיה ממקורות מתחדשים</strong><br>יוסרו חסמים בירוקרטיים מעכבים ויקודם
                    השימוש</p>

                    <div class="intext-checkbox"><input type="checkbox" class="checkBox" value="10"/></div>
                </div>
                <div class="intext"><p><strong>משאבי טבע לכל</strong><br>תוקם קרן ניהול הכנסות מדינה מגז ונפט לטובת
                    הדורות הבאים</p>

                    <div class="intext-checkbox"><input type="checkbox" class="checkBox" value="11"/></div>
                </div>
            </li>
            <li class="uru7">
                <div class="intext"><p><strong>מאבק בעבריינות</strong><br>תוחמר האכיפה ומדיניות הענישה על עבירות גוף
                    ורכוש</p>

                    <div class="intext-checkbox"><input type="checkbox" class="checkBox" value="12"/></div>
                </div>
                <div class="intext"><p><strong>יותר שוטרים ברחוב</strong><br>יועלו משמעותית מספר השוטרים, תגמולם והכשרתם
                </p>

                    <div class="intext-checkbox"><input type="checkbox" class="checkBox" value="13"/></div>
                </div>
            </li>
            <li class="uru8">
                <div class="intext">
                    <p>
                        <strong>העלה הצעה משלך</strong> (אופציונלי):

                        <select id="styledSelect" class="blueText">
                            <option value="0">בחר נושא</option>
                            <option value="1">חינוך</option>
                            <option value="2">משק וכלכלה</option>
                            <option value="3">תעסוקה ובטחון חברתי</option>
                            <option value="4">ביטחון אישי</option>
                            <option value="5">ממשל ודמוקרטיה</option>
                            <option value="6">שוויון בזכויות וחובות</option>
                            <option value="7">סביבה, אנרגיה וקיימות</option>
                        </select>

                    </p>
                    <div class="intext-checkbox intext-last-checkbox"><input type="checkbox" class="checkBox"
                                                                             value="14"/></div>
                </div>

                <textarea class="placeholder" id="textarea" cols="48" rows="3">הכניסו תיאור</textarea>
            </li>
        </ul>
    </div>
    <div class="down-text">
        <p>
            המצביעים מצטרפים לעורו ומוזמנים להשתתף בדיונים המתנהלים באתר סביב ההצעות.
        </p>
    </div>
</div>

<div class="vote-container<%if(!user_logged){%>-non-reg<%}%>">
    <div class="reg-container">
        <div class="rightone">
            <p>התחברו לעורו באמצעות</p>
            <a href="javascript:void(0)" id="facebook-connect"><img src="/images/elections/connectwith.png"
                                                                    alt="התחבר לעורו"></a>
        </div>
        <div class="middleone">
            <div class="middleone_image"></div>
        </div>
        <div class="leftone">
            <form id="user-signup">
                <input id="full_name" class="placeholder design2" size="22" value="שם + שם משפחה" name="full_name"
                       type="text">
                <input id="email" class="placeholder design2" size="22" value="כתובת מייל" name="email" type="email">
            </form>
        </div>
    </div>
    <div class="inarea">
        <a href="javascript:void(0)" id="send-vote"><img src="/images/elections/vote-now.png"
                                                         alt="שלח הצבעה-תנועת עורו"></a>
    </div>
</div>

<% include partials/socila_popup.ejs %>

<style>p.error {
    color: magenta;
    font: normal 14px/18px Arial
}</style>
<script type="text/javascript">
$(function () {
    var user_logged =
    <
    %= user_logged % >;
    var fbshareUrl;
    var user_is_new = false,
            mapGuide = {
                0: 'entry.6.group',
                1: 'entry.7.group',
                2: 'entry.13.group',
                3: 'entry.11.group',
                4: 'entry.25.group',
                5: 'entry.23.group',
                6: 'entry.9.group',
                7: 'entry.31.group',
                8: 'entry.21.group',
                9: 'entry.19.group',
                10: 'entry.33.group',
                11: 'entry.35.group',
                12: 'entry.17.group',
                13: 'entry.15.group'
            };

    $('#user-signup').validate({
        errorElement: "p",

        rules: {
            full_name: {
                required: true,
                two_parts: true
            },
            email: {
                required: true
            }
        },
        messages: {
            full_name: {
                required: "נא להזין שם פרטי ומשפחה"
            },
            email: {
                required: 'נא להזין כתובת מייל',
                email: 'ההרשמה לא הצליחה, אנא בידקו את כתובת המייל שהוזנה'
            }
        },
        highlight: function (element, errorClass) {
            $(element).addClass('error').removeClass('valid');
        },
        unhighlight: function (element, errorClass) {
            $(element).removeClass('error').addClass('valid');
        },

        invalidHandler: function (form, validator) {
            var errors = validator.numberOfInvalids();
        }
    })

    function getVoteData() {
        var data = {};
        $('.checkBox:checked').each(function () {
            var index = $(this).val();
            if (index === '14') {
                data['entry.37.single'] = $('#textarea').val();
                data['entry.44.single'] = $('#styledSelect').val()
            } else {
                data[mapGuide[index]] = 'X';
            }
        });
        data.email = $('#voting_email').val();
        return data;
    }

    function shareScreen() {
        $('#box-share,#screen').show();
        $('#screen,#close').one('click',function () {
            window.location.href = '/discussions';
        }).show();
    }

    $('.checkBox').click(function () {
        var $this = $(this),
                checked = $this.is(':checked');

        if (checked && $('.checkBox:checked').length > 5) {
            popupProvider.showOkPopup({message: 'באפשרותך לבחור עד 5 הצעות.'});
            event.preventDefault();
        }
    });


    $('#textarea, .design2').on('focus blur', function (e) {
        var $this = $(this);

        switch (e.type) {
            case 'focus':
                if ($this.hasClass('placeholder')) {
                    $this.data('placeholder', $this.val()).removeClass('placeholder').val('');
                }
                break;
            case 'blur':
                if ($this.val().replace(/^\s+$/, '') === '') {
                    $this.addClass('placeholder').val($this.data('placeholder'));
                }
                break;
        }
    });

    function sendVote() {
        var data = getVoteData();
        $.post('/elections/vote', data,function (ret_data) {
            $(document).trigger('voted');
            shareScreen();
        }).fail(function (e) {
                    setTimeout(function () {
                        popupProvider.showOkPopup({message: 'כבר נקלטה הצבעה מחשבון זה.'});
                    }, 10);
                });
    }


    $('#send-vote,#send_vote_1').on('click', function (e) {
        e.preventDefault();

        if ($('.checkBox:checked').length > 5) {
            popupProvider.showOkPopup({message: 'באפשרותך לבחור עד 5 הצעות.'});
            return false;
        }

        var validationErrors = $('#user-signup').validate().errorList;
        if (validationErrors.length > 0) {
            popupProvider.showOkPopup({
                message: validationErrors[0].message
            });
            return false;
        }

        if ($('#display-inline-block-example .checkBox:checked').length === 0) {
            popupProvider.showOkPopup(
                    {
                        message: 'עליך לבחור הצעה',
                        callback: function () {
                            location.hash = "#main-thing";
                        }
                    }
            );

            return false;
        }

        if ($('.intext-last-checkbox p.checkBox:checked').length > 0) {
            if ($('#styledSelect').val() === '0') {
                popupProvider.showOkPopup({
                    message: 'עליך לבחור נושא מהרשימה.',
                    callback: function () {
                        location.hash = "#main-thing";
                    }});

                return false;
            } else if ($('#textarea').hasClass('placeholder')) {
                popupProvider.showOkPopup({message: 'עליך לתת תיאור להצעתך.'});
                return false;
            }
        }

        if (user_logged === false) {
            var $input = $('#user-signup :input'),
                    full_name = $input.eq(0).val_if_not_placeholder(),
                    email = $input.eq(1).val_if_not_placeholder();

            if (!full_name && !email) {
                popupProvider.showOkPopup({message: 'אנא התחבר למערכת או הירשם כדי להצביע.'});
                return false;
            } else if (!full_name) {
                popupProvider.showOkPopup({message: 'יש למלא שם מלא.'});
                return false;
            } else if (!email) {
                popupProvider.showOkPopup({message: 'יש למלא מייל.'});
                return false;
            }


            $.post('/api/register', {full_name: full_name, email: email}, sendVote).fail(function (e) {
                var msg = 'ההרשמה לא הצליחה, אנא בידקו את כתובת המייל שהוזנה';
                if (e.responseText === 'already_exists') {
                    sendVote();
                }
                else {
                    popupProvider.showOkPopup({message: msg});
                }
            });
            return false;
        }
        sendVote();

        return false;
    });

    $("#facebook-connect").on('click', function () {
        facebookLogin(function (error, result) {
            if (!error) {
                if (result.is_new) {
                    user_is_new = 'facebook';
                }
                user_logged = true;
                popupProvider.showOkPopup({message: 'חוברת למערכת בהצלחה.'});
                $('.vote-container-non-reg').addClass('vote-container').removeClass('vote-container-non-reg');
            } else {
                console.error(error);
                popupProvider.showOkPopup({message: 'הנסיון להתחבר באמצעות פייסבוק כשל.'});
            }
        });
        return false;
    });


    $('#user-signup').on('submit', function () {return false;});

    $.fn.val_if_not_placeholder = function () {
        return this.hasClass('placeholder') ? '' : this.val();
    };

});
</script>